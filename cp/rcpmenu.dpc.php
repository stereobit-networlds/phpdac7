<?php

$__DPCSEC['RCPMENU_DPC']='1;1;1;2;2;2;2;2;6;9';

if (!defined("RCPMENU_DPC")) {
define("RCPMENU_DPC",true);

$__DPC['RCPMENU_DPC'] = 'rcpmenu';

require_once(_r('jsdialog/jsdialogStreamSrv.dpc.php'));

$__EVENTS['RCPMENU_DPC'][1]='cpmenu';
$__EVENTS['RCPMENU_DPC'][2]='cpmenu1';
$__EVENTS['RCPMENU_DPC'][3]='cpmenu2';
$__EVENTS['RCPMENU_DPC'][4]='cpajax';

$__ACTIONS['RCPMENU_DPC'][1]='cpmenu';
$__ACTIONS['RCPMENU_DPC'][2]='cpmenu1';
$__ACTIONS['RCPMENU_DPC'][3]='cpmenu2';
$__ACTIONS['RCPMENU_DPC'][4]='cpajax';

$__LOCALE['RCPMENU_DPC'][0]='RCPMENU_CNF;Cp Menu;Cp Menu';	   

$__LOCALE['RCPMENU_DPC'][13]='_awstats;Web statistics;Στατιστικά';
$__LOCALE['RCPMENU_DPC'][14]='_google_analytics;Google Analytics;Στατιστικά Google';
$__LOCALE['RCPMENU_DPC'][15]='_siwapp;Siwapp;Siwapp τιμολόγηση';
$__LOCALE['RCPMENU_DPC'][16]='_MENU1;Size;Μέγεθος';
$__LOCALE['RCPMENU_DPC'][17]='_MENU2;People;Συναλλασόμενοι';
$__LOCALE['RCPMENU_DPC'][18]='_MENU3;Photos & attachments;Φωτογραφίες και έγγραφα';
$__LOCALE['RCPMENU_DPC'][19]='_MENU4;Inventory;Αποθήκη';
$__LOCALE['RCPMENU_DPC'][20]='_MENU5;Synchronize;Συγχρονισμοί';
$__LOCALE['RCPMENU_DPC'][21]='_MENU6;Newsletters;Αποστολές';
$__LOCALE['RCPMENU_DPC'][22]='_MENU7;Orders;Κινήσεις';
$__LOCALE['RCPMENU_DPC'][23]='_add_categories;Upload Categories;Εισαγωγή κατηγοριών';
$__LOCALE['RCPMENU_DPC'][24]='_add_products;Upload Products;Εισαγωγή ειδών';

$__LOCALE['RCPMENU_DPC'][25]='_google_addwords;Google Adwords;Google Adwords';
$__LOCALE['RCPMENU_DPC'][26]='_upload_logo;Upload logo;Αλλαγή λογοτύπου';
$__LOCALE['RCPMENU_DPC'][27]='_add_recaptcha;ReCaptcha;ReCaptcha';
$__LOCALE['RCPMENU_DPC'][28]='_update;Update;Αναβάθμιση';
$__LOCALE['RCPMENU_DPC'][29]='_backup;Backup;Αποθήκευση';
$__LOCALE['RCPMENU_DPC'][30]='_backup_content;Backup contents;Αποθήκευση στοιχείων';
$__LOCALE['RCPMENU_DPC'][31]='_maildbqueue;Newsletters & mailing lists;Μαζικές αποστολές e-mails';
$__LOCALE['RCPMENU_DPC'][32]='_sendnewsletters;Enable newsletter mailing list feature;Ενεργοποίηση μαζικών αποστολών e-mails';
$__LOCALE['RCPMENU_DPC'][33]='_TWEETSRSS;Feeds & tweets;Ενημέρωση';
$__LOCALE['RCPMENU_DPC'][34]='_add_domainname;Domain name;Domain name';
$__LOCALE['RCPMENU_DPC'][35]='_customers;Customers;Πελάτες';
$__LOCALE['RCPMENU_DPC'][36]='_installeshop;Install e-shop;Εγκατάσταση e-shop';
$__LOCALE['RCPMENU_DPC'][37]='_uninstalleshop;Uninstall e-shop;Κατάργηση e-shop';
$__LOCALE['RCPMENU_DPC'][38]='_eshop;e-shop module;e-shop πρόσθετο';
$__LOCALE['RCPMENU_DPC'][39]='_install;Install;Εγκατάσταση';
$__LOCALE['RCPMENU_DPC'][40]='_ckfinder;CKfinder;CKfinder';
$__LOCALE['RCPMENU_DPC'][41]='_jqgrid;JQgrid;JQgrid';
$__LOCALE['RCPMENU_DPC'][42]='_ieditor;IEditor;IEditor';
$__LOCALE['RCPMENU_DPC'][43]='_addons;Addons;Πρόσθετα';
$__LOCALE['RCPMENU_DPC'][44]='_edit_htmlfiles;Edit system files;Επεξεργασία αρχείων συστήματος';
$__LOCALE['RCPMENU_DPC'][45]='_addspace;Limited space, add space;Πρόσθεσε χωρητικότητα';
$__LOCALE['RCPMENU_DPC'][46]='_ago;after expiration;που έληξε';
$__LOCALE['RCPMENU_DPC'][47]='_fromnow;before expire;πρίν τη λήξη';
$__LOCALE['RCPMENU_DPC'][48]='_modified;modified;Ενημερώθηκε';
$__LOCALE['RCPMENU_DPC'][49]='_ago2;ago;πρίν';
$__LOCALE['RCPMENU_DPC'][50]='_fromnow2;from now;μετά';
$__LOCALE['RCPMENU_DPC'][51]='_cpimages;Update icons;Ενημέρωση εικονιδίων';
$__LOCALE['RCPMENU_DPC'][52]='_addkey;Add key;Εισαγωγή κλειδιού';
$__LOCALE['RCPMENU_DPC'][53]='_genkey;Gen key;Δημιουργία κλειδιού';
$__LOCALE['RCPMENU_DPC'][54]='_validatekey;Validate key;Έλεγχος κλειδιού';
$__LOCALE['RCPMENU_DPC'][55]='_desendnewsletters;Uninstall newsletter feature;Απεγκατάσταση μαζικών αποστολών e-mails';
$__LOCALE['RCPMENU_DPC'][56]='_newsletters;Newsletter feature installed;Αποστολή e-mails εγκατεστημένο';
$__LOCALE['RCPMENU_DPC'][57]='_year;Year;Έτος';
$__LOCALE['RCPMENU_DPC'][58]='_month;Month;Μήνας';
$__LOCALE['RCPMENU_DPC'][59]='_more;More...;Περισσότερα...';

$__LOCALE['RCPMENU_DPC'][60]='_exit;Exit;Έξοδος';
$__LOCALE['RCPMENU_DPC'][61]='_dashboard;Dashboard;Πίνακας ελέγχου';
$__LOCALE['RCPMENU_DPC'][62]='_logout;Logout;Αποσύνδεση';
$__LOCALE['RCPMENU_DPC'][63]='_rssfeeds;RSS Feeds;RSS Feeds';
$__LOCALE['RCPMENU_DPC'][64]='_edititemtext;Edit Item Text;Μεταβολή κειμένου';// (text) αντικειμένου';
$__LOCALE['RCPMENU_DPC'][65]='_deleteitemattachment;Delete Item Attachment;Διαγραφή συνημμένου';// είδους';
$__LOCALE['RCPMENU_DPC'][66]='_editcat;Edit Category;Μεταβολή κατηγορίας';
$__LOCALE['RCPMENU_DPC'][67]='_addcat;Add Category;Νέα Κατηγορία';
$__LOCALE['RCPMENU_DPC'][68]='_additem;Add Item;Νέο Είδος';
$__LOCALE['RCPMENU_DPC'][69]='_webstatistics;Statistics;Στατιστικά';
$__LOCALE['RCPMENU_DPC'][70]='_addcathtml;Add Category Html;Προσθήκη κειμένου';// κατηγορίας';
$__LOCALE['RCPMENU_DPC'][71]='_editcathtml;Edit Category Html;Μεταβολή κειμένου';// κατηγορίας';
$__LOCALE['RCPMENU_DPC'][72]='_edititem;Edit Item;Μεταβολή';// αντικειμένου';
$__LOCALE['RCPMENU_DPC'][73]='_edititemphoto;Edit Photo;Φωτογραφία';// αντικειμένου';
$__LOCALE['RCPMENU_DPC'][74]='_edititemdbhtm;Text;Κείμενο';// (htm) αντικειμένου (db)';
$__LOCALE['RCPMENU_DPC'][75]='_edititemdbhtml;Text;Κείμενο';// (html) αντικειμένου (db)';
$__LOCALE['RCPMENU_DPC'][76]='_edititemdbtext;Text;Κείμενο';// (text) αντικειμένου (db)';
$__LOCALE['RCPMENU_DPC'][77]='_senditemmail;Send e-mail;Αποστολή e-mail';
$__LOCALE['RCPMENU_DPC'][78]='_delitemattachment;Delete Text;Διαγραφή κειμένου';// (db)';
$__LOCALE['RCPMENU_DPC'][79]='_edititemtext;Edit Item Text;Κείμενο';// (text) αντικειμένου';
$__LOCALE['RCPMENU_DPC'][80]='_edititemhtm;Edit Item Htm;Κείμενο';// (htm) αντικειμένου';
$__LOCALE['RCPMENU_DPC'][81]='_edititemhtml;Edit Item Html;Κείμενο';// (html) αντικειμένου';
$__LOCALE['RCPMENU_DPC'][82]='_additemhtml;Add Item Html;Νέο Κείμενο';// στο αντικείμενο';
$__LOCALE['RCPMENU_DPC'][83]='_transactions;Transactions;Συναλλαγές';
$__LOCALE['RCPMENU_DPC'][84]='_users;Users;Χρήστες';
$__LOCALE['RCPMENU_DPC'][85]='_itemattachments2db;Attach to DB;Μεταφορά κειμένων σε Β.Δ.';//βάση δεδομένων';
$__LOCALE['RCPMENU_DPC'][86]='_importdb;Import Database;Εισαγωγή β.δ.';
$__LOCALE['RCPMENU_DPC'][87]='_config;Configuration;Ρυθμίσεις';
$__LOCALE['RCPMENU_DPC'][88]='_contactform;Contact Form;Επαφές';
$__LOCALE['RCPMENU_DPC'][89]='_subscribers;Subscribers;Συνδρομητές';
$__LOCALE['RCPMENU_DPC'][90]='_sitemap;Sitemap;Χάρτης πλοήγησης';// αντικειμένων';
$__LOCALE['RCPMENU_DPC'][91]='_search;Search;Φόρμα Αναζήτησης';
$__LOCALE['RCPMENU_DPC'][92]='_upload;Upload files;Μεταφόρτωση';
$__LOCALE['RCPMENU_DPC'][93]='_uploadid;Upload item files;Μεταφόρτωση';// αντικειμένου';
$__LOCALE['RCPMENU_DPC'][94]='_uploadcat;Upload category files;Μεταφόρτωση';// κατηγορίας';
$__LOCALE['RCPMENU_DPC'][95]='_syncphoto;Sync photos;Συγχρονισμός φωτογραφιών';
$__LOCALE['RCPMENU_DPC'][96]='_syncsql;Sync data;Συγχρονισμός δεδομένων';
$__LOCALE['RCPMENU_DPC'][97]='_dbphoto;Image in DB;Εικόνα στην β.δ.';
$__LOCALE['RCPMENU_DPC'][98]='_editctag;Tags;Tags';
$__LOCALE['RCPMENU_DPC'][99]='_edititag;Tags;Tags';
$__LOCALE['RCPMENU_DPC'][100]='_menu;Menu settings;Ρυθμίσεις menu';
$__LOCALE['RCPMENU_DPC'][101]='_slideshow;Slideshow;Slideshow';
$__LOCALE['RCPMENU_DPC'][102]='_ckfinder;CKFinder;CKFinder';
$__LOCALE['RCPMENU_DPC'][103]='_webmail;Web Mail;Web Mail';
$__LOCALE['RCPMENU_DPC'][104]='_editpage;Edit Page;Επεξεργασία σελίδας';
$__LOCALE['RCPMENU_DPC'][105]='_rempass;Forgotten password;Υπενθύμιση κωδικού';
$__LOCALE['RCPMENU_DPC'][106]='_chpass;Change password;Αλλαγή κωδικού';
$__LOCALE['RCPMENU_DPC'][107]='_cphelp;Ηelp;Βοήθεια';
$__LOCALE['RCPMENU_DPC'][108]='_cpupgrade;Upgrade;Αναβάθμιση';
$__LOCALE['RCPMENU_DPC'][109]='_cpwizard;Enable wizard;Οδηγός εγκατάστασης';
$__LOCALE['RCPMENU_DPC'][110]='_cpdhtmlon;Windows mode;Πλοήγηση Windows';
$__LOCALE['RCPMENU_DPC'][111]='_cpdhtmloff;Frames mode;Πλοήγηση Frames';
$__LOCALE['RCPMENU_DPC'][112]='_cpcropwiz;Crop wizard;Crop wizard';
$__LOCALE['RCPMENU_DPC'][113]='_OPTIONS;Options;Επιλογές';
$__LOCALE['RCPMENU_DPC'][114]='_ADD;Add;Προσθήκη';
$__LOCALE['RCPMENU_DPC'][115]='_CATEGORY;Category;Κατηγορία';
$__LOCALE['RCPMENU_DPC'][116]='_ITEM;Item;Είδος';
$__LOCALE['RCPMENU_DPC'][117]='_SETTINGS;Settings;Ρυθμίσεις';
$__LOCALE['RCPMENU_DPC'][118]='_customers;Customers;Πελάτες';
$__LOCALE['RCPMENU_DPC'][119]='_EDITHTML;Edit Html;Σελίδες Html';
$__LOCALE['RCPMENU_DPC'][120]='_SELECTHTML;Select Html;Επιλογή Html';
$__LOCALE['RCPMENU_DPC'][121]='_ADDFAST;Add item;Εισαγωγή είδους';
$__LOCALE['RCPMENU_DPC'][122]='_addtag;Add Tag;Εισαγωγή Ετικέτας';
$__LOCALE['RCPMENU_DPC'][123]='_back;Back;Επιστροφή';
$__LOCALE['RCPMENU_DPC'][124]='_mailqueue;Mail queue;Αποστολές';
$__LOCALE['RCPMENU_DPC'][125]='_ENTITIES;Entities;Στοιχεία';
$__LOCALE['RCPMENU_DPC'][126]='_categories;Sections;Κατηγορίες';
$__LOCALE['RCPMENU_DPC'][127]='_items;Items;Αντικείμενα';
$__LOCALE['RCPMENU_DPC'][128]='_configmenu;Config menu;Ρυθμίσεις menu';
$__LOCALE['RCPMENU_DPC'][129]='_xmlfeeds;XML feeds;XML feeds';
$__LOCALE['RCPMENU_DPC'][130]='_dynsql;SQL Syncs;Συγχρονισμοί';
$__LOCALE['RCPMENU_DPC'][131]='_bmailqueue;Responds;Απαντήσεις';
$__LOCALE['RCPMENU_DPC'][132]='_bmailqueueadd;Subscribers;Λίστες';
$__LOCALE['RCPMENU_DPC'][133]='_bmailsend;Send;Αποστολή';
$__LOCALE['RCPMENU_DPC'][134]='_bmail;e-Mail;e-Mail';
$__LOCALE['RCPMENU_DPC'][135]='_bmailstats;Statistics;Στατιστική';
$__LOCALE['RCPMENU_DPC'][136]='_bmailcamp;Campaigns;Καμπάνιες';
$__LOCALE['RCPMENU_DPC'][137]='_ITEMCOLLECTION;Collect;Συλλογή';
$__LOCALE['RCPMENU_DPC'][138]='_myprofile;My profile;Οι ρυθμίσεις μου';
$__LOCALE['RCPMENU_DPC'][139]='_allnotifications;See all notifications;Όλα τα μηνύματα';
$__LOCALE['RCPMENU_DPC'][140]='_allmessages;See all messages;Όλες τα μηνύματα ';
$__LOCALE['RCPMENU_DPC'][141]='_alltasks;See all notifications;Όλες οι εργασίες';
$__LOCALE['RCPMENU_DPC'][142]='_youhave;You have;Υπάρχουν';
$__LOCALE['RCPMENU_DPC'][143]='_newnotifications;new notifications;μηνύματα';
$__LOCALE['RCPMENU_DPC'][144]='_pendingtasks;pending tasks;εργασίες';
$__LOCALE['RCPMENU_DPC'][145]='_itemrelation;Relationships;Σύνδεσμοι';
$__LOCALE['RCPMENU_DPC'][146]='_itemrel;Relations;Συσχετισμοί';
$__LOCALE['RCPMENU_DPC'][147]='_bmailcreate;Build;Κατασκευή';
$__LOCALE['RCPMENU_DPC'][148]='_COLLECT;Collect;Επιλογή';
$__LOCALE['RCPMENU_DPC'][149]='_help;Help;Βοήθεια';
$__LOCALE['RCPMENU_DPC'][150]='_tour;Guided tour;Βοήθεια';
$__LOCALE['RCPMENU_DPC'][151]='_analyze;Analyse;Ανάλυση';
$__LOCALE['RCPMENU_DPC'][152]='_sync;Synchronize;Συγχρονισμός';
$__LOCALE['RCPMENU_DPC'][153]='_fscanner;Scanner;Scanner';
$__LOCALE['RCPMENU_DPC'][154]='_cron;Cron;Cron';
$__LOCALE['RCPMENU_DPC'][155]='_replication;Replication;Replication';
$__LOCALE['RCPMENU_DPC'][156]='_backup;Backup;Backup';
$__LOCALE['RCPMENU_DPC'][157]='_blacklist;IP Blacklist;Εξαιρέσεις IP';
$__LOCALE['RCPMENU_DPC'][158]='_crm;Crm;Crm';
$__LOCALE['RCPMENU_DPC'][159]='_crmplus;Plus;Plus';
$__LOCALE['RCPMENU_DPC'][160]='_crmforms;Forms;Φόρμες';
$__LOCALE['RCPMENU_DPC'][161]='_itemqpolicy;Qty policy;Ποσοτικές εκπτώσεις';
$__LOCALE['RCPMENU_DPC'][162]='_crmtrace;Contacts;Επαφές';
$__LOCALE['RCPMENU_DPC'][163]='_crmoffers;Offers;Προσφορές';
$__LOCALE['RCPMENU_DPC'][164]='_outoflist;out of list;εξήχθει απο';
	   
class rcpmenu {

	var $path, $urlpath, $inpath, $menufile;
	var $delimiter, $dropdown_class, $dropdown_class2;  
	var $seclevid, $turl, $cpGet, $turldecoded;
	
	private $log, $updateTime, $maxSizeToLoad;
	private $logpath, $filepath;
	static $staticprpath;
	
	public function __construct() {
	   
        $this->path = paramload('SHELL','prpath');	   
	   
	    $this->urlpath = paramload('SHELL','urlpath');
	    $this->inpath = paramload('ID','hostinpath');	
		
		self::$staticprpath = paramload('SHELL','prpath');
	  
        $this->menufile = $this->path . 'menucp.ini';
	    $this->delimiter = ',';
	    
		$this->updateTime = 2000;
        $this->maxSizeToLoad = 2097152;		
        //$this->log = array();
        $this->logpath = '/var/stereobit/phpdac7/';
        $this->filepath = '/var/stereobit/phpdac7/www7/cp/html'; //no / at end
        $this->log = json_decode($this->getEngineTailsList(20, null,null,1), true);	       

        $this->dropdown_class = remote_paramload('RCPMENU','dropdownclass',$this->path);	   
	    $this->dropdown_class2 = remote_paramload('RCPMENU','dropdownclass2',$this->path); 

	    //$this->seclevid = $GLOBALS['ADMINSecID'] ? $GLOBALS['ADMINSecID'] : $_SESSION['ADMINSecID'];		
			   
        $this->getTURL();	

        //$this->jAjaxRead(); //set js	//moved inside html		
    }
   

    public function event($event=null) {
        
		switch ($event) {
			
		    case 'cpajax'        : //echo $this->jAjax($_GET['file'], $_GET['lastsize'], $_GET['grep'], $_GET['invert']);
								   //die(); //CCPP MEMORY ERR !!
							       break;			

			case 'cpmenu'        :	
			default              : 				
		}
	}
   

	public function action($action=null) {

		switch ($action) {
			
		    case 'cpajax'        : echo $this->jAjax($_GET['file'], $_GET['lastsize'], $_GET['grep'], $_GET['invert']);
								   die();
							       break;	

			case 'cpmenu'        :						
			default              : 
		}
	   
		return ($out);
	}
   
    protected function getTURL() {
		$postedTURL = $_POST['turl'] ? $_POST['turl'] : $_GET['turl'];
	   
	    if ($postedTURL) {//a post from login screen
			$this->turl = $postedTURL;
			$this->turldecoded = str_replace('_&_', '_%26_', base64_decode($postedTURL));
			$urlquery = parse_url($this->turldecoded); 
			parse_str($urlquery['query'], $getp); 	
			$this->cpGet = $getp;
			
			SetSessionParam('turl', $postedTURL);
			SetSessionParam('turldecoded', $this->turldecoded);		
			SetSessionParam('cpGet', base64_encode(serialize($this->cpGet)));
	    }		   
	    elseif ($turl = $_SESSION['turl']) { //GetSessionParam('turl')) {
			$this->turl = $turl;
			$this->turldecoded = GetSessionParam('turldecoded');
			$this->cpGet = unserialize(base64_decode($_SESSION['cpGet']));
	    }   
	   
	    return ($this->turldecoded);
	}  

	protected function getPageName() {
		$pn = explode('/',$this->url);
		$pname = array_pop($pn);
		$pnurl = stristr($pname,'?') ? explode('?',$pname) : array('0'=>$pname);
		$pagename = $pnurl[0];
		
		return ($pagename);
	}
   
	public function exiturl() {
	   return ('../' . $this->getTURL());//$this->turl);
	}
	
	protected function parse_config() {
	    $conf = $this->path . "myconfig.txt.php";
		include($conf);
		$cnf = parse_ini_string($myconf,1, INI_SCANNER_RAW);
		
		foreach ($cnf as $s=>$section) {
			foreach ($section as $var=>$val)
				$ret[$s.'-'.$var] = $val;
		}

		return ($ret);		
	}
   
	public function parse_environment($save_session=false) {	   
		$this->seclevid = $_SESSION['ADMINSecID'] ? $_SESSION['ADMINSecID'] : $GLOBALS['ADMINSecID'];
		$sl = ($this->seclevid>1) ? intval($this->seclevid)-1 : 1;
		//echo 'ADMINSecID:'.$GLOBALS['ADMINSecID'].':'.$sl.':'.$this->seclevid;

		$ini = @parse_ini_file($this->path . "cp.ini");
		if (!$ini) die('cp.ini missing!');	
	
		foreach ($ini as $env=>$val) {
			if (stristr($val,',')) {
				$uenv = explode(',',$val);
				$ret[$env] = $uenv[$sl];  
			}
			else
				$ret[$env] = $val;
		}

		if (($save_session) && (!$_SESSION['env'])) 
			SetSessionParam('env', $ret); 		
	
		return ($ret);
	}

	//for each user up to current, set security on	
	protected function parse_userSecurity() {
        $ret = array();
		//for($usrsec=$this->seclevid; $usrsec<=9; $usrsec++)
			//$ret['USER'.$usrsec] = 1;
		
		$ret['USER'] = $this->seclevid;
		$ret['USER'.$this->seclevid] = 1;
		//print_r($ret);
		return ($ret);
	}
   
	protected function readINI($inifile=null) {
		$m = null;	

        if (defined('CCPP_VERSION')) { //override, customized per line
			$cat = $this->cpGet['cat'] ? array('ON'=>1,'OFF'=>null) : array('ON'=>null,'OFF'=>1);
			$id = $this->cpGet['id'] ? array('ON'=>1,'OFF'=>null) : array('ON'=>null,'OFF'=>1);  		
			$config = array('CAT'=>$cat, 
							'ID'=>$id, 
							'SEC'=>$this->parse_environment(),
							'CNF'=>$this->parse_config(),
							'ADMIN'=>$this->parse_userSecurity(),
							);
			//print_r($config);
			
			//custom ini file or standart ini file
			//if (($inifile) && ($sini = @file_get_contents($this->path . $inifile))) {
			if (($inifile) && ($sini = self::streamfile_contents($this->path . $inifile))) {	
				$preprocessor = new CCPP($config, true); //new ccpp
				$rawini = $preprocessor->execute($sini, 0, true, true);
				unset($preprocessor);
				//echo $rawini;
				$m = parse_ini_string($rawini,1,INI_SCANNER_RAW);
				return ($m);
			}
			elseif ($sini = trim(self::streamfile_contents($this->menufile))) {
				//echo $sini;
			    
				$preprocessor = new CCPP($config, true); //new ccpp
				$rawini = $preprocessor->execute($sini, 0, true, true);
				unset($preprocessor);
				//echo $rawini;
				$m = parse_ini_string($rawini,1,INI_SCANNER_RAW);
				return ($m);	
			}
		}
        else {
			//custom ini file or standart ini file
			//if (($inifile) && ($sini = @file_get_contents($this->path . $inifile))) {
			if (($inifile) && ($sini = streamfile_contents($this->path . $inifile))) {	
				$m = parse_ini_string($sini,1,INI_SCANNER_RAW);
				return ($m);
			}
			elseif ($sini = trim(self::streamfile_contents($this->menufile))) {
				$m = parse_ini_string($sini,1,INI_SCANNER_RAW);
				return ($m);
			}
		}
		
		return false;	
	}
	
	//fetch stream menucp content
	static protected function streamfile_contents($f=null, $falt=null) {
		if (!$f) return null;
		global $dac, $st;
		//echo $dac, ':', $st, '-------------------------------------' . PHP_EOL;
		if ($dac) { 
			$fp = str_replace(self::$staticprpath, '/cp/', $f);
			//phpdac7\__log('fetch remote:' . $fp); //dac7 not comaptible
			//echo "$st/www7" . $fp . PHP_EOL;
			return @file_get_contents("$st/www7" . $fp);	
		}
		
		//else filesystem default
		$fout = $falt ? $falt : $f;
		return @file_get_contents($fout);
	}	
   			

	public function render($menu_template=null,$glue_tag=null,$submenu_template=null, $linkclass=null, $inifile=null) {
        $lan = getlocal() ? getlocal() : '0';
		$this->seclevid = $_SESSION['ADMINSecID'] ? $_SESSION['ADMINSecID'] : $GLOBALS['ADMINSecID'];
		$sl = ($this->seclevid>1) ? intval($this->seclevid)-1 : 1;		
		$lnclass = $linkclass ? "class='{$linkclass}' " : null; //new menu ajax call feature
		//$lnclass = "class='cplink' "; //TEST!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
	  
	    $m = $this->readINI($inifile);
		if (!$m) return false;
		  
		//print_r($m);
		foreach ($m as $menu_item) {
				
			if (isset($menu_item['title'])) { 		
		  
				$title = explode($this->delimiter ,$menu_item['title']);
				$link = explode($this->delimiter ,$menu_item['link']); 		  
		  
				//SECURITY
				if (stristr($menu_item['spaces'],',')) {
					$uenv = explode(',',$menu_item['spaces']);
					$allow = $uenv[$sl];  
				}
				else
					$allow = $menu_item['spaces'];

				if ($allow) {
					$submenu = explode($this->delimiter ,$menu_item['submenu']); 
					if ($smenu = $submenu[$lan]) 
						$smu[$title[$lan].'-submenu'] = $smenu;
					else	
						$smu[$title[$lan].'-submenu'] = null;
		
					$t = localize($title[$lan], $lan);
					$menu[$t] = $link[$lan];
				}	
			}
		}
		
		if (!empty($menu)) {

			$tmpl = $menu_template ? _m("cmsrt.select_template use $menu_template+1") : null;

            foreach ($menu as $name=>$url) {
				
			    $tokens = array(); 
			    $murl = $url ? $this->make_link($url) : '#'; //.$name;
				$name_space = $name;  	
                    
                if ($sub_menu = $smu[$name.'-submenu']) {
					
					$_smenu = (array) $m[$sub_menu];
					$ret2 = $this->render_submenu($_smenu, $submenu_template, $glue_tag, $lnclass);
					$tokens[] = $this->dropdown_class;
					   
					if ($tmpl) {
						$tokens[] = $murl;
						$tokens[] = $name;
						$tokens[] = $ret2;
						$ret .= $this->combine_tokens($tmpl,$tokens,true);
					}
					else {
						$line = "<a {$lnclass}href='$murl'>$name</a>";
						$ret .= $gstart . $line . $gend;							
					}
                } 					
				else {
					if ($tmpl) {
						$tokens[] = ''; 
						$tokens[] = $murl;
						$tokens[] = $name;
						$tokens[] = ''; 
						$ret .= $this->combine_tokens($tmpl, $tokens, true);
					}
					else {
						$line = "<a {$lnclass}href='$murl'>$name</a>";
						$ret .= $gstart . $line . $gend;
					}							
				}   
			}	
		    return ($ret);
		}
	}
   
	protected function render_submenu($smenu=null,$template=null,$glue_tag=null, $lnclass=null) { 
        $lan = getlocal() ? getlocal() : '0';
		$sl = ($this->seclevid>1) ? intval($this->seclevid)-1 : 1;		
        if (empty($smenu)) return;
		 	 
		$allow = 1; //start				 
		foreach ($smenu as $m=>$v) {
		    $cv = explode($this->delimiter ,$v);
	
			if (strstr($m,'spaces')) 
			   $allow = $cv[$sl];			
		    elseif ((strstr($m,'title')) && ($allow))
			   $subm_titles[] = localize($cv[$lan], $lan);
			elseif ((strstr($m,'link')) && ($allow))
			   $subm_links[] = $this->make_link($cv[$lan]);
		}		   
	
		$gstart = $glue_tag ? '<'.$glue_tag.'>' : null;
		$gend = $glue_tag ? '</'.$glue_tag.'>' : null;

		if ($template) {
			$tmpl = _m("cmsrt.select_template use $template+1");
			foreach ($subm_titles as $t=>$title) {
				$tokens = array();
				$tokens[] = $subm_links[$t];
				$tokens[] = $title;
				$out .= $this->combine_tokens($tmpl,$tokens,true);
			}	
		}
		else {		
			foreach ($subm_titles as $t=>$title) {
				$line = "<a {$lnclass}href='$subm_links[$t]'>$title</a>";
				$out .= $gstart . $line . $gend;
			}
		}		
	 
	    return ($out);
    }
	
	//transform links for special chars
	private function make_link($link=null) {
		$cat = $this->cpGet['cat']; 
		$id = $this->cpGet['id']; 
		$csep = _m('cmsrt.sep');
	    $mycurrentcat = explode($csep,$cat);
	    $selected_cat = array_pop($mycurrentcat);		

		//_SCAT ->$selected_cat (last branch) 
	    //_CAT -> $cat
		//_ID -> $id
	    //| -> ? special char
	    //@ -> ?t= special char
	    //, -> ^  comma is language separator
	    //www. -> http://www. (CCPP takes // as remark)
	
	    $h = (isset($_SERVER['HTTPS'])) ? 'https://' : 'http://';
		$ret = str_replace(array('@','^','www.','|','_CAT','_ID','_SCAT'),
		                   array('?t=',$csep,$h.'www.','?',$cat, $id, $selected_cat),$link);
		/*				   	
		$sslMenu = _m('cmsrt.paramload use CMS+ssl');					
		//$httpurl = _v('cms.httpurl');
		$httpurl = (isset($_SERVER['HTTPS'])) ? 'https://' : 'http://';
		$httpurl.= (strstr($_SERVER['HTTP_HOST'], 'www')) ? $_SERVER['HTTP_HOST'] : 'www.' . $_SERVER['HTTP_HOST'];		
		//if no ssl param then use standard protocol (https jqgid licence)
		$sslMenu ? $httpurl .'/cp/' : 'http://' . $_SERVER['HTTP_HOST'] .'/cp/';
		*/
		$sslurl = null;
		
		return ($sslurl . $ret);
	}
	
	public function showCategoryTitles($mycat=null, $sep='|') {
		$cat = $mycat ? $mycat : $this->cpGet['cat'];		
		$csep = _m('cmsrt.sep');
		if (empty($cat)) return null;
		//echo 'cpCat'.md5($cat);	
		
		//if (!$rcat = GetSessionParam('cpCat'.md5($cat))) {			
		
			$_cat = null;
			$_cc = $this->getKategories($cat);
			//echo $_cc;//, $cat; 
			$cats = explode($csep, $_cc);
			//print_r($cats);
			foreach ($cats as $i=>$c)
				$_cat[] = $c;
		
			$ret = implode($sep, $_cat);
			//SetSessionParam('cpCat'. md5($mycat), $ret);
			return $ret;
		//}
		//else
		//return $rcat;		
	}
	
	//fetch category titles
    protected function getkategories($cat=null) {
		$db = GetGlobal('db');
		$lan = getlocal();
		$f = $lan ? $lan : '0';
		$cc =null;
		$rec = null;
		
		$csep = _m('cmsrt.sep');
		$depthview = remote_paramload('SHKATEGORIES','depthview',$this->prpath);
		
		$cc = explode($csep, $cat);
		foreach ($cc as $n=>$fname)
			if ($fname) $rec['cat'. strval($n)] = $fname;		
	   
		$sSQL = "select distinct cat2,cat{$f}2,cat3,cat{$f}3,cat4,cat{$f}4,cat5,cat{$f}5 from categories where ";

		if (($rec['cat0']) && ($depthview>=1)) $sSQL .= "cat2='". _m("cmsrt.replace_spchars use " . $rec['cat0'] . '+1')."'"; 
		if (($rec['cat1']) && ($depthview>=2)) $sSQL .= " and cat3='". _m("cmsrt.replace_spchars use " . $rec['cat1'] . '+1')."'"; 
		if (($rec['cat2']) && ($depthview>=3)) $sSQL .= " and cat4='". _m("cmsrt.replace_spchars use " . $rec['cat2'] . '+1')."'"; 
		if (($rec['cat3']) && ($depthview>=4)) $sSQL .= " and cat5='". _m("cmsrt.replace_spchars use " . $rec['cat3'] . '+1')."'"; 			  			  			  

	    $result = $db->Execute($sSQL,2);	
	  	//echo $sSQL;				
		$_cat0 = $result->fields["cat{$f}2"] ?? _m("cmsrt.replace_spchars use " . $rec['cat0']);
		$_cat1 = $result->fields["cat{$f}3"] ?? _m("cmsrt.replace_spchars use " . $rec['cat1']);
		$_cat2 = $result->fields["cat{$f}4"] ?? _m("cmsrt.replace_spchars use " . $rec['cat2']);
		$_cat3 = $result->fields["cat{$f}5"] ?? _m("cmsrt.replace_spchars use " . $rec['cat3']);
		//$_cat4 = $result->fields["cat{$f}6"] ?? _m("cmsrt.replace_spchars use " . $rec['cat4']);
						
        if (($rec['cat0']) && ($depthview>=1)) {
                $ck[0] = $_cat0;
		}  	
				 	
        if (($rec['cat1']) && ($depthview>=2)) {				   
                $ck[1] = $_cat1;
		}		

        if (($rec['cat2']) && ($depthview>=3)) {					 
                $ck[2] = $_cat2;
		}		  
 
        if (($rec['cat3']) && ($depthview>=4)) {			 
                $ck[3] = $_cat3;
		}
		/*	
		if (($rec['cat4']) && ($depthview>=5)) {			 
                $ck[4] = $_cat4;
		}*/
				  	  	
        if (!empty($ck))
            $cat = implode($csep,$ck);
		
        unset($ck); //reset ck

        return ($cat);
    }	

	protected function combine_tokens($template_contents,$tokens, $execafter=null) {
	
	    if (!is_array($tokens)) return;
		
		if ((!$execafter) && (defined('FRONTHTMLPAGE_DPC'))) {
			$fp = new fronthtmlpage(null);
			$ret = $fp->process_commands($template_contents);
			unset ($fp);		  		
		}		  		
		else
			$ret = $template_contents;
		  
	    foreach ($tokens as $i=>$tok) 
		    $ret = str_replace("$".$i."$",$tok,$ret);

		//clean unused token marks
		for ($x=$i;$x<20;$x++)
			$ret = str_replace("$".$x."$",'',$ret);
		
		//execute after replace tokens
		if (($execafter) && (defined('FRONTHTMLPAGE_DPC'))) {
			$fp = new fronthtmlpage(null);
			$retout = $fp->process_commands($ret);
			unset ($fp);
          
			return ($retout);
		}		
		
		return ($ret);
	} 

	/*stream dialog for srv called by js */ 
	/*universal stream dialog loader, to not load dpc into every php cp page */
	public function streamDialog() {
		
		$sd = new jsdialogStreamSrv();
		$ret= $sd->streamDialog();
		
		return ($ret);
	}
	
	//read array of phpdac7 engine screrenlog.n files to read
	public function getEngineTailsList($tmax=null, $template=null, $tpath=null, $json=false) {
		$dac7 = _m('cmsrt.isDacRunning');
		if ($dac7==false) return false;
		
		$max = $tmax ?? 10;
		$path = $tpath ? $tpath : $this->logpath;
		if (!is_dir($path)) return false;
		
		$t = $template ? $template : '<li><a class="cpfile" href="#$0$">$0$</a></li>';
		$screenarray = array();
		$tokens = array();
		
		for ($i=0;$i<$max;$i++) {
			$sf = $path . "screenlog." . strval($i);
			if (is_readable($sf)) {
				$index = 'Worker-' . strval($i);
				$screenarray[$index] = $sf;
				$tokens[] = $index; 
				$ret .= str_replace('$0$', $index, $t);//"<li><a class='cpfile' href='#$index'>$index</a></li>"); 
			}	
			//echo '>'.$sf;
		}
		
		//test
		/*$screenarray = array(
					'html-1'=>'/var/www/html/cp/admin/bootstrap-ajax-dashboard.html',
					'html-2'=>'/var/www/html/cp/admin/bootstrap-theme-ajax-fetch.html',
					'html-3'=>'/var/www/html/cp/admin/bootstrap-ajax-json.html'
						);	
		foreach ($screenarray as $i=>$s)
			$ret .= "<li><a class='cpfile' href='#$i'>$i</a></li>";
		*/
		//echo '----' . $ret;
		if (!empty($screenarray))
			return $json ?  json_encode($screenarray) : $ret;
							//$this->combine_tokens($t, $tokens, true);
							
		return false;					
	}	
	
    /**
     * This function is in charge of retrieving the latest lines from the log file
     * @param string $lastFetchedSize The size of the file when we lasted tailed it.
     * @param string $grepKeyword The grep keyword. This will only return rows that contain this word
     * @return Returns the JSON representation of the latest file size and appended lines.
     */
    public function getNewLines($file, $lastFetchedSize=0, $grepKeyword='', $invert=0) {
		
		//log file called directly and its path starting with /somepath/file.html 
		if (strstr($file, '/')) {
			//echo $this->filepath . $file , '>>>>';
			
			//parse file as url to get / sep params after ?
			$url = 'http://localhost:80' . $file;
			$purl = parse_url($url);		
			$_file = $purl['path']; 
			if (strpos($purl['query'], '/')) parse_str(str_replace('/','&',$purl['query']), $_REQUEST);
			else parse_str($purl['query'], $_REQUEST); 
			
			//process async ..
			//$my_async_data = phpdac\getT('/pparse'. $this->filepath . $_file)); 
			//$data[] = $my_async_data; 
			
			//process sync
			$t = new ktimer;
			
			//1st step: read html file
			$t->start('compile');
			/*if (!$my_sync_data = file_get_contents($this->filepath . $_file)) {
				$t->stop('compile');
				return null;
			}*/	
			$my_sync_data = @file_get_contents($this->filepath . $_file);	
			//echo $my_sync_data;		
	  
			//2nd step: compile its phpdac tags based on samename.php file or default script
			$t->start('compile',1);	
			$standartscript = <<<EOF
\$subpage = new pcntl('
super javascript;
load_extension adodb refby _ADODB_; 
super database;
use i18n.i18n;
public cms.cmsrt;
public bshop.rckategories;
public cms.rcmenu;
public cp.rccontrolpanel;
public i18n.i18nL;

',1);
EOF;
			$evalret = null;
			if ($script = @file_get_contents($this->filepath . str_replace('.html','.php', $_file)))
				$evalret = eval($script); //remove php tag	
			else
				$evalret = eval($standartscript); 
			//include($this->filepath . str_replace('/metro2','/metro2/scripts', $_file));
		    $t->stop('compile');
			//echo "<!-- compile " . $t->value('compile') . ' sec -->';  
			
			//3nd step: replace/preg its phpdac tags based on script
			$t->start('include');
			if ($my_sync_data) { 
				//html data has readed and exists
				$pattern = "@<phpdac.*?>(.*?)</phpdac>@s";				
				preg_match_all($pattern, $my_sync_data , $matches, PREG_PATTERN_ORDER);

				foreach ($matches[1] as $r=>$cmd) {
					$_cmd = trim(preg_replace('/\s\s+/', ' ', str_replace("\n", "", $cmd)));
					//$ret = _m($_cmd); //,1); //no error stop 					 
					$my_sync_data = str_replace("<phpdac>".$cmd."</phpdac>", _m($_cmd), $my_sync_data);
					//echo $_cmd .'<br>';
				}
				//final replace main output INDEX tag
				$my_sync_data = str_replace('<!--INDEX-->', $evalret, $my_sync_data);
			}
			else {
				//if html data does not exist return script output as is
				$my_sync_data = $evalret;
			}
			$t->stop('include');
			//echo "<!-- include " . $t->value('include') . ' sec -->'; 			
			
			//if debug
			//$my_sync_data .= var_export($purl, true) .'<br/>'. $_file .'<br/>'. var_export($_REQUEST, true) .'<br/>';
			//$my_sync_data .= '<button onclick="goBack()">Go Back</button>';
			
			//make output array element
			$data[] = $my_sync_data; 
			return json_encode(array("size" => $fsize, "file" => $_file, "data" => $data));		
		}		
		//************************************
		//else fetch new lines from log files
		
        /**
         * Clear the stat cache to get the latest results
         */
        clearstatcache();
        /**
         * Define how much we should load from the log file
         * @var
         */
        if(empty($file)) {
            $file = key(array_slice($this->log, 0, 1, true));
        }
        $fsize = filesize($this->log[$file]);
        $maxLength = ($fsize - intval($lastFetchedSize));
		//echo $fsize,'--', $maxLength;
		
        /**
         * Verify that we don't load more data then allowed.
         */
        if($maxLength > $this->maxSizeToLoad) {
            $maxLength = ($this->maxSizeToLoad / 2);
        }
        /**
         * Actually load the data
         */
        $data = array();
        if($maxLength > 0) {

            $fp = fopen($this->log[$file], 'r');
            fseek($fp, -$maxLength , SEEK_END);
            $data = explode("\n", fread($fp, $maxLength));

        }
		//* ***************************** byme, remove ansi colors ////// */
		$data = preg_replace('#\\x1b[[][^A-Za-z]*[A-Za-z]#', '', $data); 
		
        /**
         * Run the grep function to return only the lines we're interested in.
         */
        if($invert == 0) {
            $data = preg_grep("/$grepKeyword/",$data);
        }
        else {
            $data = preg_grep("/$grepKeyword/",$data, PREG_GREP_INVERT);
        }
        /**
         * If the last entry in the array is an empty string lets remove it.
         */
        if(end($data) == "") {
            array_pop($data);
        }
		
		//$data = file($this->log[$file]);
        return json_encode(array("size" => $fsize, "file" => $this->log[$file], "data" => $data));
    }


    //event this run version (no 2nd step, use this dac7.php script)
    public function jAjax($file, $lastFetchedSize=0, $grepKeyword='', $invert=0) {
		
		//log file called directly and its path starting with /somepath/file.html 
		if (strstr($file, '/')) {
			//echo $this->filepath . $file , '>>>>';
			
			//parse file as url to get / sep params after ?
			$url = 'http://localhost:80' . $file;
			$purl = parse_url($url);		
			$_file = $purl['path']; 
			if (strpos($purl['query'], '/')) parse_str(str_replace('/','&',$purl['query']), $_REQUEST);
			else parse_str($purl['query'], $_REQUEST); 
			
			//process async ..
			//$my_async_data = phpdac\getT('/pparse'. $this->filepath . $_file)); 
			//$data[] = $my_async_data; 
			
			//process sync
			$t = new ktimer;
			
			//1st step: read html file
			$t->start('compile');
			/*if (!$my_sync_data = file_get_contents($this->filepath . $_file)) {
				$t->stop('compile');
				return null;
			}*/	
			if (!$my_sync_data = @file_get_contents($this->filepath . $_file))
				$my_sync_data = '<!--INDEX-->'; //standart page		
			//echo $my_sync_data;		
	  
			//2nd step: compile its phpdac tags based on samename.php file or default script
			$t->start('compile',1);	
			$standartscript = <<<EOF
\$subpage = new pcntl('
super javascript;
load_extension adodb refby _ADODB_; 
super database;
use i18n.i18n;
public cms.cmsrt;
public bshop.rckategories;
public cms.rcmenu;
public cp.rccontrolpanel;
public i18n.i18nL;

',1);
EOF;
			$evalret = null;
			if ($script = @file_get_contents($this->filepath . str_replace('.html','.php', $_file)))
				$evalret = eval($script); //remove php tag	
			else
				$evalret = eval($standartscript); 
			//include($this->filepath . str_replace('/metro2','/metro2/scripts', $_file));
		    $t->stop('compile');
			//echo "<!-- compile " . $t->value('compile') . ' sec -->';  
			
			//3nd step: replace/preg its phpdac tags based on script
			$t->start('include');
			if ($my_sync_data) { 
				//html data has readed and exists
				$pattern = "@<phpdac.*?>(.*?)</phpdac>@s";				
				preg_match_all($pattern, $my_sync_data , $matches, PREG_PATTERN_ORDER);

				foreach ($matches[1] as $r=>$cmd) {
					$_cmd = trim(preg_replace('/\s\s+/', ' ', str_replace("\n", "", $cmd)));
					//$ret = _m($_cmd); //,1); //no error stop 					 
					$my_sync_data = str_replace("<phpdac>".$cmd."</phpdac>", _m($_cmd), $my_sync_data);
					//echo $_cmd .'<br>';
				}
				//final replace main output INDEX tag
				$my_sync_data = str_replace('<!--INDEX-->', $evalret, $my_sync_data);
			}
			else {
				//if html data does not exist return script output as is
				$my_sync_data = $evalret;
			}
			$t->stop('include');
			//echo "<!-- include " . $t->value('include') . ' sec -->'; 			
			
			//if debug
			//$my_sync_data .= var_export($purl, true) .'<br/>'. $_file .'<br/>'. var_export($_REQUEST, true) .'<br/>';
			//$my_sync_data .= '<button onclick="goBack()">Go Back</button>';
			
			//make output array element
			$data[] = $my_sync_data; 
			return json_encode(array("size" => $fsize, "file" => $_file, "data" => $data));		
		}		
		//************************************
		//else fetch new lines from log files
		
        /**
         * Clear the stat cache to get the latest results
         */
        clearstatcache();
        /**
         * Define how much we should load from the log file
         * @var
         */
        if(empty($file)) {
            $file = key(array_slice($this->log, 0, 1, true));
        }
        $fsize = filesize($this->log[$file]);
        $maxLength = ($fsize - intval($lastFetchedSize));
		//echo $fsize,'--', $maxLength;
		
        /**
         * Verify that we don't load more data then allowed.
         */
        if($maxLength > $this->maxSizeToLoad) {
            $maxLength = ($this->maxSizeToLoad / 2);
        }
        /**
         * Actually load the data
         */
        $data = array();
        if($maxLength > 0) {

            $fp = fopen($this->log[$file], 'r');
            fseek($fp, -$maxLength , SEEK_END);
            $data = explode("\n", fread($fp, $maxLength));

        }
		//* ***************************** byme, remove ansi colors ////// */
		$data = preg_replace('#\\x1b[[][^A-Za-z]*[A-Za-z]#', '', $data); 
		
        /**
         * Run the grep function to return only the lines we're interested in.
         */
        if($invert == 0) {
            $data = preg_grep("/$grepKeyword/",$data);
        }
        else {
            $data = preg_grep("/$grepKeyword/",$data, PREG_GREP_INVERT);
        }
        /**
         * If the last entry in the array is an empty string lets remove it.
         */
        if(end($data) == "") {
            array_pop($data);
        }
		
		//$data = file($this->log[$file]);
        return json_encode(array("size" => $fsize, "file" => $this->log[$file], "data" => $data));
    }	
	
	
	//log /file to load js
	public function jread($retjs=false, $interval=null, $callback1=null, $callback2=null) {
		$_interval = $interval ? $interval : $this->updateTime;
		
		$ret = <<<EOF
    /* <![CDATA[ */
    
    intrvID = null;
    
    //Last know size of the file
    lastSize = 0;
    //Grep keyword
    grep = "";
    //Should the Grep be inverted?
    invert = 0;
    //Last known document height
    documentHeight = 0;
    //Last known scroll position
    scrollPosition = 0;
    //Should we scroll to the bottom?
    scroll = true;
    lastFile = window.location.hash != "" ? window.location.hash.substr(1) : "";
    //console.log(lastFile);
    $(document).ready(function() {
    
        //toastr.info('file: '+lastFile);	

        // Setup the settings dialog
        /*$("#settings").dialog({
            modal : true,
            resizable : false,
            draggable : false,
            autoOpen : false,
            width : 590,
            height : 270,
            buttons : {
                Close : function() {
                    $(this).dialog("close");
                }
            },
            open : function(event, ui) {
                scrollToBottom();
            },
            close : function(event, ui) {
                grep = $("#grep").val();
                invert = $('#invert input:radio:checked').val();
                $("#results").text("");
                lastSize = 0;
                $("#grepspan").html("Grep keyword: \"" + grep + "\"");
                $("#invertspan").html("Inverted: " + (invert == 1 ? 'true' : 'false'));
            }
        });
        //Close the settings dialog after a user hits enter in the textarea
        $('#grep').keyup(function(e) {
            if (e.keyCode == 13) {
                $("#settings").dialog('close');
            }
        });
        //Focus on the textarea
        $("#grep").focus();
        //Settings button into a nice looking button with a theme
        //Settings button opens the settings dialog
        $("#grepKeyword").click(function() {
            $("#settings").dialog('open');
            $("#grepKeyword").removeClass('ui-state-focus');
        });
        */
		//click at log files (local scope)
        $(".cpfile").click(function(e) {
            $("#results").text("");
            lastSize = 0;
			//console.log(e);
            //lastFile = e.target ? $(e.target).text() : 'unknown!';
			lastFile = $(e.target).text();
			
			intrvID = setInterval("updateLog()", {$_interval});
        });
        
		//click at cp pages (local scope)
        $(".cplink").click(function(e) {
            $("#results").text("");
            lastSize = 0;
			//console.log(e);
            //lastFile = e.target.hash ? e.target.hash.substr(1) : 'unknown!';
            lastFile = e.target.hash.substr(1);
            //console.log(e.target.hash);
			//console.dir(e.target);
			//console.log(lastFile);
			
			if (intrvID) clearInterval(intrvID);

			if (lastFile.indexOf("/")>=0) 
				updateLog();				
        });		
        
        //when page loads (global scope)
		if (lastFile.indexOf("/")>=0) 	
			updateLog();
		else //It is a log file. Set up an interval for updating the log.
			intrvID = setInterval("updateLog()", {$_interval});
		
        //Some window scroll event to keep the menu at the top
        $(window).scroll(function(e) {
            if ($(window).scrollTop() > 0) {
                $('.float').css({
                    position : 'fixed',
                    top : '0',
                    left : 'auto'
                });
            } else {
                $('.float').css({
                    position : 'static'
                });
            }
        });
        //If window is resized should we scroll to the bottom?
        $(window).resize(function() {
            if (scroll) {
                scrollToBottom();
            }
        });
        //Handle if the window should be scrolled down or not
        $(window).scroll(function() {
            documentHeight = $(document).height();
            scrollPosition = $(window).height() + $(window).scrollTop();
            if (documentHeight <= scrollPosition) {
                scroll = true;
            } else {
                scroll = false;
            }
        });
        scrollToBottom();

    });
    //This function scrolls to the bottom
    function scrollToBottom() {
        $("html, body").animate({scrollTop: $(document).height()}, "fast");
    }
    //This function queries the server for updates.
    function updateLog() {
		//console.log(lastFile+'-'+lastSize);
        $.getJSON('?t=ajax&file=' + lastFile + '&lastsize=' + lastSize + '&grep=' + grep + '&invert=' + invert, function(data) {

			lastSize = data.size;
			if (lastFile.indexOf("/")>=0) { 	
				htmldata = '';//data.data.join();
				$.each(data.data, function(key, value) {
					//$("#results").append('' + value + '<br/>');
					htmldata = htmldata + value;
				});
				$("#results").html(htmldata);
				
				{$callback1}			
			}
			else {					
				//$("#current").text(data.file);
				$.each(data.data, function(key, value) {
					$("#results").append('' + value + '<br/>');
				});
				//toastr.info('file: '+ data.file);
			}			
			
            if (scroll) {
                scrollToBottom();
            }
        }).done(function(data){
					//console.log('success!!');
					{$callback2}
				});
        
        /*
		$(document).ajaxComplete(function( event, xhr, settings ) {
			console.log( settings.url );
			if (settings.url.indexOf("/")>=0) {	
                {$callback2}	
            }    
        });
        */      
    }
    /* ]]> */
EOF;
		
		if ($retjs)
			return $ret;
		
		if (defined('JAVASCRIPT_DPC')) {
		   $js = new jscript;
           $js->load_js($ret,"",1);			   
		   unset ($js);
		}		
	}
	
	//version 2 
	public function jAjaxRead($retjs=false, $interval=null, $callback1=null, $callback2=null) {
		$_interval = $interval ? $interval : $this->updateTime;
		
		$ret = <<<EOF
    /* <![CDATA[ */
    
    intrvID = null;
    
    //Last know size of the file
    lastSize = 0;
    //Grep keyword
    grep = "";
    //Should the Grep be inverted?
    invert = 0;
    //Last known document height
    documentHeight = 0;
    //Last known scroll position
    scrollPosition = 0;
    //Should we scroll to the bottom?
    scroll = false;
    lastFile = window.location.hash != "" ? window.location.hash.substr(1) : "";
    //console.log(lastFile);
    $(document).ready(function() {
    
        toastr.info('file: '+lastFile);	

		//click at log files (local scope)
        $(".cpfile").click(function(e) {
            $("#results").text("");
            lastSize = 0;
			lastFile = $(e.target).text();
			
			intrvID = setInterval("updateLog()", {$_interval});
        });
        
		//click at cp pages (local scope)
        $(".cplink").click(function(e) {
            $("#results").text("");
            lastSize = 0;
            lastFile = e.target.hash.substr(1);
			
			if (intrvID) clearInterval(intrvID);

			if (lastFile.indexOf("/")>=0) 
				updateLog();				
        });		
        
        //when page loads (global scope)
		if (lastFile.indexOf("/")>=0) 	
			updateLog();
		//else //DISABLE WHEN NOT A SELECTED LOG FILE
		else if (lastFile) //IF SELECTEDIt is a log file. Set up an interval for updating the log.
			intrvID = setInterval("updateLog()", {$_interval});
		
        //Some window scroll event to keep the menu at the top
        $(window).scroll(function(e) {
            if ($(window).scrollTop() > 0) {
                $('.float').css({
                    position : 'fixed',
                    top : '0',
                    left : 'auto'
                });
            } else {
                $('.float').css({
                    position : 'static'
                });
            }
        });
        //If window is resized should we scroll to the bottom?
        $(window).resize(function() {
            if (scroll) {
                scrollToBottom();
            }
        });
        //Handle if the window should be scrolled down or not
        $(window).scroll(function() {
            documentHeight = $(document).height();
            scrollPosition = $(window).height() + $(window).scrollTop();
            if (documentHeight <= scrollPosition) {
                scroll = true;
            } else {
                scroll = false;
            }
        });
		if (scroll) {
			scrollToBottom();
		}
		else
			scrollToTop();	
    });
    //This function scrolls to the bottom
    function scrollToBottom() {
        $("html, body").animate({scrollTop: $(document).height()}, "fast");
    }
	//This function scrolls to the top
    function scrollToTop() {
        $("html, body").animate({scrollTop: 0}, "fast");
    }
    //This function queries the server for updates.
    function updateLog() {
		//console.log(lastFile+'-'+lastSize);
        $.getJSON('?t=cpajax&file=' + lastFile + '&lastsize=' + lastSize + '&grep=' + grep + '&invert=' + invert, function(data) {

			lastSize = data.size;
			if (lastFile.indexOf("/")>=0) { 	
				htmldata = '';//data.data.join();
				$.each(data.data, function(key, value) {
					//$("#results").append('' + value + '<br/>');
					htmldata = htmldata + value;
				});
				$("#results").html(htmldata);
				
				{$callback1}	

				scroll = false;	
			}
			else {					
				//$("#current").text(data.file);
				$.each(data.data, function(key, value) {
					$("#results").append('' + value + '<br/>');
				});
				//toastr.info('file: '+ data.file);
				scroll = true;
			}			
			
            if (scroll) {
                scrollToBottom();
            }
			else
				scrollToTop();	
			
        }).done(function(data){
					//console.log('success!!');
					{$callback2}
				});    
    }
    /* ]]> */
EOF;
		
		if ($retjs)
			return $ret;
		
		if (defined('JAVASCRIPT_DPC')) {
		   $js = new jscript;
           $js->load_js($ret,"",1);			   
		   unset ($js);
		}		
	}	
		   
};
}
?>
