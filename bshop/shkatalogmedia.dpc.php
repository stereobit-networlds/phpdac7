<?php
$__DPCSEC['SHKATALOGMEDIA_DPC']='1;1;1;1;1;1;1;1;1;1;1';

if ( (!defined("SHKATALOGMEDIA_DPC")) && (seclevel('SHKATALOGMEDIA_DPC',decode(GetSessionParam('UserSecID')))) ) {

define("SHKATALOGMEDIA_DPC",true);

$__DPC['SHKATALOGMEDIA_DPC'] = 'shkatalogmedia';

$__EVENTS['SHKATALOGMEDIA_DPC'][0]='katalog';
$__EVENTS['SHKATALOGMEDIA_DPC'][1]='klist';
$__EVENTS['SHKATALOGMEDIA_DPC'][2]='kshow';
$__EVENTS['SHKATALOGMEDIA_DPC'][3]='knext';
$__EVENTS['SHKATALOGMEDIA_DPC'][4]='kprev';
$__EVENTS['SHKATALOGMEDIA_DPC'][5]='kprint';
$__EVENTS['SHKATALOGMEDIA_DPC'][6]='addtocart';     //continue with ..cart
$__EVENTS['SHKATALOGMEDIA_DPC'][7]='removefromcart';//continue with ..cart
$__EVENTS['SHKATALOGMEDIA_DPC'][8]='searchtopic';   //continue with ..browser
$__EVENTS['SHKATALOGMEDIA_DPC'][9]='lastentries';
$__EVENTS['SHKATALOGMEDIA_DPC'][10]='sitemap';
$__EVENTS['SHKATALOGMEDIA_DPC'][11]='feed';
$__EVENTS['SHKATALOGMEDIA_DPC'][12]='showimage';
$__EVENTS['SHKATALOGMEDIA_DPC'][13]='shkatalogmedia';
$__EVENTS['SHKATALOGMEDIA_DPC'][14]='kfilter';
$__EVENTS['SHKATALOGMEDIA_DPC'][15]='xmlout';
$__EVENTS['SHKATALOGMEDIA_DPC'][16]='ktree';
$__EVENTS['SHKATALOGMEDIA_DPC'][17]='products';
$__EVENTS['SHKATALOGMEDIA_DPC'][18]='product';
$__EVENTS['SHKATALOGMEDIA_DPC'][19]='api';

$__ACTIONS['SHKATALOGMEDIA_DPC'][0]='katalog';
$__ACTIONS['SHKATALOGMEDIA_DPC'][1]='klist';
$__ACTIONS['SHKATALOGMEDIA_DPC'][2]='kshow';
$__ACTIONS['SHKATALOGMEDIA_DPC'][3]='knext';
$__ACTIONS['SHKATALOGMEDIA_DPC'][4]='kprev';
$__ACTIONS['SHKATALOGMEDIA_DPC'][5]='kprint';
$__ACTIONS['SHKATALOGMEDIA_DPC'][6]='addtocart';     //continue with ..from cart
$__ACTIONS['SHKATALOGMEDIA_DPC'][7]='removefromcart';//continue with ..from cart
$__ACTIONS['SHKATALOGMEDIA_DPC'][8]='searchtopic';   //continue with ..from browser
$__ACTIONS['SHKATALOGMEDIA_DPC'][9]='lastentries';
$__ACTIONS['SHKATALOGMEDIA_DPC'][10]='sitemap';
$__ACTIONS['SHKATALOGMEDIA_DPC'][11]='feed';
$__ACTIONS['SHKATALOGMEDIA_DPC'][12]='showimage';
$__ACTIONS['SHKATALOGMEDIA_DPC'][13]='shkatalogmedia';
$__ACTIONS['SHKATALOGMEDIA_DPC'][14]='kfilter';
$__ACTIONS['SHKATALOGMEDIA_DPC'][15]='xmlout';
$__ACTIONS['SHKATALOGMEDIA_DPC'][16]='ktree';
$__ACTIONS['SHKATALOGMEDIA_DPC'][17]='products';
$__ACTIONS['SHKATALOGMEDIA_DPC'][18]='product';
$__ACTIONS['SHKATALOGMEDIA_DPC'][19]='api';

$__LOCALE['SHKATALOGMEDIA_DPC'][0]='SHKATALOGMEDIA_DPC;Catalogue;Καταλογος';
$__LOCALE['SHKATALOGMEDIA_DPC'][1]='pcs;pcs;τμχ';
$__LOCALE['SHKATALOGMEDIA_DPC'][2]='_array;Items;Στοιχεία';
$__LOCALE['SHKATALOGMEDIA_DPC'][3]='_next;Next;Εμπρος';
$__LOCALE['SHKATALOGMEDIA_DPC'][4]='_prev;Prev;Πίσω';
$__LOCALE['SHKATALOGMEDIA_DPC'][5]='_recent;Recent;Πρόσφατα';
$__LOCALE['SHKATALOGMEDIA_DPC'][6]='_popular;Popular;Προτεινόμενα';
$__LOCALE['SHKATALOGMEDIA_DPC'][7]='_AVAILABILITY;Availability;Διαθεσιμότητα';
$__LOCALE['SHKATALOGMEDIA_DPC'][8]='_WEIGHT;Weight;Βάρος';
$__LOCALE['SHKATALOGMEDIA_DPC'][9]='_VOLUME;Volume;Όγκος';
$__LOCALE['SHKATALOGMEDIA_DPC'][10]='_DIMENSIONS;Dimensions;Διαστάσεις';
$__LOCALE['SHKATALOGMEDIA_DPC'][11]='_SIZE;Size;Μέγεθος';
$__LOCALE['SHKATALOGMEDIA_DPC'][12]='_COLOR;Color;Χρώμα';
$__LOCALE['SHKATALOGMEDIA_DPC'][13]='_DESCRIPTION;Description;Περιγραφή';
$__LOCALE['SHKATALOGMEDIA_DPC'][14]='_ADDITIONALINFO;Additional Informations;Λεπτομέρειες';
$__LOCALE['SHKATALOGMEDIA_DPC'][15]='_REVIEWS;Reviews;Σχόλια';
$__LOCALE['SHKATALOGMEDIA_DPC'][16]='_WITHTAX;with tax;με ΦΠΑ';
$__LOCALE['SHKATALOGMEDIA_DPC'][17]='_NOTAX;net value;χωρίς ΦΠΑ';
$__LOCALE['SHKATALOGMEDIA_DPC'][18]='_MANUFACTURER;Manufacturer;Κατασκευαστής';
$__LOCALE['SHKATALOGMEDIA_DPC'][19]='_code;Code;Κωδικός';
$__LOCALE['SHKATALOGMEDIA_DPC'][20]='_descr;Description;Περιγραφή';
$__LOCALE['SHKATALOGMEDIA_DPC'][21]='_axia;Price;Τιμή';
$__LOCALE['SHKATALOGMEDIA_DPC'][22]='_uniname1;MM;ΜΜ';
$__LOCALE['SHKATALOGMEDIA_DPC'][23]='_order;Order by:;Ταξινόμηση:';
$__LOCALE['SHKATALOGMEDIA_DPC'][24]='_item;Item;Προιόν';
$__LOCALE['SHKATALOGMEDIA_DPC'][25]='_cat1;Detail 1;Χαρακτηριστικό 1';
$__LOCALE['SHKATALOGMEDIA_DPC'][26]='_next;Next;Επόμενο';
$__LOCALE['SHKATALOGMEDIA_DPC'][27]='_prev;Previous;Προηγούμενο';
$__LOCALE['SHKATALOGMEDIA_DPC'][28]='_offers;Offers;Προσφορές';
$__LOCALE['SHKATALOGMEDIA_DPC'][29]='_lastitems;New arrivals;Νέες αφίξεις';
$__LOCALE['SHKATALOGMEDIA_DPC'][30]='_gallery;Additional files;Συνημένα αρχεία';
$__LOCALE['SHKATALOGMEDIA_DPC'][31]='_availabillity;Availabillity;Διαθεσιμότητα';
$__LOCALE['SHKATALOGMEDIA_DPC'][32]='_items;Items;Προιόντα';
$__LOCALE['SHKATALOGMEDIA_DPC'][33]='_asc;Asc;Αυξουσα';
$__LOCALE['SHKATALOGMEDIA_DPC'][34]='_desc;Desc;Φθινουσα';
$__LOCALE['SHKATALOGMEDIA_DPC'][35]='_first;First;Πρώτα';
$__LOCALE['SHKATALOGMEDIA_DPC'][36]='_all;All;Ολα';
$__LOCALE['SHKATALOGMEDIA_DPC'][37]='_nofound;Items not found;Δεν βρέθηκαν εγγραφές';
$__LOCALE['SHKATALOGMEDIA_DPC'][38]='_title;Title;Περιγραφή';
$__LOCALE['SHKATALOGMEDIA_DPC'][39]='_norecs;Record set is empty;Οι εγγραφές δεν υπάρχουν';
$__LOCALE['SHKATALOGMEDIA_DPC'][40]='_norec;Record not exist;Η εγγραφή δεν υπάρχει';
$__LOCALE['SHKATALOGMEDIA_DPC'][41]='_lockrec;Locked record;Η εγγραφή είναι κλειδωμένη';
$__LOCALE['SHKATALOGMEDIA_DPC'][42]='_brands;Brands;Κατασκευαστές';
$__LOCALE['SHKATALOGMEDIA_DPC'][43]='_price;Price;Τιμή';
$__LOCALE['SHKATALOGMEDIA_DPC'][44]='_filter;Filter;Φίλτρο';
$__LOCALE['SHKATALOGMEDIA_DPC'][45]='_incart;Already in cart %d items;Έχετε στο καλάθι %d τεμάχια;';
$__LOCALE['SHKATALOGMEDIA_DPC'][46]='_cartmsg;Cart message;Ενημέρωση;';
$__LOCALE['SHKATALOGMEDIA_DPC'][47]='_pricerange;Price range;Εύρος τιμής;';
$__LOCALE['SHKATALOGMEDIA_DPC'][48]='_ORDERID;Favorites;Δημοφιλέστερα;';
$__LOCALE['SHKATALOGMEDIA_DPC'][49]='_NEWEST;Newest;Νεότερα;';

class shkatalogmedia {
	
    var $max_items, $result, $path, $urlpath, $inpath;
	var $map_t, $map_f;
	var $pprice, $codetype;
	var $availability;	
    var $userLevelID;	
	var $is_reseller, $htmlpath;
	var $listcontrols;
	var $carthandler;	
	var $max_selection;
	
	var $itemfimagex,$itemfimagey,$imagex,$imagey, $itemimagex, $itemimagey;	
	var $imageclick, $linemax;
	var $thubpath_large, $thubpath_medium, $thubpath_small;
	var $myorderby, $asc, $deforder, $defasc;
    var $global_hide_asceding;
	var $addfx, $addfy;	
	var $asccombostyle;
	var $decimals;
	var $toggler, $catbanner, $itemlockparam, $itemlockgoto, $isitemlocked;	
	
    var $title;
	var $allow_show_resource;
	var $url;
	var $onlyincategory;
	var $oneitemlist, $my_one_item;
	var $photodb;
	var $encoding, $feed_on;
	var $noloadjslightbox, $additional_files_perline;
	var $notreebrowser, $encodeimageid, $default_pager;
	var $asceding_class, $nav_on;
	var $pager_current_class;
	var $orderid, $sortdef, $bypass_order_list;
	var $isListView, $imgLargeDB, $imgMediumDB, $imgSmallDB;
	var $ogTags, $siteTitle, $httpurl, $mobile;
	var $selectSQL, $fcode, $lastprice, $itmname, $itmdescr, $lan, $itmplpath, $myorder;
	var $realID, $max_price, $min_price, $loyalty;
	var $filterajax, $pageName, $phpName, $klistcmd, $kshowcmd;
	var $fpx, $rtl, $_catAllFilter, $filter_records_in_products_table, $max_result_price;	
	var $gotoJS, $gridORlist, $apiKeyApprove, $apiKeyCmd, $_key;
	var $disabledAgentDiv, $facebookApp, $TwiterApp;

	public function __construct() {	
		$UserSecID = GetGlobal('UserSecID');	
		$this->userLevelID = (((decode($UserSecID))) ? (decode($UserSecID)) : 0);	  
		
		$this->path = paramload('SHELL','prpath');	//echo $this->path;
		$this->urlpath = paramload('SHELL','urlpath');
		$this->inpath = paramload('ID','hostinpath');			
		$this->httpurl = _v('cmsrt.httpurl');
		
		$languange = getlocal();
		$this->lan = $languange ? $languange : '0';
		$this->encoding = 'utf-8';			
		$this->msg = null;
		$this->post = null;		  
		$this->result = null;				

		$this->imgpath = $this->inpath . '/images/uphotos/';  	  
		$this->thubpath = $this->inpath . '/images/thub/';
		$photo_bg = remote_paramload('SHKATALOG','photobgpath',$this->path);		  
		$this->thubpath_large = $photo_bg ? $this->inpath . "/images/$photo_bg/":$this->inpath . '/images/thub/';	  	  
		$photo_md = remote_paramload('SHKATALOG','photomdpath',$this->path);		  
		$this->thubpath_medium = $photo_md ? $this->inpath . "/images/$photo_md/":$this->inpath . '/images/thub/';	  	  
		$photo_sm = remote_paramload('SHKATALOG','photosmpath',$this->path);		  
		$this->thubpath_small = $photo_sm ? $this->inpath . "/images/$photo_sm/":$this->inpath . '/images/thub/';	  	  	  	  
	  
		$rt = remote_paramload('SHKATALOG','restype',$this->path);
		$this->restype = $rt?$rt:'.jpg';
		//fp img xy
		$this->itemfimagex = remote_paramload('SHKATALOG','itemfimagex',$this->path);	
		$this->itemfimagey = remote_paramload('SHKATALOG','itemfimagey',$this->path); 
		//thumb xy
		$this->imagex = remote_paramload('SHKATALOG','imagex',$this->path);	
		$this->imagey = remote_paramload('SHKATALOG','imagey',$this->path);	  
		//item xy
		$this->itemimagex = remote_paramload('SHKATALOG','itemimagex',$this->path);	
		$this->itemimagey = remote_paramload('SHKATALOG','itemimagey',$this->path);

		$this->addfx = remote_paramload('SHKATALOG','addimagex',$this->path);	
		$this->addfy = remote_paramload('SHKATALOG','addimagey',$this->path);	  	  

		$this->imageclick = remote_paramload('SHKATALOG','imageclick',$this->path);
		$this->linemax = remote_paramload('SHKATALOG','itemsperline',$this->path); 	

		$this->htmlpath = $this->urlpath . $this->inpath . '/cp/html/';
		$this->pager = GetReq('pager')?GetReq('pager'): (GetSessionParam('pager')?GetSessionParam('pager') : remote_paramload('SHKATALOG','pager',$this->path));
		$this->zeroprice_msg = remote_paramload('SHKATALOG','zeroprice',$this->path);		  
	  
		$this->map_t = remote_arrayload('SHKATALOG','maptitle',$this->path);	
		$this->map_f = remote_arrayload('SHKATALOG','mapfields',$this->path);	
		$this->pprice = remote_arrayload('SHKATALOG','pricepolicy',$this->path);
		if (empty($this->pprice)){//default
			$this->pprice[0]='price0';
			$this->pprice[1]='price1';
		}

		$this->codetype = remote_paramload('SHKATALOG','codetype',$this->path);	  	
		$this->availability = remote_arrayload('SHKATALOG','qtyavail',$this->path);		  	
	  	  
		$this->is_reseller = GetSessionParam('RESELLER'); 
		$this->carthandler = remote_paramload('SHKATALOG','carthandler',$this->path);	
		$this->one_attachment = remote_paramload('SHKATALOG','oneattach',$this->path);
		$this->max_selection = null;	  
		$this->deforder = remote_paramload('SHKATALOG','deforder',$this->path);	
		$this->defasc = remote_paramload('SHKATALOG','defasc',$this->path);  
		$this->global_hide_asceding = remote_paramload('SHKATALOG','hideasc',$this->path);  
		$this->asccombostyle = remote_paramload('SHKATALOG','asccombostyle',$this->path);	

		$cb = remote_arrayload('SHKATALOG','categorybanner',$this->path);	 
		$this->catbanner = is_array($cb)?(array)$cb : remote_paramload('SHKATALOG','categorybanner',$this->path);	  
	  
		$this->itemlockparam = remote_paramload('SHKATALOG','itemlockparam',$this->path);
		$this->itemlockgoto = remote_paramload('SHKATALOG','itemlockgoto',$this->path);	
		$this->isitemlocked = false;  

		$this->set_order(); //reset ..init 

		$dec_num = remote_paramload('SHKATALOG','decimals',$this->path);
		$this->decimals = $dec_num ? $dec_num : 2;   
	   
		$toggle = remote_arrayload('SHKATALOG','toggler',$this->path);  
		$deftoggle = array(0=>'no',1=>'yes');
		$this->toggler = (!empty($toggle)) ? $toggle : $deftoggle;	  	  

		$this->title = localize('SHKATALOGMEDIA_DPC',$this->lan);
		$this->restype = $rt ? $rt : $this->restype;	 //parent restype when no additional files....	  
	  
		$rt = remote_arrayload('SHKATALOGMEDIA','restype',$this->path);
		$rd = array('.jpg','.png');
		$this->advrestype = $rt ? $rt : $rd;	 //advanced retypes to support multiple files as .png .swf ....
	  
		$this->onlyincategory = remote_paramload('SHKATALOGMEDIA','onlyincategory',$this->path);	
		$this->oneitemlist = remote_paramload('SHKATALOGMEDIA','oneitemlist',$this->path);
		
		$pdb = remote_paramload('SHKATALOGMEDIA','photodb',$this->path);
		$this->photodb = $pdb ? $pdb : false; 
	  
		$this->my_one_item = null;
		$this->feed_on = remote_paramload('SHKATALOGMEDIA','feed',$this->path);
	  
		$adfperline = remote_paramload('SHKATALOGMEDIA','addfilesperline',$this->path);
		$this->additional_files_perline = $adfperline ? $adfperline : null;	//3
		$this->notreebrowser = remote_paramload('SHKATALOGMEDIA','notreebrowser',$this->path);
		$this->encodeimageid = remote_paramload('SHKATALOGMEDIA','encodeimageid',$this->path);
		$this->default_pager = remote_paramload('SHKATALOG','pager',$this->path);	 
		$aclass = remote_paramload('SHKATALOGMEDIA','ascedingclass',$this->path);
		$this->asceding_class = $aclass ? $aclass : 'myf_select_small';	  
		$this->nav = remote_paramload('SHKATALOGMEDIA','catnav',$this->path);
		$pagecurrentclass = remote_paramload('SHKATALOGMEDIA','pagecurrentclass',$this->path);
		$this->pager_current_class = $pagecurrentclass ? $pagecurrentclass : ' class="current"';
	  
		$sort = remote_paramload('SHKATALOGMEDIA','sortdef',$this->path);   
		$asc = GetReq('asc') ? GetReq('asc') : GetSessionParam('asc');
		switch ($asc) {
			case 1  : $this->sortdef = 'ASC'; break;
			case 2  : $this->sortdef = 'DESC'; break;
			default : $this->sortdef = $sort ? $sort : 'ASC';
		}	

		$this->fcode = $this->getmapf('code');
		$this->lastprice = $this->getmapf('lastprice') ? ','.$this->getmapf('lastprice') : ',xml';
	  
		$this->itmname = $this->lan ? 'itmname' : 'itmfname';
		$this->itmdescr = $this->lan ? 'itmdescr' : 'itmfdescr';
		$this->myorder = null;	
	  
		$oid = remote_paramload('SHKATALOGMEDIA','orderid',$this->path);
		$this->orderid = $oid ? $oid . ' ' . $this->sortdef : 'orderid ' . $this->sortdef;	  	  
	  
		$bpsl = remote_paramload('SHKATALOGMEDIA','bypasssortlist',$this->path);
		$this->bypass_order_list = $bpsl ? true : false;

		$this->imgLargeDB = remote_paramload('SHKATALOGMEDIA','photobgDB',$this->path);	
		$this->imgMediumDB = remote_paramload('SHKATALOGMEDIA','photomdDB',$this->path);
		$this->imgSmallDB = remote_paramload('SHKATALOGMEDIA','photosmDB',$this->path);

		//grid or list selection
		$this->gridORlist = _m('cmsrt.paramload use ESHOP+gridorlist') ?: null; //grid or list pageview 	
		if ($this->gridORlist) {
			//set cookie only at init (when null)
			if (!$_COOKIE['viewmode'])
				$_COOKIE['viewmode'] = 'list';
		}	

		$this->isListView = ($_COOKIE['viewmode']=='list') ? 1 : 0;
		//echo '-', $this->gridORlist , '+' , $this->isListView;
      
		$this->siteTitle = remote_paramload('SHELL','urltitle',$this->path);	
		$this->siteTwitter = remote_paramload('INDEX','twitter', $this->path);	  
		$this->siteFb = remote_paramload('INDEX','facebook', $this->path);
		$this->ogTags = null;	  
		$this->twitTags = null;
		$this->min_price = 0;
		$this->max_price = 0;
		$this->realID = null;
		
		$this->loyalty = _m('cmsrt.paramload use ESHOP+loyalty');
		$this->itmplpath = _m('cmsrt.paramload use ESHOP+templates'); //'templates/'; //item page templates dir	
		
		$this->phpName = _v('cmsrt.phpName');
		$ajax = _m('cmsrt.paramload use ESHOP+ajax'); //ajax mode	
		$catName = _m('shkategories.getcurrentkategory use ++1'); //category name
		
        $this->pageName = $catName ? 'page-' . $catName : 'page-' . $this->phpName; //'page'; //div name		
		$this->filterajax = $ajax ? true : false; 
		$this->mobile = _v('cmsrt.mobile');
		
		$this->klistcmd = _m('cmsrt.paramload use ESHOP+klistcmd') ?: 'klist'; //products
		$this->kshowcmd = _m('cmsrt.paramload use ESHOP+kshowcmd') ?: 'kshow'; //product
		
		$this->_catAllFilter = _m('cmsrt.paramload use ESHOP+searchallkeyword') ?: 'all'; //'*'		
		$this->max_result_price = _m('cmsrt.paramload use ESHOP+maxresultprice') ?: 999.9; //max result price 
		$this->fpx = _m('cmsrt.paramload use ESHOP+filterheightpx') ?: '100px'; //filter height	
		$this->rtl = _m('cmsrt.paramload use ESHOP+RTL') ?: '100px'; //RTL navigation 	
		
		//values: 0 or header/stick-position/stick-element/..other div id (default the cat/item div id)
		$this->gotoJS = _m('cmsrt.paramload use ESHOP+gotojskatalog') ?: $this->pageName;

		$this->selectSQL = "select id,sysins,code1,pricepc,price2,itmname,itmfname,uniname1,uniname2,active,code4," .
							"price0,price1,cat0,cat1,cat2,cat3,cat4,itmdescr,itmfdescr,itmremark,ypoloipo1,resources,".
							$this->fcode. $this->lastprice . ",weight,volume,dimensions,size,color,manufacturer,orderid,YEAR(sysins) as year,MONTH(sysins) as month,DAY(sysins) as day, DATE_FORMAT(sysins, '%h:%i') as time, DATE_FORMAT(sysins, '%b') as monthname," .
							"template,owner,itmactive,p1,p2,p3,p4,p5,code2,code3,datein from products ";	

		//matching filter fields that exists at products table
		$this->filter_records_in_products_table = array('manufacturer'=>'manufacturer', 
														'color'=>'color',
														'size'=>'size',
														'dimensions'=>'dimensions',
														);							
		
		$this->facebookApp = _m('cmsrt.paramload use CMS+facebookApp') ?: false;
		$this->twitterApp = _m('cmsrt.paramload use CMS+twitterApp') ?: false;
		$this->disabledAgentDiv = _m('cmsrt.paramload use CMS+disableAgentDiv') ?: false;
		
		$this->disabledAgentDiv = _m('cmsrt.paramload use CMS+disableAgentDiv') ?: false;
		$this->javascript();	
			
		$this->apiKeyApprove=false;	
		$this->apiKey = null;
		$this->_key = '1234567890'; //todo logged in user
    }
	
	public function event($event=null) {
		global $pushTokens;
	
	    switch ($event) {
			
			case 'api'          :	if ($apiKey = GetReq('apikey')) {
				                        //do some key explodes
										$apiParts = explode('api', $apiKey);
										if ($apiParts[0] == $this->_key) {
											$this->apiKeyApprove=true;
											$this->apiKeyCmd = $apiParts[1];
											//echo $apiKey,'zz',$apiParts[1];
											
											switch ($this->apiKeyCmd) {
												case 'kshow'        :   $this->realID = $this->read_item();
																	    $out['items'] = $this->show_item_api(); 	
																	    die((empty($out['items'])) ? json_encode(array('items'=>array())) : json_encode($out));
															break;
												case 'klistpriceasc':   $this->my_one_item = $this->read_list(false,2,1); 
																		$out['items'] = $this->list_katalog_api(0);
																	    die((empty($out['items'])) ? json_encode(array('items'=>array())) : json_encode($out));
															break;				
												case 'klistpricedec':   $this->my_one_item = $this->read_list(false,2,2); 
																		$out['items'] = $this->list_katalog_api(0);
																	    die((empty($out['items'])) ? json_encode(array('items'=>array())) : json_encode($out));
															break;
												case 'klistmanufasc':   $this->my_one_item = $this->read_list(false,5,1); 
																		$out['items'] = $this->list_katalog_api(0);
																	    die((empty($out['items'])) ? json_encode(array('items'=>array())) : json_encode($out));
															break;
												case 'klistmanufdec':   $this->my_one_item = $this->read_list(false,5,2); 
																		$out['items'] = $this->list_katalog_api(0);
																	    die((empty($out['items'])) ? json_encode(array('items'=>array())) : json_encode($out));
															break;
												case 'klistpopasc'  :   $this->my_one_item = $this->read_list(false,4,1); 
																		$out['items'] = $this->list_katalog_api(0);
																	    die((empty($out['items'])) ? json_encode(array('items'=>array())) : json_encode($out));		
															break;
												case 'klistpopdec'  :   $this->my_one_item = $this->read_list(false,4,2); 
																		$out['items'] = $this->list_katalog_api(0);
																	    die((empty($out['items'])) ? json_encode(array('items'=>array())) : json_encode($out));
															break;
												case 'klistnewasc'  :   $this->my_one_item = $this->read_list(false,6,1); 
																		$out['items'] = $this->list_katalog_api(0);
																	    die((empty($out['items'])) ? json_encode(array('items'=>array())) : json_encode($out));
															break;
												case 'klistnewdec'  :   $this->my_one_item = $this->read_list(false,6,2); 
																		$out['items'] = $this->list_katalog_api(0);
																	    die((empty($out['items'])) ? json_encode(array('items'=>array())) : json_encode($out));
															break;	
												case 'klistasc'     :   $this->my_one_item = $this->read_list(false,1,1); 
																		$out['items'] = $this->list_katalog_api(0);
																	    die((empty($out['items'])) ? json_encode(array('items'=>array())) : json_encode($out));
															break;	
												case 'klistdec'     :   $this->my_one_item = $this->read_list(false,1,2); 
																		$out['items'] = $this->list_katalog_api(0);
																	    die((empty($out['items'])) ? json_encode(array('items'=>array())) : json_encode($out));
															break;	
												case 'klist'        :   $this->my_one_item = $this->read_list();//true); 
												
																	    $out['items'] = $this->list_katalog_api(0);
																	    die((empty($out['items'])) ? json_encode(array('items'=>array())) : json_encode($out));
															break;
															
												//filters api				
												case 'kfilter': 		$this->my_one_item = $this->fread_list(true);
															break;				
												case 'ksearch' :		//replace standart search in api with ksearch
																		$input = GetParam('Input') ? GetParam('Input') : GetReq('input');
																		$this->do_quick_search($input, true);
															break;												
												case 'kgetfilter':		//fetch filter list
																		if ((defined("SHKATEGORIES_DPC")) && ($ctokens['items'] = _m('shkategories.apiGetFilter use kfilter+' . GetReq('id')))) 
																			die(json_encode($ctokens)); 
															break;

												//cart api			
												case 'kcartadd':		if ((defined("SHCART_DPC")) && ($ctokens['items'] = _m('shcart.apiCartAdd use ' . GetReq('id')))) 
																			SetSessionParam('cartstatus',0);
																		die(json_encode($ctokens)); 
															break;
												case 'kcartremove':		if ((defined("SHCART_DPC")) && ($ctokens['items'] = _m('shcart.apiCartRemove use ' . GetReq('id')))) 
																			SetSessionParam('cartstatus',0); 
																		die(json_encode($ctokens)); 	
															break;
												case 'kcartclear'	:	if ((defined("SHCART_DPC")) && ($ctokens['items'] = _m('shcart.apiCartClear')))
																			SetSessionParam('cartstatus',0); 
																		die(json_encode($ctokens)); 
															break;
												case 'kcart'    :		if ((defined("SHCART_DPC")) && ($json['items'] = _m('shcart.apiCartRead')))
																			die((empty($json['items'])) ? json_encode(array('items'=>array())) : json_encode($json));
															break;
															
												//cat api			
												case 'kcatlist' :		//fetch subdirs
																		if ((defined("SHKATEGORIES_DPC")) && ($ctokens['items'] = _m('shkategories.apiCatList use klist+' . GetReq('cat')))) 
																			die(json_encode($ctokens)); 
															break;
												case 'kcattree' :		//fetch root
																		if ((defined("SHKATEGORIES_DPC")) && ($ctokens['items'] = _m('shkategories.apiCatTree use ' . GetReq('cat').'++1+'))) 
																			die(json_encode($ctokens)); 
															break;	

												case 'kcmsmenu':		if ((defined("CMSMENU_DPC")) && ($ctokens['items'] = _m('cmsmenu.apiMenu use ' . GetReq('cat')))) 
																			die(json_encode($ctokens)); // todo <phpdac>cmsmenu.callMenu use menu+fpmenu+li</phpdac>
															break;							
											
												default       : echo 'unknown api cmd';				
											}
										}//approve
										else
											die('api-key-error');		
									}			
									break;
									
			case 'sitemap'       : 	die($this->sitemap_feed(true));	//xml output
									break;		
		
			case 'feed'          :	if ($id = GetReq('id')) 
										$this->realID = $this->read_item(); 
									elseif ($cat = GetReq('cat')) 
										$this->read_list();
																		  
									die($this->katalog_feed()); //xml output	
									break;
								 
			case 'xmlout'        :  _m("cmsvstats.update_category_statistics use ".GetReq('cat')."+xmlout"); 
									$this->xmlread_list();
									$xml = $this->xml_feed();
									die($xml);	//xml output
									break;
			//cart override
			case 'addtocart'     : 	if ($this->userLevelID < 5) { 
										$cartstr = explode(';', GetReq('a'));
										$item = $cartstr[0]; 
										_m("cmsvstats.update_item_statistics use $item+cartin");
										
										$this->analytics('cartadd', $this->fetchProductTokens($item));
									}
									if (_v("shcart.fastpick")) 
										$this->jsBrowser();
									
									if ($pushTokens) {
										//SHCART_DPC handle this
										//$defarray[0] = array('itmname'=>'default page','itmurl'=>'.','itmdescr'=>'default description','price'=>'0');
										//_m('cmsrt.pushTokens use ' . bin2hex(bzcompress(json_encode($defarray, 9))));
									}
									break; 
									
			case 'removefromcart': 	if ($this->userLevelID < 5) {
										$cartstr = explode(';', GetReq('a'));
										$item = $cartstr[0];
										_m("cmsvstats.update_item_statistics use $item+cartout");
										
										$this->analytics('cartrem', $this->fetchProductTokens($item));
									}

									if ($pushTokens) {
										//SHCART_DPC handle this
										//$defarray[0] = array('itmname'=>'default page','itmurl'=>'.','itmdescr'=>'default description','price'=>'0');
										//_m('cmsrt.pushTokens use ' . bin2hex(bzcompress(json_encode($defarray, 9))));
									}		
									break;		
		
			case 'showimage'    : 	$this->show_photodb(GetReq('id'), GetReq('type'));

			case 'kfilter'      :	$this->my_one_item = $this->fread_list(); 
									
									if ($this->userLevelID < 5) {
										$_filter = $this->replace_spchars(GetParam('input'),1);
										_m("cmsvstats.update_category_statistics use $_filter+filter");		  
									}
									
									$this->jsBrowser();
									break;	
									
			case 'ktree'      :		$this->my_one_item = $this->tread_list(); 
									
									if ($this->userLevelID < 5) {
										$_filter = $this->replace_spchars(GetParam('treeid'),1);
										_m("cmsvstats.update_category_statistics use $_filter+filter");		  
									}	
									$this->jsBrowser();
									break;			
									
			case 'products'     :						
			case 'klist'        :   $this->my_one_item = $this->read_list(); 
									if ($this->userLevelID < 5) 
										_m("cmsvstats.update_category_statistics use ".GetReq('cat'));		  
																	
									$this->jsBrowser();
									
									//push tokens direct to cms for rendering file without templates
									if ($pushTokens) 
										_m('cmsrt.pushTokens use ' . bin2hex(bzcompress(json_encode($this->list_katalog_api(0)), 9)));	
									break;	

			case 'product'      :						
			case 'kshow'        :	$this->realID = $this->read_item(); 
			
									$incart = _m("shcart.getCartItemQty use " . $this->realID);
									if ($incart) {
										$this->jsDialog(sprintf(localize('_incart', $this->lan), $incart), 
														localize('_cartmsg', $this->lan));
									}				
									
									if ($this->userLevelID < 5) 
										_m("cmsvstats.update_item_statistics use ". $this->realID);
									
									$this->jsBrowser();
									
									//push tokens direct to cms for rendering file without templates
									if ($pushTokens)
										_m('cmsrt.pushTokens use ' . bin2hex(bzcompress(json_encode($this->show_item_api(0)), 9)));																		
									break;
											
			default             : 	$this->jsBrowser();
			
									if ($pushTokens) {
										$defarray[0] = array('itmname'=>'default page','itmurl'=>'.','itmdescr'=>'default description','price'=>'0');
										_m('cmsrt.pushTokens use ' . bin2hex(bzcompress(json_encode($defarray, 9))));
									}	
		}			
    }	
	
	public function action($action=null) {
		global $pushTokens, $_tokens;		

	    switch ($action) {
			
			case 'api'          :	/* MOVED TO EVENTS
									if ($this->apiKeyApprove===true) {
				                        //echo $apiParts[1],'--',$this->apiKeyCmd;
										switch ($this->apiKeyCmd) {
											case 'kshow' :  $out['items'] = $this->show_item_api(); 
															break;
											case 'klistpriceasc':				
											case 'klistpricedec':
											case 'klistmanufasc':
											case 'klistmanufdec':
											case 'klistpopasc':
											case 'klistpopdec':
											case 'klistnewasc':
											case 'klistnewdec':
											case 'klistasc'   :
											case 'klistdec'   :											
											case 'klist' :  $out['items'] = $this->list_katalog_api(0);
															break;
											case 'kfilter': $out['items'] = $this->list_katalog_api(0);
															break;				
											case 'ksearch': $out['items'] = $this->list_katalog_api(0);
															break;					
										}	
										//$ret = json_encode($out);
										$ret = (empty($out['items'])) ? json_encode(array('items'=>array())) : json_encode($out);
										die($ret);
									}	*/		
									break;
			case 'sitemap'       :
			case 'feed'          :
			case 'xmlout'        :		  
									break;		
		
			//cart override
			case 'removefromcart':  //if ($pushTokens) return json_encode($_tokens);//SHCART_DPC handle this
			
									$out = _m("shcart.cartview");   
									break;
									
			case 'addtocart'     :  //if ($pushTokens) return json_encode($_tokens);//SHCART_DPC handle this
			
									if (($this->carthandler) || (GetSessionParam('fastpick')=='on')) {
										if (GetReq('cat')) {
											$this->my_one_item = $this->read_list(); 							  							
											$out = $this->list_katalog(0);											
										}
										else 
											//$out = $this->default_action(); //!!!
											$out = _m("shcart.cartview"); 
									}  
									else
										$out = _m("shcart.cartview");   
									break;								
		
			case 'kfilter'      :	if (($this->insideClick()===true) && ($this->filterajax) && (!$this->mobile)) {
										die($this->list_katalog(0,'kfilter'));
									}	
									else	
										$out .= $this->list_katalog(0,'kfilter');																 
									break;
									
			case 'ktree'      	:	if (($this->insideClick()===true) && ($this->filterajax) && (!$this->mobile)) {
										die($this->list_katalog(0,'ktree'));
									}	
									else
										$out = $this->list_katalog(0, $this->klistcmd);	
									break;
								
			case 'products'     :					
			case 'klist'        : 	if ($pushTokens) return json_encode($_tokens);
										//print_r($_tokens);
			
									/*if (((GetReq('page')) || (GetReq('asc')) || 
										(GetReq('order')) || (GetReq('pager'))) &&*/
									if (($this->insideAjaxClick()===true) &&	
										(($this->filterajax ) && (!$this->mobile))) { //ajax
										die($this->list_katalog(0, $this->klistcmd));
									}
									else { //click from categories (no ajax)
										if (in_array('beforeitemslist',$this->catbanner))//before
											$out .= _m('shkategories.show_category_banner');									  
								   								
										$out .= $this->list_katalog(0);		
								
										//banner down
										if (in_array('afteritemslist',$this->catbanner))//after
											$out .= _m('shkategories.show_category_banner');														 
									}	
									break;

			case 'product'      :						  
			case 'kshow'        : 	if ($pushTokens) return json_encode($_tokens);
										//print_r($_tokens);
			
									if (in_array('beforeitem',$this->catbanner))
										$out .= _m('shkategories.show_category_banner');	
								  
									$out .= $this->show_item();
								
									if (in_array('afteritem',$this->catbanner))
										$out .= _m('shkategories.show_category_banner');	
									break;									
		  
			default             : 	if ($pushTokens) return json_encode($_tokens);
			
									if (!GetReq('modify')) 
										$out .= $this->default_action();	
		  
		}	
		
		return ($out);
    }
	
	//h1 seo header
	public function showH1($text=null) {
		if (!$text) return null;
		$ret = '<h1>' . $tet . '</h1>';
		return ($ret);
	}		
	
	//pagination results (called by fppager template)
	public function dataSetValue($max=null, $_end=false) {
		$page = GetReq('page') ? GetReq('page') : 0;
		$pmax = $this->pager;
		
		if ($max)
			return strval($this->max_selection);
		
		$start = $page ? ($page*$pmax)+1 : 1;
		$end = $page ? $start + $pmax : $pmax;	
		
		return $_end ? strval($end) : strval($start);
	}		
	
	protected function insideClick() {
		$host = $_SERVER['HTTP_HOST'];
		$referer = $_SERVER['HTTP_REFERER'];
		
		if (preg_match("/$host/i", $referer))
			return true;		
			
		return false;	
	}	
	
	/* clicked from inside */
	/* when a url come from search engines indexing */
	//set public used by shnsearch
	public function insideAjaxClick() {
		$host = $_SERVER['HTTP_HOST'];
		$referer = $_SERVER['HTTP_REFERER'];
		
		if (((GetReq('page')) || (GetReq('asc')) || 
		     (GetReq('order')) || (GetReq('pager'))) &&
			(preg_match("/$host/i", $referer)))
			return true;		
			
		return false;	
	}	
	
	//js called when in catalog page
	protected function jsCatalog() {
		$mobileDevices = _m('cmsrt.mobileMatchDev');	
		$_goto = $this->gotoJS ;//$this->pageName;
		
		$cat = GetReq('cat');		
		$_nofilterurl = $this->httpurl . '/'. _m("cmsrt.url use t={$this->klistcmd}&cat=$cat"); 			
		
		$min = intval($this->min_price);// ? round($this->min_price, 0, PHP_ROUND_HALF_DOWN) : 0; //100;
		$max = ($this->max_price) ? ceil($this->max_price) : 10; //700;
		$diff = ($max - $min);
		$step = ($diff<=100) ? 1 : 10;//($max-$min) / 10;
		$inp = _m('cmsrt.escapeordie use ' . GetReq('input'));
		
		if (strstr($inp, ',')) {
			//multiple values
			$fl = explode(',', $inp);
			foreach ($fl as $feaf) {
				if (is_numeric($feaf)) { //get the last element numeric of array (DO NOT SAVE AS ARRAY)
					$input = explode('.', $feaf);				
				}
				else //if ($feaf) 
					$reset_input[] = $feaf;
			}
		}
		elseif (is_numeric($inp)) { //single numeric
			$input = explode('.', $inp);			 
		}		
		elseif (($inp) && ($inp!=$this->_catAllFilter))// not * single value
		    $reset_input[] = $inp;
			
		if (!$input) $input = array('0','0');	
		
		//$input = is_numeric($inp) ? explode('.', $inp) : array('0','0');
		//echo 'Input:'. GetParam('input') .' '.$input[0] .' '.$input[1]; 
		
		$_cat = $cat ? $cat : $this->_catAllFilter; //<<< all keyword means no cat
		$_filterurl = $this->httpurl . '/' .  _m("cmsrt.url use t=kfilter&cat=$_cat");		
		
		$purl = $_filterurl; 
		$purl.= empty($reset_input) ? null : implode(',', $reset_input) . ',';

		//echo $this->min_price.'-'.$this->max_price.'-'.$min.'-'.$max.'-'.$diff.'-'.$step;		
					
		$onPrice = /*(($this->filterajax) && (!$this->mobile)) ?		
"$('.price-slider').on('slideStop', function(slideEvt) {
	var p = $('.price-slider').val();
	var value = p.replace(',', '.');
	//console.log(value);
	ajaxCall('$purl'+value+'/','{$this->pageName}',1);
});" :	*/		
"$('.price-slider').on('slideStop', function(slideEvt) {
	var p = $('.price-slider').val();
	var value = p.replace(',', '.');
	//console.log(value);
	if (value)
		window.location = '$purl'+value+'/';
	else
		window.location = '$_nofilterurl';
});
";					
		
		
		$js = "
$onPrice

function remFilter(f, div) {
	var nfurl = '$_nofilterurl'; 
	var furl = '$_filterurl';
	var finp = '$inp';
	var url = window.location.toString();
	
	if (f==finp) /* single filter value */
		window.location = nfurl;	
	else { 
		var nf = new Array;
		var ff = finp.split(',');
		var i=0;
		for (var j=0; j<ff.length; j++) {
			if (ff[j].match(f)) {} else {nf[i] = ff[j]; i+=1;}
		}
		//alert(nf.length + '>' + nf.join(','));
		window.location = furl + nf.join(',') + '/';

	}
	if (div) gotoTop(div);
}	

$(document).ready(function () {
	if ($('.price-slider').length > 0) {
		var v0 = parseInt('{$input[0]}') ? {$input[0]} : {$min};
		var v1 = parseInt('{$input[1]}') ? {$input[1]} : {$max};
        $('.price-slider').slider({
            min: {$min},
            max: {$max},
            step: {$step},
            value: [v0, v1],
            handle: 'square'
        });
    }
	
	if (/{$mobileDevices}/i.test(navigator.userAgent)) 
		window.scrollTo(0,parseInt($('#{$_goto}').offset().top, 10));
	else {	
		gotoTop('{$_goto}');	
		$(window).scroll(function() { 
	
			if (agentDiv('{$this->pageName}',200)) {	
				$.ajax({ url: 'jsdialog.php?t=jsdcode&cat={$cat}&div={$this->pageName}', cache: false, success: function(jsdialog){
					eval(jsdialog);		
				}})	
			}	
		});
	}		
}); 
";
		return ($js);
	}

	//js called when in item page
	protected function jsItem() {
		$mobileDevices = _m('cmsrt.mobileMatchDev');
		$_goto = ($this->gotoJS==$this->pageName) ? $this->realID : $this->gotoJS;		

		$js = "
function jsShowPhoto(name) {	
	if (/{$mobileDevices}/i.test(navigator.userAgent)) {
	}	
	else {	
		new $.Zebra_Dialog(
			'<img src=\"{$this->thubpath_large}{$this->realID}.jpg\" />', {
			'width': 800, 'height': 600,
			'position' : ['top + 20','center'],
			'title':  name});		
	}	
}
function jsShowPhotoAdd(name,pic) {	
	if (/{$mobileDevices}/i.test(navigator.userAgent)) {
	}	
	else {	
		new $.Zebra_Dialog(
			'<img src=\"'+pic+'\" />', {
			'width': 800, 'height': 600,
			'position' : ['top + 20','center'],
			'title':  name});		
	}	
}
		
$(document).ready(function () {
	if (/{$mobileDevices}/i.test(navigator.userAgent)) 
		window.scrollTo(0,parseInt($('#{$_goto}').offset().top, 10));
	else {
		gotoTop('{$_goto}');

		$(window).scroll(function() { 
		
			if (agentDiv('{$this->realID}',300)) {	
				$.ajax({ url: 'jsdialog.php?t=jsdcode&id={$this->realID}&div={$this->realID}-details', cache: false, success: function(jsdialog){
					eval(jsdialog);		
				}})	
			}
		});
	}		
});	
		";
		return ($js);	
	}		
	
	//js called when no item/category page
	protected function jsPage() {
		$mobileDevices = _m('cmsrt.mobileMatchDev');
		$_goto = $this->gotoJS; //$this->pageName;		

		$js = "
$(document).ready(function () {
	if (/{$mobileDevices}/i.test(navigator.userAgent)) 
		window.scrollTo(0,parseInt($('#{$_goto}').offset().top, 10));
	else {
		gotoTop('{$_goto}');

		$(window).scroll(function() { 
		
			if (agentDiv('{$this->pageName}',300)) {	
				$.ajax({ url: 'jsdialog.php?t=jsdcode&id={$this->pageName}&div={$this->pageName}-details', cache: false, success: function(jsdialog){
					eval(jsdialog);		
				}})	
			}
		});
	}		
});	
		";
		return ($js);		
	}
	
	protected function jsBrowser() {
		if (!defined('JAVASCRIPT_DPC')) return ;		
		
		$code = ($id = GetReq('id')) ? $this->jsItem() : 
				(($cat = GetReq('cat')) ? $this->jsCatalog() : $this->jsPage());
		   
		if ($code) {
			$js = new jscript;	
			$js->load_js($code,null,1);		
			unset ($js);
		}	
	}	
	
	
	protected function jsFilter() {
		
		//$jsChars = str_replace('+','\[+]', $this->replace_jschars());
		//echo $jsChars, '<br/>';
		
		$js = <<<JSFILTER
		
String.prototype.allReplace = function(obj) {
    var retStr = this;
    for (var x in obj) {
        retStr = retStr.replace(new RegExp(x, 'g'), obj[x]);
    }
    return retStr;
};		
		
function filter(url,div,fname,preset) {
	var checkedItems = fname ? 
		$('input:checkbox[name='+fname+']:checked').map(
			function() { 
				return $(this).val().toString().allReplace({'\'':'_', ',':'~', '"':'*', '\[+]':'plus', '/':':', ' ':'-', '-&-':'-n-'});
				//return $(this).val().toString().allReplace({ $jsChars }); 
			} 
		).get().join(",") : (preset ? preset : null);
	
	ajaxCall(url+checkedItems+'/',div,1);
}
JSFILTER;

		if ($this->disabledAgentDiv)
			$js .= "
/* disabled func */		
function agentDiv(n, px) { return false; }		
";

		return ($js);
	}	
	
	public function javascript() {
		if (!defined('JAVASCRIPT_DPC')) return ;		
  
	    $code = $this->jsFilter();

		$js = new jscript;	
        $js->load_js($code,null,1);		
		unset ($js);	
	}		

	protected function jsDialog($text=null, $title=null) {
		if (!defined('JAVASCRIPT_DPC')) return ;
	
        if (defined('JSDIALOGSTREAM_DPC')) {
	   
			if ($text)	
				$code = _m("jsdialogstream.say use $text+$title++2000");
			else	
				$code = _m('jsdialogstream.streamDialog use jsdtime');
		   
		    $js = new jscript;	
            $js->load_js($code,null,1);		
		    unset ($js);
	    }	
	}	
	
	protected function orderSQL($myorder=null, $myasc=null) {
		$order = $myorder ? $myorder : (GetReq('order') ? GetReq('order') : GetSessionParam('order'));	
		$asc = $myasc ? (($myasc==2) ? 'DESC':'ASC') : $this->sortdef;
		$ppolicy = $this->is_reseller ? 'price0' : 'price1';
		
		if ($this->myorder) { //phpdac hack
			$sSQL = " ORDER BY ";	
			$sSQL .= $this->myorder .' '. ($this->myasc ? $this->myasc : $this->sortdef);		
			return ($sSQL);			
		}
		
		switch ($order) {
		    case 1  : $o = $this->bypass_order_list ? null : $this->itmname; break;
			case 2  : $o = $this->bypass_order_list ? null : $ppolicy; break;  
		    case 3  : $o = $this->bypass_order_list ? null : $this->fcode; break;
			case 4  : $o = $this->bypass_order_list ? null : 'orderid,' . $this->itmname; break;			
			case 5  : $o = $this->bypass_order_list ? null : 'manufacturer'; break;
			case 6  : $o = $this->bypass_order_list ? null : 'datein'; break;	

			case 7  : $o = $this->bypass_order_list ? null : 'cat1'; break;				
			case 8  : $o = $this->bypass_order_list ? null : 'cat2'; break;				
			case 9  : $o = $this->bypass_order_list ? null : 'cat3'; break;		
			
		    default : $o = $this->bypass_order_list ? null : $this->itmname;
		}  

		$sSQL = " ORDER BY ";	
		$sSQL .= $o .' '. $asc; //$this->sortdef ;	
		//echo $sSQL;
		
		return ($sSQL);
	}	
	
	protected function default_action() {
	    $db = GetGlobal('db');	
		$page = GetReq('page') ? GetReq('page') : 0;	
		
        $sSQL = $this->selectSQL;				
		$sSQL .= " WHERE itmactive>0 and active>0";			 
		$sSQL .= $this->orderSQL();
		$sSQL .= " LIMIT 100";
								 
	    $this->result = $db->Execute($sSQL,2);
		$this->max_items = $db->Affected_Rows();
	    $this->get_max_result();		
		
		if (!$this->onlyincategory) 
		    $out .= $this->list_katalog(0);
		
		return ($out);
	}	

	public function do_quick_search($text2find, $nopager=false, $order=null, $asc=null) {
        $db = GetGlobal('db');	
		$page = GetReq('page') ? GetReq('page') : 0;	
		$stype = GetParam('searchtype'); 
		$scase = GetParam('searchcase'); 
		$incategory = GetReq('cat');	

		$_allS = (defined("SHKATEGORIES_DPC")) ? _v('shkategories._catAllSearch') : $this->_catAllFilter;	

		if (($text2find) && ($text2find!=$_allS)) {
			$ut = urldecode($text2find);
			$parts = explode(" ",$text2find);//get special words in text like code:  			
			
			_m("cmsvstats.update_category_statistics use $ut+search");				
		
			switch ($parts[0]) {
		  
				case 'code:' :  $where = " ( ".$this->fcode." like '%" . $this->decodeit($parts[1]) . "%')";
								break;
								
				default      : 	//normal search
								if (defined("SHNSEARCH_DPC")) {
									
									$sfields = array(0=>$this->fcode,
													1=>$this->itmname,
													2=>$this->itmdescr,
													3=>'itmremark',
													4=>'manufacturer',
													5=>'code4',
													6=>'code3',
												);
									$serialf = serialize($sfields);									
									$where = '('. _m("shnsearch.findsql use $text2find+$serialf+$stype+$scase") . ')';		  
								}
								else { 			  	
									$where = '(' . " ( {$this->itmname} like '%" . strtolower($text2find) . "%' or  {$this->itmname} like '%" . strtoupper($text2find) . "%')";	
									$where .= " or ";		   
									$where .= " ( {$this->itmdescr} like '%" . strtolower($text2find) . "%' or  {$this->itmdescr} like '%" . strtoupper($text2find) . "%')";				 
									$where .= " or ";		   
									$where .= " ( itmremark like '%" . strtolower($text2find) . "%' or  itmremark like '%" . strtoupper($text2find) . "%')";				 					 
									$where .= " or ";		   			 
									$where .= " ( ".$this->fcode." like '%" . strtolower($text2find) . "%' or  " . $this->fcode . " like '%" . strtoupper($text2find) . "%')";						 
									$where.= ')' ;
								}			   
	   				 
			}				
	   	}
		
		$sSQL = $this->selectSQL;
		$sSQL.= $where ? ' where ' . $where : ' where ';
		
		if ($incategory) {	
			$cats = stristr($incategory, $this->sep()) ? explode($this->sep(),$incategory) : array(0=>$incategory);
			foreach ($cats as $c=>$mycat)
				$s[] = 'cat'.$c ."=" . $db->qstr($this->replace_spchars($mycat,1));		  	  
			$catSQL = implode (' and ', $s);	
		}
		$sSQL.= $catSQL ? ($where ? ' and ' . $catSQL . ' and ' : $catSQL . ' and ' ) : ($where ? ' and ' : null);   							  
		$sSQL.= " itmactive>0 and active>0";	
		$sSQL.= $this->orderSQL($order, $asc);
		  
		//LIMITED SEARCH
		//if ($this->pager) {
		if (($this->pager) && (!$nopager)) {	
			$p = $page * $this->pager;
			$sSQL .= " LIMIT $p,".$this->pager; //page element count
		}
 
		$resultset = $db->Execute($sSQL,2); 
		$this->result = $resultset; 
		$this->meter = $db->Affected_Rows();
		$this->max_items = $db->Affected_Rows();
		$this->get_max_result($ut);		
	}		
	
	//called from shnsearch !!!!
	public function do_filter_search($text2find, $nopager=false, $order=null, $asc=null) {
        $db = GetGlobal('db');	
		$page = GetReq('page') ? GetReq('page') : 0;	
		$incategory = GetReq('cat');							
		
		if ($text2find) {
		
			$sSQL = $this->selectSQL;
			
			if (is_numeric($text2find)) {
				
				$_f = $this->read_policy();
				$_prices = explode('.', $text2find);
				$sSQL .= " where (" . 
						 $_f . ">=" . $this->spt($_prices[0]) . " and " .
						 $_f . "<=" . $this->spt($_prices[1]) . ") ";
			}
			else {//single value
				if (strstr($text2find, ':')) {
					$_hv = explode(':', $text2find);
					$sSQL .= $_WHERE . $_hv[0]."=". $db->qstr($_hv[1]);
				}
				else//) if ($text2find)	&& ($text2find!=$this->_catAllFilter)) 
					$sSQL .= " where manufacturer=" . $db->qstr($text2find);
			}	
		  
			if ($incategory) {	
				$cats = explode($this->sep(),$incategory);
				foreach ($cats as $c=>$mycat)
					$sSQL .= ' and cat'.$c ." ='" . $this->replace_spchars($mycat,1) . "'";		  	  
			}
		   							 
			$sSQL .= " and itmactive>0 and active>0";	
			$sSQL .= $this->orderSQL($order, $asc);

			//LIMITED SEARCH
			if (($this->pager) && (!$nopager)) {
				$p = $page * $this->pager;
				$sSQL .= " LIMIT $p,".$this->pager; //page element count
			}
	  
			$resultset = $db->Execute($sSQL,2); 
			$this->result = $resultset; 
			$this->meter = $db->Affected_Rows();
			$this->max_items = $db->Affected_Rows();
			$this->get_max_result($text2find);																
	   	}
	}	
	
	
	protected function _sqlFindOption($v, $maxo=4) {
		$ret = null;
		for ($i=0;$i<$maxo;$i++) {
			$f = ($i>0) ? 'ctreeopt.opt'. strval($i) : 'ctreeopt.opt0';
			$_s[] = "$f='". $this->replace_spchars($v,1) ."'";
		}	
		
		//"( ctreeopt.opt0='{$this->replace_spchars($_hv[1],1)}' OR ctreeopt.opt1='{$this->replace_spchars($_hv[1],1)}' OR ctreeopt.opt2='{$this->replace_spchars($_hv[1],1)}' )";
		$ret = '(' . implode(' OR ', $_s) . ')';
		return $ret;
	}	
	
	protected function _sqlFilter($filter, $whereClause=null, &$_SQLJOIN) {
        $db = GetGlobal('db');			
		$stype = GetParam('searchtype');
		$scase = GetParam('searchcase');
		$flf = array();
		$sSQL = null;
		
		$_allF = (defined("SHKATEGORIES_DPC")) ? _v('shkategories._catAllSearch') : $this->_catAllFilter;
		
			if (defined("SHNSEARCH_DPC")) {
				$sfields = array(0=>$this->fcode,
							 1=>$this->itmname,
							 2=>$this->itmdescr,
							 3=>'itmremark',
							 //4=>'manufacturer',
							);
				$serialf = serialize($sfields);	
			}	
			
			$_WHERE = $whereClause ? ' AND ' : null;	
			//$_AND = ' OR ';
			
			if (strstr($filter, ',')) {
				//multiple values
				$fl = explode(',', $filter);
				foreach ($fl as $feaf) {
					if (strstr($feaf, ':')) {
						$_hv = explode(':', $feaf);
						//$flf[] = $_hv[0]."=". $db->qstr($this->replace_spchars($_hv[1],1));
						if (array_key_exists($_hv[0], $this->filter_records_in_products_table)) {							
							//field that included in products table
							$_filterField = $this->filter_records_in_products_table[$_hv[0]];
							$flf[] = $_filterField ."=". $db->qstr($this->replace_spchars($_hv[1],1));
						}	
						else {
							//filter ktree table join (reset sSQL param)
							//$flf[] = "ctreeopt.opt0='{$this->replace_spchars($_hv[1],1)}'"; //ctreemap.tid = ctreeopt.opt0,1,2,3
							$flf[] = $this->_sqlFindOption($_hv[1]);
							$_SQLJOIN = true;
						}							
						//$_AND = ' AND ';
					}
					elseif (is_numeric($feaf)) {
						$_f = $this->read_policy();
						$_prices = explode('.', $feaf);
						$flf[] = " (" . 
								 $_f . ">=" . $this->spt($_prices[0]) . " AND " .
								 $_f . "<=" . $this->spt($_prices[1]) . ") ";
					}							
					elseif (($feaf) && ($feaf!=$_allF)) // *
						if (defined("SHNSEARCH_DPC")) 
							$flf[] = _m("shnsearch.findsql use $feaf+$serialf+$stype+$scase");
				}	
				$sSQL .= $_WHERE . ' (' . implode(' AND ', $flf) . ')'; //$_AND
			}	
			elseif ($filter)  {//single value
				if (strstr($filter, ':')) {
					$_hv = explode(':', $filter);
					//$sSQL .= $_WHERE . $_hv[0]."=". $db->qstr($this->replace_spchars($_hv[1],1));
					if (array_key_exists($_hv[0], $this->filter_records_in_products_table)) {							
						//field that included in products table	
						$_filterField = $this->filter_records_in_products_table[$_hv[0]];
						$sSQL .= $_WHERE . $_filterField ."=". $db->qstr($this->replace_spchars($_hv[1],1));
					}
					else {
						//filter ktree table join (reset sSQL param)
						//$sSQL .= $_WHERE . "ctreeopt.opt0='{$this->replace_spchars($_hv[1],1)}'"; //ctreemap.tid = ctreeopt.opt0,1,2,3
						$sSQL .= $_WHERE . $this->_sqlFindOption($_hv[1]);
						$_SQLJOIN = true;
					}						
				}
				elseif (is_numeric($filter)) { //single numeric value
					$_f = $this->read_policy();
					$_prices = explode('.', $filter);
					$sSQL .= $_WHERE . " (" . 
							$_f . ">=" . $this->spt($_prices[0]) . " and " .
							$_f . "<=" . $this->spt($_prices[1]) . ") ";
				}				
				elseif ($filter!=$_allF) {	
					if (defined("SHNSEARCH_DPC")) 	
						$sSQL .= _m("shnsearch.findsql use $filter+$serialf+$stype+$scase");
				}
				else
					$sSQL .= null;	
			}
			else
				$sSQL .=\null;			

		return $sSQL;		
	}	
	
	protected function get_max_result($text2find=null,$filter=null) {
        $db = GetGlobal('db');
		$cat = (GetReq('cat')==$this->_catAllFilter) ? null : GetReq('cat'); //<<< all keyword means no cat	  		
		$cat_tree = explode($this->sep(), $cat);		
		$stype = GetParam('searchtype');
		$scase = GetParam('searchcase');
		$whereClause = null;			
		$_SQLJOIN = false;		
		
		$price = $this->read_policy();	
		//$sSQL = "select count(id),min($price),max($price) from products where ";		
		
		if ($text2find) {
		
			if (defined("SHNSEARCH_DPC")) {
				
				$mytext = $filter ? $this->replace_spchars($text2find,1) : $text2find; //search by user or filter
				
				$sfields = array(0=>$this->fcode,
								 1=>$this->itmname,
								 2=>$this->itmdescr,
								 3=>'itmremark',
								 /*4=>'manufacturer',
								 5=>'code4',
								 6=>'code3',*/
								);
				$serialf = serialize($sfields);
				$whereClause = _m("shnsearch.findsql use $mytext+$serialf+$stype+$scase");						  
			}
			else {		
				$mytext = $filter ? $this->replace_spchars($text2find,1) : strtolower($text2find); //search by user or filter			  
				$whereClause = " ( {$this->itmname} like '%" . $mytext . "%' or {$this->itmname} like '%" . $mytext . "%')";	
				$whereClause .= " or ";		   
				$whereClause .= " ( {$this->itmdescr} like '%" . $mytext . "%' or  {$this->itmdescr} like '%" . $mytext . "%')";				 
				$whereClause .= " or ";		   
				$whereClause .= " ( itmremark like '%" . strtolower($text2find) . "%' or itmremark like '%" . $mytext . "%')";				 					 
				$whereClause .= " or ";		   			 
				$whereClause .= " ( ".$this->fcode." like '%" . $mytext . "%' or " . $this->fcode . " like '%" . $mytext . "%')";								  		
			}	
			//search in cat...				  
			if ($cat_tree[0])
			    $whereClause .= ' and cat0=' . $db->qstr($this->replace_spchars($cat_tree[0],1));		  
			if ($cat_tree[1])	
		 	    $whereClause .= 'and cat1=' . $db->qstr($this->replace_spchars($cat_tree[1],1));		 
			if ($cat_tree[2])	
			    $whereClause .= 'and cat2=' . $db->qstr($this->replace_spchars($cat_tree[2],1));		   
			if ($cat_tree[3])	
			    $whereClause .= 'and cat3=' . $db->qstr($this->replace_spchars($cat_tree[3],1));
		   						  
		}
		else {//katalog page	  
		    if ($cat_tree[0])
			    $whereClause .= ' cat0=' . $db->qstr($this->replace_spchars($cat_tree[0],1));	
			elseif ($this->onlyincategory)
			 	$whereClause .= ' cat1=\'\' ';					  
		    if ($cat_tree[1])	
		 	    $whereClause .= ' and cat1=' . $db->qstr($this->replace_spchars($cat_tree[1],1));
			elseif ($this->onlyincategory)
			 	$whereClause .= ' and cat1=\'\' ';						 
		    if ($cat_tree[2])	
			    $whereClause .= ' and cat2=' . $db->qstr($this->replace_spchars($cat_tree[2],1));		
			elseif ($this->onlyincategory)
			 	$whereClause .= ' and cat2=\'\' ';				   
		    if ($cat_tree[3])	
			    $whereClause .= ' and cat3=' . $db->qstr($this->replace_spchars($cat_tree[3],1));
			elseif ($this->onlyincategory)
			 	$whereClause .= ' and cat3=\'\' ';				   		
		}
		//GET HERE min/max prices (before applied filter)   
		/*min max prices (select without price filter) NOT RE-FILTERING*/
		//if ($whereClause==null) {
			//SOS in case of search and then filter the statement has no where (cant find on all products) 
			
			$sSQL = "select count(id),min($price),max($price) from products ";
			$sSQL .= $whereClause ? " where " . $whereClause : " where ";	
			$sSQL .= $whereClause ? " and itmactive>0 and active>0" : " itmactive>0 and active>0";	
			$resultset = $db->Execute($sSQL);
			
			$this->min_price = $resultset->fields[1] ? $resultset->fields[1] : 0;
			$this->max_price = $resultset->fields[2] ? $resultset->fields[2] : $this->max_result_price;
			$this->max_selection = $resultset->fields[0];
			//echo '<br>('. $this->max_selection .')-(' . $this->min_price . ')-(' . $this->max_price .')'. $sSQL;
		/*}
		else {
			//SOS in case of search and then filter the statement has no where
			$this->min_price = 0.1; //fix min
			$this->max_price = $this->max_result_price; //fix mx
		}	*/		
		
		if ($filter) {
			$whereClause .= $this->_sqlFilter($filter, $whereClause, $_SQLJOIN);
		
			//$sSQL = "select count(id),min($price),max($price) from products ";
			$sSQL = ($_SQLJOIN==true) ? //sql tree join (spcace-id, for secure id, convertion)
								str_replace(array('id', 'orderid'), array(' products.id','products.orderid'), 
								"select count(id),min($price),max($price) from products ") . ',ctreeopt' :
								"select count(id),min($price),max($price) from products ";
			$sSQL .= " WHERE " . $whereClause;
			$sSQL .= ($_SQLJOIN==true) ? 
						" AND itmactive>0 AND active>0 AND ctreeopt.code=products.id" : 
						" AND itmactive>0 AND active>0"; 
						
			$resultset = $db->Execute($sSQL);

			//!!! remark to not apply filter on price range
			//$this->min_price = $resultset->fields[1] ? $resultset->fields[1] : 0;
			//$this->max_price = $resultset->fields[2] ? $resultset->fields[2] :$this->max_result_price;
			$this->max_selection = $resultset->fields[0];
			//echo "<br>(". $this->max_selection .')-(' . $resultset->fields[1] . ')-(' . $resultset->fields[2] .')'. $sSQL;
		}
		
		return ($this->max_selection);
	}	

	public function show_photodb($itmcode=null, $stype=null, $type=null) {
		$db = GetGlobal('db');
		if (!$itmcode) return;
		$type = $type ? $type : $this->restype;
	  	  
		$sSQL = "select data,type,code from pphotos  WHERE code='" . $itmcode . "'";
		if (isset($type))
			$sSQL .= " and type='". $type ."'";
		if (isset($stype))
			$sSQL .= " and stype='". $stype ."'";		
	  
		$resultset = $db->Execute($sSQL,2);	
		$result = $resultset;	  
		$mime_type = 'image/'.str_replace('.','',$result->fields['type']);
		$mime_type = 'image/jpeg';
		header('Content-type: ' . $mime_type);

		if ($result->fields['code']) //photo exists
			echo base64_decode($result->fields['data']);
		else {//additional photo or standart nopic
			switch ($stype) {
				case 'LARGE' : echo @file_get_contents(getcwd().'/images/photo_bg/nopic.jpg'); break;
				case 'MEDIUM': echo @file_get_contents(getcwd().'/images/photo_md/nopic.jpg'); break;
				case 'SMALL' : echo @file_get_contents(getcwd().'/images/photo_sm/nopic.jpg'); break;
				default      : echo @file_get_contents(getcwd().'/images/photo_sm/nopic.jpg'); 
			}
		}  
	  
		die();
	}	
	
	public function get_photo_url($code, $photosize=null) {
		$db = GetGlobal('db');
		if (!$code) return;  

		switch ($photosize) {
	       case 3  : $tpath = $this->thubpath_large; 
		             $stype = $this->imgLargeDB ? $this->imgLargeDB : 'LARGE';
		             break;	   
	       case 2  : $tpath = $this->thubpath_medium; 
		             $stype = $this->imgMediumDB ? $this->imgMediumDB : 'MEDIUM';
		             break;	   
	       case 1  : $tpath = $this->thubpath_small;
                     $stype = $this->imgSmallDB ? $this->imgSmallDB : 'SMALL';		   
		             break;
	       default : $tpath = $this->thubpath;	
                     $stype = '';		   
		}
	  
		if ($this->photodb) { 
			if (is_numeric($this->photodb))	  
				$photo = _m("cmsrt.seturl use t=showimage&id=$code&type=$stype");
			else  
				$photo = '/' . $this->photodb . '?id='.$code.'&type='.$stype;
		}
		else {//ordinal image
			$pfile = $this->encode_image_id($code); //_m('shkategories.encode_image_id use '.$code);
			$photo_file = $this->urlpath . '/' .$tpath . $pfile . $this->restype;	  
			$photo = (file_exists($photo_file)) ? $tpath . $pfile . $this->restype : $tpath . 'nopic' . $this->restype; 
	    }
	   
	    return ($photo);	 	
	}	
	
	protected function list_photo($code,$x=100,$y=null,$imageclick=1,$mycat=null,$photosize=null,$clickphotosize=null,$altname=null) {
		$page = GetReq('page')?GetReq('page'):0;		
		$cat = $mycat ? $mycat : GetReq('cat');  
		$a_name = $altname ? $altname : $code;   
	   
		$photo = $this->get_photo_url($code,$photosize);//define size
	   
	   	   
	    if (($imageclick==null) || ((is_numeric($imageclick)) && ($imageclick>=0))) {
	    
			if ($imageclick==1) {//phot url	
				$clickphoto = $clickphotosize ? $this->get_photo_url($code,$clickphotosize) : $this->get_photo_url($code,$photosize);
				$plink = "<a href=\"$photo\">";
				$lo = "<img src=\"" . $photo . "\"";
				$lo.= $y ? "height=\"$y\"" : null; 
				$lo.= "border=\"0\" alt=\"$a_name". localize('_IMAGE',$this->lan) . "\">" . "</a>"; 
				$ret = $plink . $lo;
			}
			elseif ($imageclick==2) {//product url
				$myresource = "<img src=\"" . $photo . "\"";
				$myresource.= "alt=\"$a_name". localize('_IMAGE',$this->lan) . "\">";
		  
				$purl = _m("cmsrt.url use t={$this->kshowcmd}&cat=$cat&id=$code"); 
				$plink = "<a href=\"$purl\">";
				$ret = $plink . $myresource . "</a>";           
			}
			elseif ($imageclick==0) {//item link
				$myresource = "<img src=\"" . $photo . "\"";
				$myresource.= "alt=\"$a_name". localize('_IMAGE',$this->lan) . "\">";
				$ret = _m("cmsrt.url use t={$this->kshowcmd}&cat=$cat&page=$page&id=$code+" . $myresource); 
			} 
			else {//item link
				$myresource = "<img src=\"" . $photo . "\"";
				$myresource.= "alt=\"$a_name". localize('_IMAGE',$this->lan) . "\">";		  
				$ret = _m("cmsrt.url use t={$this->kshowcmd}&cat=$cat&page=$page&id=$code+" . $myresource); 
			} 
		}
		else {
			$plink = "<a href=\"$imageclick\">";
			$ret = $plink . "<img src=\"" . $photo . "\"" . "></a>";           		
	    } 	   		
		
	    return ($ret);
	}				
	
	protected function read_list($nopager=false, $order=null, $asc=null) {
        $db = GetGlobal('db');	
		$page = GetReq('page') ? GetReq('page') : 0;	

		$filter = _m('cmsrt.escapeordie use ' . GetReq('id'));	//ID here	
		$whereClause = null;
		$_SQLJOIN = false;			
		//$isfilter = $filter ? (strstr(':', $filter, true) ? true : false) : false;

		if ($cat = GetReq('cat')) {		   
		  
			$cat_tree = explode($this->sep(), $cat); 
			
			$sSQL = $this->selectSQL;
			$sSQL .= " WHERE ";		   
		      	  
			if ($cat_tree[0])
				$whereClause .= ' cat0=' . $db->qstr($this->replace_spchars($cat_tree[0],1));		
			elseif ($this->onlyincategory)
				$whereClause .= ' (cat0 IS NULL OR cat0=\'\') ';				  
			if ($cat_tree[1])	
				$whereClause .= ' and cat1=' . $db->qstr($this->replace_spchars($cat_tree[1],1));	
			elseif ($this->onlyincategory)
				$whereClause .= ' and (cat1 IS NULL OR cat1=\'\') ';	 
			if ($cat_tree[2])	
				$whereClause .= ' and cat2=' . $db->qstr($this->replace_spchars($cat_tree[2],1));	
			elseif ($this->onlyincategory)
			 	$whereClause .= ' and (cat2 IS NULL OR cat2=\'\') ';		   
			if ($cat_tree[3])	
				$whereClause .= ' and cat3=' . $db->qstr($this->replace_spchars($cat_tree[3],1));
			elseif ($this->onlyincategory)
				$whereClause .= ' and (cat3 IS NULL OR cat3=\'\') ';
				
			//API HTACCESS USE	
			//in case of id	= : separated, it is a filter and not product id
			//echo '22222222222===' . $filter . '--->' . $isfilter;
			if (($filter)) {// && (mb_strstr(':', $filter, true))) {	
				$whereClause .= $this->_sqlFilter($filter, $whereClause, $_SQLJOIN);
			
				//$sSQL = $this->selectSQL;
				$sSQL = ($_SQLJOIN==true) ? //sql tree join (spcace-id, for secure id, convertion)
						str_replace(array(' id,', 'orderid,'), array(' products.id,','products.orderid,'), 
						$this->selectSQL) . ',ctreeopt' :
						$this->selectSQL;
				$sSQL .= " WHERE " . $whereClause;		
				$sSQL .= ($_SQLJOIN==true) ? 
						" AND itmactive>0 AND active>0 AND ctreeopt.code=products.id" : 
						" and itmactive>0 and active>0"; 
				$sSQL .= $this->orderSQL($order, $asc);	
				//echo $sSQL;	
			}
		   	else {	  
				$sSQL .= $whereClause;				 
				$sSQL .= " and itmactive>0 and active>0";	
				$sSQL .= $this->orderSQL($order, $asc);
			}
			
			if (($this->pager) && (!$nopager)) {
				$p = $page * $this->pager;
				$sSQL .= " LIMIT $p,".$this->pager; //page element count
			}
			//echo $sSQL;
			
			$resultset = $db->Execute($sSQL,2);
			$this->result = $resultset; 
			$this->max_items = $db->Affected_Rows();//count($this->result);
			
	        $this->get_max_result();				
	      
			if ($this->max_items==1) 
				return ($this->result->fields[$this->fcode]); //to view the item without click on dir		
		}	
		
		return null;
	}	
	
	/* filter */
	protected function fread_list($nopager=false, $order=null, $asc=null) {
        $db = GetGlobal('db');	
		$stype = GetParam('searchtype');
		$scase = GetParam('searchcase');		
		$page = GetReq('page') ? GetReq('page') : 0;			
		$cat = (GetReq('cat')==$this->_catAllFilter) ? null : GetReq('cat'); //<<< all keyword means no cat	
		
		$filter = _m('cmsrt.escapeordie use ' . GetReq('input'));
		$whereClause = null;
		$_SQLJOIN = false;		
		
		//$sSQL = $this->selectSQL;
		//$sSQL .= " WHERE ";			
		
		if ($cat!=null) {		   
			$cat_tree = explode($this->sep(),$cat);    
		      	  
			if ($cat_tree[0])
				$whereClause = ' cat0=' . $db->qstr($this->replace_spchars($cat_tree[0],1));		
			elseif ($this->onlyincategory)
				$whereClause .= ' (cat0 IS NULL OR cat0=\'\') ';				  
			if ($cat_tree[1])	
				$whereClause .= ' and cat1=' . $db->qstr($this->replace_spchars($cat_tree[1],1));	
			elseif ($this->onlyincategory)
				$whereClause .= ' and (cat1 IS NULL OR cat1=\'\') ';	 
			if ($cat_tree[2])	
				$whereClause .= ' and cat2=' . $db->qstr($this->replace_spchars($cat_tree[2],1));	
			elseif ($this->onlyincategory)
			 	$whereClause .= ' and (cat2 IS NULL OR cat2=\'\') ';		   
			if ($cat_tree[3])	
				$whereClause .= ' and cat3=' . $db->qstr($this->replace_spchars($cat_tree[3],1));
			elseif ($this->onlyincategory)
				$whereClause .= ' and (cat3 IS NULL OR cat3=\'\') ';
		   		
			//$sSQL .= $whereClause;
		}  
		
		if ($filter) {
			$whereClause .= $this->_sqlFilter($filter, $whereClause, $_SQLJOIN);
			
			//$sSQL = $this->selectSQL;
			$sSQL = ($_SQLJOIN==true) ? //sql tree join (spcace-id, for secure id, convertion)
						str_replace(array(' id,', 'orderid,'), array(' products.id,','products.orderid,'), 
						$this->selectSQL) . ',ctreeopt' :
						$this->selectSQL;
		    $sSQL .= " WHERE " . $whereClause;		
			$sSQL .= ($_SQLJOIN==true) ? 
						" AND itmactive>0 AND active>0 AND ctreeopt.code=products.id" : 
						" and itmactive>0 and active>0"; 
			$sSQL .= $this->orderSQL($order, $asc);
		  
			//if ($this->pager) {
			if (($this->pager) && (!$nopager)) {	
				$p = $page * $this->pager;
				$sSQL .= " LIMIT $p,".$this->pager; //page element count
			}
		    
			$resultset = $db->Execute($sSQL,2);
			$this->result = $resultset; 
			$this->max_items = $db->Affected_Rows();//count($this->result);
			
		    $x = $this->get_max_result(null, $filter);		
	        //echo '<br>('. $x .')-(' . $this->max_items . ')-(' . $filter .  ')-->' . $sSQL;
			
			if ($this->max_items==1) 
				return ($this->result->fields[$this->fcode]); //to view the item without click on dir			
		}
		
		return null;
	}

	/* tree read */
	protected function tread_list($nopager=false, $order=null, $asc=null) {
        $db = GetGlobal('db');	
		$page = GetReq('page') ? GetReq('page') : 0;			
		$cat = GetReq('cat');
		$treeid = GetParam('treeid');
		
		//not a filter cmd = common cat read
		if (!$treeid) 
			return $this->read_list();
			
		list($treename, $treeleaf) = explode(':', $treeid);
		if ($treeleaf) {
			if (strstr($treeleaf, ',')) {
				//multiple values
				$tl = explode(',', $treeleaf);
				foreach ($tl as $leaf)
					$tlf[] = "ctreemap.tid='$leaf'";
				$tleafs = '(' . implode(' OR ', $tlf) . ')';	
			}
			else //single value
				$tleafs = "ctreemap.tid='$treeleaf'";
		}	
		else //not a filter value = common cat read
			return $this->read_list();	
		
		if ($cat!=null) {		   
			$cat_tree = explode($this->sep(),$cat); 
			$sSQL = str_replace(array(' id,', 'orderid,'), 
								array(' products.id,','products.orderid,'),
								$this->selectSQL);
			$sSQL .= ",ctreemap WHERE ctreemap.code=products.id and ";		   
			$sSQL .= $tleafs; //"ctreemap.tid='$treeleaf'";
		      	  
			if ($cat_tree[0])
				$whereClause = ' and cat0=' . $db->qstr($this->replace_spchars($cat_tree[0],1));		
			elseif ($this->onlyincategory)
				$whereClause .= ' (and cat0 IS NULL OR cat0=\'\') ';				  
			if ($cat_tree[1])	
				$whereClause .= ' and cat1=' . $db->qstr($this->replace_spchars($cat_tree[1],1));	
			elseif ($this->onlyincategory)
				$whereClause .= ' and (cat1 IS NULL OR cat1=\'\') ';	 
			if ($cat_tree[2])	
				$whereClause .= ' and cat2=' . $db->qstr($this->replace_spchars($cat_tree[2],1));	
			elseif ($this->onlyincategory)
			 	$whereClause .= ' and (cat2 IS NULL OR cat2=\'\') ';		   
			if ($cat_tree[3])	
				$whereClause .= ' and cat3=' . $db->qstr($this->replace_spchars($cat_tree[3],1));
			elseif ($this->onlyincategory)
				$whereClause .= ' and (cat3 IS NULL OR cat3=\'\') ';
		   		
			$sSQL .= $whereClause;
			$sSQL .= " and itmactive>0 and active>0";	
			$sSQL .= $this->orderSQL($order, $asc);
			/* ALL							
			if ((!$nopager) && ($this->pager)) {
				$p = $page * $this->pager;
				$sSQL .= " LIMIT $p,".$this->pager; //page element count
			}
		    */
			$resultset = $db->Execute($sSQL,2);
			$this->result = $resultset; 
			$this->max_items = $db->Affected_Rows();//count($this->result);
			
		    //$this->get_max_result(null, $filter);	
			$this->max_selection = $db->Affected_Rows();	
	      
			if ($this->max_items==1) 
				return ($this->result->fields[$this->fcode]); //to view the item without click on dir			
		}
		
		return null;
	}	
	
	/* xml read */
	protected function xmlread_list() {
        $db = GetGlobal('db');	 	
		$cat = GetReq('cat');				
		$xmlitems = GetReq('xml');		
		
	    $sSQL = $this->selectSQL;		
		$sSQL .= " WHERE ";	

		if ($cat!=null) {		   
		  
			$cat_tree = explode($this->sep(), $cat); 		  
		      	  
			if ($cat_tree[0])
				$whereClause .= ' cat0='.$db->qstr($this->replace_spchars($cat_tree[0],1));		
			elseif ($this->onlyincategory)
				$whereClause .= ' (cat0 IS NULL OR cat0=\'\') ';				  
			if ($cat_tree[1])	
				$whereClause .= ' and cat1='.$db->qstr($this->replace_spchars($cat_tree[1],1));	
			elseif ($this->onlyincategory)
				$whereClause .= ' and (cat1 IS NULL OR cat1=\'\') ';	 
			if ($cat_tree[2])	
				$whereClause .= ' and cat2='.$db->qstr($this->replace_spchars($cat_tree[2],1));	
			elseif ($this->onlyincategory)
			 	$whereClause .= ' and (cat2 IS NULL OR cat2=\'\') ';		   
			if ($cat_tree[3])	
				$whereClause .= ' and cat3='.$db->qstr($this->replace_spchars($cat_tree[3],1));
			elseif ($this->onlyincategory)
				$whereClause .= ' and (cat3 IS NULL OR cat3=\'\') ';
		   		
		}   
		$sSQL .= $whereClause ? $whereClause . " AND " : null;
		  
		$sSQL .= $xmlitems ? "xml=1 and itmactive>0 and active>0" : "itmactive>0 and active>0";		  		   
		$sSQL .= " ORDER BY ".$this->itmname .' '. $this->sortdef; //$this->orderid;

	    $this->result = $db->Execute($sSQL,2);
	}	
	
	protected function read_item($item_id=null) {
        $db = GetGlobal('db');	
		$item = $item_id ? $item_id : GetReq('id');
		$cat = GetReq('cat');
		$aliasID = _m("cmsrt.useUrlAlias");		
		
	    $sSQL = $this->selectSQL;	
		$sSQL .= " WHERE (" . $this->fcode . "=" . $db->qstr($item);
		//$sSQL .= ($this->codetype=='string') ? $db->qstr($item) : $item; //DISABLED
		//extra code (url alias)
		$sSQL .= ($aliasID) ? " OR {$aliasID}=" . $db->qstr($this->stralias($item)) : null;
		 
		$sSQL .= ") and itmactive>0 and active>0";
		
		if (($lock = $this->itemlockparam) && (!GetGlobal('UserID')))
		    $sSQL .=  ' and ' . $lock . ' is null';		  	  
	   
	    $sSQL .= " LIMIT 1";
	   
	    $resultset = $db->Execute($sSQL,2);
	    $this->result = $resultset; 	
 
        //update session last viewed items
        $vitems = (array) unserialize(GetSessionParam('lastvieweditems'));	   
		//store default item code
	    $vitems[] = ($aliasID) ? $resultset->fields[$this->fcode] : $item;
	    if (count($vitems)>12) 
			$itemout = array_shift($vitems);
	   	
	    SetSessionParam('lastvieweditems',serialize($vitems));	   
	   
	    //return ($resultset); 
		return ($resultset->fields[$this->fcode]); //real code	
	}

	protected function pPage($p, $label, $cmd, $inp=null, $div=null) {
	    $cat = GetReq('cat');
	    $pcmd = $cmd ? $cmd : $this->klistcmd;
		
		switch ($pcmd) {
			case 'ktree'  : $treeid = GetParam('treeid');
			                if ($this->filterajax) {
								$url = ($treeid) ? $this->httpurl . "/ktree/$cat/$treeid/$p/" :
												   _m("cmsrt.url use t={$this->klistcmd}&cat=$cat&page=$p");
								$ret = "<a href=\"javascript:void(0)\" onClick=\"ajaxCall('$url','{$this->pageName}',1)\">" . strval($label) . "</a>";
							}	
							else {
								//$ret = ($treeid) ? _m("cmsrt.url use t=$pcmd&cat=$cat&treeid=$treeid&page=$p+" . strval($label)) :
								//				   _m("cmsrt.url use t={$this->klistcmd}&cat=$cat&page=$p");
								$url = ($treeid) ? $this->httpurl . "/ktree/$cat/$treeid/$p/" :
													_m("cmsrt.url use t={$this->klistcmd}&cat=$cat&page=$p");
								$ret = "<a href=\"$url\" onClick=\"gotoTop('{$this->pageName}')\">" . strval($label) . "</a>";
							}					   
			                break;
							
			case 'kfilter': if ($this->filterajax) {
								$url = $this->httpurl .'/';
								$url.= ($inp) ? _m("cmsrt.url use t=$pcmd&cat=$cat&input=$inp&page=$p") :
												_m("cmsrt.url use t={$this->klistcmd}&cat=$cat&page=$p");
								$ret = "<a href=\"javascript:void(0)\" onClick=\"ajaxCall('$url','{$this->pageName}',1)\">" . strval($label) . "</a>";
							}
							else {
								//$ret = ($inp) ? _m("cmsrt.url use t=$pcmd&cat=$cat&input=$inp&page=$p+" . strval($label)) :
								//				_m("cmsrt.url use t={$this->klistcmd}&cat=$cat&page=$p");
												
								$url = $this->httpurl .'/';
								$url.= ($inp) ? _m("cmsrt.url use t=$pcmd&cat=$cat&input=$inp&page=$p") :
												_m("cmsrt.url use t={$this->klistcmd}&cat=$cat&page=$p");
								$ret = "<a href=\"$url\" onClick=\"gotoTop('{$this->pageName}')\">" . strval($label) . "</a>";					
							}					
							break;
							
			case 'filter' : 
			case 'search' : if (($p>0) && ($this->filterajax) && (!$this->mobile)) {
								//ajax paging
								$url = $this->httpurl .'/';
								$url.= ($inp) ? _m("cmsrt.url use t=$pcmd&input=$inp&cat=$cat&page=$p") :
												_m("cmsrt.url use t={$this->klistcmd}&cat=$cat&page=$p");
								$ret = "<a href=\"javascript:void(0)\" onClick=\"ajaxCall('$url','{$this->pageName}',1)\">" . strval($label) . "</a>";
							}
							else {
								//$ret =  ($inp) ? _m("cmsrt.url use t=$pcmd&input=$inp&cat=$cat&page=$p+" . strval($label)) :
								//				 _m("cmsrt.url use t={$this->klistcmd}&cat=$cat&page=$p");
												 
								$url = $this->httpurl .'/';
								$url.= ($inp) ? _m("cmsrt.url use t=$pcmd&input=$inp&cat=$cat&page=$p") :
												_m("cmsrt.url use t={$this->klistcmd}&cat=$cat&page=$p");
								$ret = "<a href=\"$url\" onClick=\"gotoTop('{$this->pageName}')\">" . strval($label) . "</a>";												 
							}					 
			                break;
			default       : if (($p>0) && ($this->filterajax) && (!$this->mobile)) {
								//ajax paging
								$url = $this->httpurl .'/';
								$url.= _m("cmsrt.url use t=$pcmd&cat=$cat&page=$p");
								$ret = "<a href=\"javascript:void(0)\" onClick=\"ajaxCall('$url','{$this->pageName}',1)\">" . strval($label) . "</a>";
							}
							else {
								//$ret = _m("cmsrt.url use t=$pcmd&cat=$cat&page=$p+" . strval($label));
								
								$url = $this->httpurl .'/';
								$url.= _m("cmsrt.url use t=$pcmd&cat=$cat&page=$p");
								$ret = "<a href=\"$url\" onClick=\"gotoTop('{$this->pageName}')\">" . strval($label) . "</a>";
							}	
		}
		
		return ($ret);
	}
	
	protected function show_paging($pagecmd=null,$mytemplate=null,$nopager=null) {
	    if ($nopager) return;
		$next = null;
		$prev = null;
		 
	    $cat = GetReq('cat'); // asis	
		$inp = GetParam('input');
	    $t = $inp ? 'search' : GetReq('t'); 	
	    $page = GetReq('page') ? GetReq('page') : 0;
	    $pager = GetReq('pager') ? GetReq('pager') : $this->pager;
	    $pcmd = $pagecmd ? $pagecmd : $this->klistcmd;
		
	    //echo '|paging>',$this->max_items,':',$this->max_selection;
	    $mp = $this->max_selection;
	    $max_page = floor($mp/$this->pager);//<<<<<<<<<<<<<<<-1;	 plus ceil  
	    //echo $max_page.">>>>".$mp.">>>>".$this->pager;
	    $cutter = 2;//5	 
	   
	    if ($mp<=$pager) return; 

		$tmplcontents = _m('cmsrt.select_template use fppager-button');
	   
	    if ($page < $max_page) {//&& ($mp<$pager)) { 

			//next pages
			$m = 0;
			for($p=$page+1 ; $p<$max_page ; $p++) {
				if ($m<$cutter) {
					$next_page_no = $this->pPage($p, $p+1, $pcmd, $inp);
					$next .= $this->combine_tokens($tmplcontents, array(0=>'',1=>$next_page_no));
				}
				$m+=1;
			}	   
			if (($next) && (!$tmplcontents)) $next .= "|";
			$next_label = $this->pPage($page+1, '&gt;', $pcmd, $inp);
			$next .= $this->combine_tokens($tmplcontents, array(0=>'',1=>$next_label));
		}
	    
	    if ($page>0) {
			$prev_label = $this->pPage($page-1, '&lt;', $pcmd, $inp);
			$prev = $this->combine_tokens($tmplcontents, array(0=>'',1=>$prev_label));	
		 
			//prev pages
			$m = $page-$cutter;
			for($p=0 ; $p<$page ; $p++) {
				if ($p>=$m) {
					$prev_page_no = $this->pPage($p, $p+1, $pcmd, $inp);
					$prev .= $this->combine_tokens($tmplcontents, array(0=>'',1=>$prev_page_no));
				}
			}  
	    }
		
	    $cpnum = $page+1;
		$currentpage = ($this->mobile) ? 
						"<a href=\"javascript:window.scrollTo(0,parseInt($('#{$this->pageName}').offset().top),10)\">$cpnum</a>" :
						"<a href=\"javascript:gotoTop('{$this->pageName}')\">$cpnum</a>";
	    $current = $this->combine_tokens($tmplcontents, array(0=>"class='{$this->pager_current_class}'" ,1=>$currentpage));   
	
	    $page_titles = $prev . $current . $next;	  	
        //$contents = $this->select_template('fppager');
		$contents = _m('cmsrt.select_template use fppager');	
	    $ret = $this->combine_tokens($contents, array(0=>$page_titles),true);	
	   
	    return ($ret);
	}	

	protected function pSortUrl($pOrder) {
	    $cat = GetReq('cat');   
		if ((isset($_POST['input'])) || ((isset($_GET['input'])) && (GetReq('t')=='search'))) 
			$cmd = 'search';
		elseif ((isset($_GET['input'])) && (GetReq('t')=='filter')) 
			$cmd = 'filter';
		elseif ((isset($_GET['input'])) && (GetReq('t')=='kfilter')) 
			$cmd = 'kfilter';
		elseif ((isset($_GET['treeid'])) && (GetReq('t')=='ktree')) 
			$cmd = 'ktree';			
		else
			$cmd = GetReq('t');	
		
		//$cmd = GetParam('input') ? 'search' : GetReq('t');
		$pcmd = $cmd ? $cmd : $this->klistcmd;		
		
		switch ($pcmd) {	
		
            case 'ktree' : 	$treeid = GetParam('treeid'); 
							$ret = _m("cmsrt.seturl use t=$pcmd&cat=$cat&treeid=$treeid&$pOrder=#+++1");				   	
							break;
			case 'kfilter': $kfilter = GetParam('input');
							$ret = _m("cmsrt.seturl use t=$pcmd&cat=$cat&input=$kfilter&$pOrder=#+++1");	
							break;		
            case 'search':  
			case 'filter': 	$inp = GetParam('input');
			                $ret = _m("cmsrt.seturl use t=$pcmd&input=$inp&cat=$cat&$pOrder=#+++1");
							break;	
			
			case 'products':
			case 'klist' :
		    default      : 	$ret = _m("cmsrt.seturl use t=$pcmd&cat=$cat&$pOrder=#+++1");		
		}
		return ($ret);
	}	
	
	public function show_asceding($cmd=null,$mytemplate=null,$style=null,$notview=null) {
		if ($notview) return;
	   
		$cat = GetReq('cat');
		$inp = GetParam('input');
		$t = $inp ? 'search' : GetReq('t');   
		$cmd = $t ? $t : ($cmd ? $cmd : $this->klistcmd);
		$pager = GetReq('pager') ? SetSessionParam('pager',GetReq('pager')) : GetSessionParam('pager');
		$asc = GetReq('asc') ? SetSessionParam('asc',GetReq('asc')) : GetSessionParam('asc');
		$order = GetReq('order') ? SetSessionParam('order',GetReq('order') ) : GetSessionParam('order');				
		
		$a = localize('_title', $this->lan);
		$b = localize('_axia', $this->lan);
		$c = localize('_code', $this->lan);	   
		$d = localize('_ORDERID', $this->lan);	
		$e = localize('_MANUFACTURER', $this->lan);	
		$f = localize('_NEWEST', $this->lan);			
		
		$data = array(1=>$a,2=>$b,3=>$c,4=>$d,5=>$e,6=>$f);
		$do = $this->deforder ? $this->deforder : 1; //3 : 1

		$url = $this->pSortUrl('order');	
		$selected_order = GetReq('order') ? GetReq('order') : 
				(GetSessionParam('order') ? GetSessionParam('order') : $do);
		$combo_char = $this->make_combo($url,$data,null,$selected_order,$style);
	   	      	   		   
		//asc/desc
		$a = localize('_asc', $this->lan);
		$b = localize('_desc', $this->lan);
		$data = array(1=>$a,2=>$b);
		$da = ($this->defasc<0) ? 2 : 1;

		$url = $this->pSortUrl('asc');
		$selected_asc = GetReq('asc') ? GetReq('asc') : 
				(GetSessionParam('asc') ? GetSessionParam('asc') : $do);   
		$combo_asceding = $this->make_combo($url,$data,null,$selected_asc,$style);
	   
		//pager
		//$max = $this->max_selection;
        $data2 = array();  	
	    for ($i=1;$i<4;$i++) {
			$n = ($this->default_pager * $i);
			$data2[$n] = localize('_array',$this->lan).' '.$n;
        }		  

		$url = $this->pSortUrl('pager');	
	    $combo_pager = $this->make_combo($url,$data2,null,$this->pager,$style);
	   	  		    	   	   		 	      
	    //$contents = $this->select_template('fpsort');
		$contents = _m('cmsrt.select_template use fpsort');
		$tokens = array(0=>localize('_order',$this->lan), 1=>$combo_char, 2=>$combo_asceding, 3=>$combo_pager);
	    $out = $this->combine_tokens($contents, $tokens, true);	     
	   
	   return ($out);	      
	}	

	public function show_filtering($pagecmd=null,$mytemplate=null) {	
	    $pcmd = $pagecmd ? $pagecmd : $this->klistcmd;
		$_searchphrase = localize('_SEARCH', $this->lan);
		$_pricephrase = localize('_pricerange', $this->lan);	
		$cat = (GetReq('cat')==$this->_catAllFilter) ? null : GetReq('cat'); 
		$_allF = (defined("SHKATEGORIES_DPC")) ? _v('shkategories._catAllSearch') : $this->_catAllFilter;
		
		$input = GetReq('input');		
		if (!$input) return null; //exit when no filter (search is of type search/xx/ 2nd elemend !!!!
		
		$tmplcontents = _m('cmsrt.select_template use fpfilter-button');	
		
		if (strstr($input, ',')) {
			//multiple values
			$fltvalue = null;
			$fl = explode(',', $input);
			foreach ($fl as $feaf) {
				if (strstr($feaf, ':')) {
					$_hv = explode(':', $feaf);
					$fltname = $_hv[0];
					$fbutton = "<a href=\"javascript:void(0)\" onClick=\"remFilter('{$feaf}','{$this->pageName}')\">{$_hv[1]}</a>";						
					$filters .= $this->combine_tokens($tmplcontents, array(0=>"class='{$this->pager_current_class}'" ,1=>$fbutton)); 
				}
				elseif (strstr($feaf, '.')) {// if (is_numeric($feaf)) { //get the last element numeric of array (DO NOT SAVE AS ARRAY)
					$_f = $this->read_policy();
					$_prices = explode('.', $feaf);
					$x = $this->spt($_prices[0]);
					$y = $this->spt($_prices[1]);
					$title = $_pricephrase . ': ' . $x .'..'. $y .' &euro;';					
					$fbutton = "<a href=\"javascript:void(0)\" onClick=\"remFilter('{$feaf}','{$this->pageName}')\">{$title}</a>";						
					$filters .= $this->combine_tokens($tmplcontents, array(0=>"class='{$this->pager_current_class}'" ,1=>$fbutton));					
				}
				else {//if ($feaf) 
				    $title = $_searchphrase . ': ' . $feaf;
					$fbutton = "<a href=\"javascript:void(0)\" onClick=\"remFilter('{$feaf}','{$this->pageName}')\">{$title}</a>";		
					$filters .= $this->combine_tokens($tmplcontents, array(0=>"class='{$this->pager_current_class}'" ,1=>$fbutton));
				}	
			}
		}
		else {//if ($input) {//single value
			if (strstr($input, ':')) { //single pair value
				$_hv = explode(':', $input);
				$fltname = $_hv[0];
				$fbutton = "<a href=\"javascript:void(0)\" onClick=\"remFilter('{$input}','{$this->pageName}')\">{$_hv[1]}</a>";	
				$filters .= $this->combine_tokens($tmplcontents, array(0=>"class='{$this->pager_current_class}'" ,1=>$fbutton));					
			}
			elseif (strstr($input, '.')) {////if (is_numeric($input)) { //single numeric value (slider values)
				$_f = $this->read_policy();
				$_prices = explode('.', $input);
				$x = $this->spt($_prices[0]);
				$y = $this->spt($_prices[1]);
				$title = $_pricephrase . ': ' . $x .'..'. $y .' &euro;';
				$fbutton = "<a href=\"javascript:void(0)\" onClick=\"remFilter('{$input}','{$this->pageName}')\">{$title}</a>";					
				$filters .= $this->combine_tokens($tmplcontents, array(0=>"class='{$this->pager_current_class}'" ,1=>$fbutton));		 
			}			
			elseif ($input!=$_allF) {//non * single searchable value (save-reset except * from categories)
				$title = $_searchphrase . ': ' . $input;
				$fbutton = "<a href=\"javascript:void(0)\" onClick=\"remFilter('{$input}','{$this->pageName}')\">{$title}</a>";		
				$filters .= $this->combine_tokens($tmplcontents, array(0=>"class='{$this->pager_current_class}'" ,1=>$fbutton));
			}
			else {
				$title = null;
				$fbutton = null;
			}				
        }			    	

		if ($filters) {
			$contents = _m('cmsrt.select_template use fpfiltering');	
			$ret = $this->combine_tokens($contents, array(0=>$filters),true);	
			
			return ($ret);
		}
		
		return null;
	}	
	
	public function list_katalog($linemax=null,$cmd=null,$template=null,$photosize=null,$nopager=null) {
	    $cmd = $cmd ? $cmd : $this->klistcmd;
	    $pz = $photosize ? $photosize : 1;		   	
        $cat = GetReq('cat');   
	    $custom_template = false;
	    $ogImage = array();
		$toprint = null;

	    $mylinemax = ($linemax>0) ? $linemax : $this->linemax;   
		
        if ($template) {  /*custom template list*/
			$custom_template = true;
			$tmpl = explode('.',$template);
			$mytemplate = $this->select_template($tmpl[0],$cat);		
	    }
	    else { /*katalog list*/
			//default template
			$mytemplate = $this->select_template('fpkatalog',$cat);		
			//list-table alternative template
			$mytemplate_alt = $this->select_template('fpkatalog-alt',$cat);
	    }
   
		if ((!empty($this->result->fields)) &&
		    (count($this->result->fields)>1)) {

			$aliasID = _m("cmsrt.useUrlAlias");
			$aliasExt = _v("cmsrt.aliasExt");
			
			$pp = $this->read_policy(); 
			
			foreach ($this->result as $n=>$rec) {
		
				$mem = memory_get_peak_usage(true);//memory_get_usage();
				$tokens = array(); //reset
				$tokens = $this->tokenizeRecord($rec, $pp, true, $aliasID, $pz);
			  
				if (!$custom_template) {
					$items_grid[] = $this->combine_tokens($mytemplate, $tokens, true);
					$items_list[] = $this->combine_tokens($mytemplate_alt, $tokens, true);		  
				}
				else
					$items_custom[] = $this->combine_tokens($mytemplate, $tokens, true);
			
				//$ogimage[] = $tokens[14]; //1st page list of images DISABLE ARRAY
				//unset($tokens); //use last tokens set at og			  	 				   	   	   	
			}//foreach 
			$ogimage[] = $tokens[14]; //last image only 
		  
			if (!$custom_template) { 
				if (($mytemplate) && ($mytemplate_alt)) 	
					$toprint .= $this->make_table_list($items_grid, $items_list, 'fpkatalogtable', 'fpkataloglist', $cat);			
				else
					$toprint .= $this->make_table($items, $mylinemax, 'fpkatalogtable', $cat);	  
			  
				$toprint .= $this->show_paging($cmd,$mytemplate,$nopager);
				$toprint .= $this->show_filtering($cmd,$mytemplate);
	
				$caturl = $aliasID ? $this->httpurl .'/' . $cat . $aliasExt : $this->httpurl .'/'.$this->klistcmd.'/'. $cat . '/';
				$catarray = explode($this->sep(), $tokens[17]);
				$this->ogTags = $this->openGraphTags(array(0=>$this->siteTitle,
														1=>array_pop($catarray),
														2=>$tokens[17],														
														3=>$caturl,
														4=>$ogimage, /*array of images*/
													));	
				/* js ref analytics */ 
				$cmdtype = ($cmd==$this->klistcmd) ? 'category' : 'searchresults';
				$this->analytics(/*$this->klistcmd*/ 'klist' , array(0=>$this->siteTitle,
														1=>array_pop($catarray),
														2=>$tokens[17],														
														3=>$caturl,
														4=>$cmdtype,
													));									
			}	
			else //custom template
				$toprint .= (!empty($items_custom)) ? implode('',$items_custom) : null;
             		  
	    }//empty result
		else {
			if ($template = _m('cmsrt.select_template use emptyrecs')) {
				
				$filters = $this->show_filtering();
				$msg = localize('_norec',$this->lan);
				
				$tokens = array(0=>$msg, 1=>$filters);
				$toprint .= $this->combine_tokens($template, $tokens, true);
			}
			//else
				//$toprint .= localize('_norec',$this->lan);			
		}

	    return ($toprint);	
	}	
	
	//api version
	public function list_katalog_api($linemax=null,$cmd=null) {
	    $cmd = $cmd ? $cmd : $this->klistcmd;
	    $pz = $photosize ? $photosize : 1;		   	
        $cat = GetReq('cat');   
	    $custom_template = false;
	    $ogImage = array();

		if ((!empty($this->result->fields)) &&
		    (count($this->result->fields)>1)) {

			$aliasID = _m("cmsrt.useUrlAlias");
			$aliasExt = _v("cmsrt.aliasExt");
			
			$pp = $this->read_policy(); 
			
			foreach ($this->result as $n=>$rec) {
				//$mem = memory_get_peak_usage(true);//memory_get_usage();
				$tokens[$n] = $this->tokenizeRecordApi($rec, $pp, true, $aliasID, $pz);	  	 				   	   	   	
			}//foreach 
		    //print_r($tokens[0]); //test

			$caturl = $aliasID ? $this->httpurl .'/' . $cat . $aliasExt : $this->httpurl .'/'.$this->klistcmd.'/'. $cat . '/';
			$catarray = explode($this->sep(), $tokens[0]['category']);
			$this->ogTags = $this->openGraphTags(array(0=>$this->siteTitle,
													1=>array_pop($catarray),
													2=>$tokens[0]['category'],														
													3=>$caturl,
													4=>$this->httpurl . $this->get_photo_url($rec[$this->fcode],2), //$ogimage, /*array of images*/
													));	
			/* js ref analytics */ 
			/*$cmdtype = ($cmd==$this->klistcmd) ? 'category' : 'searchresults';
			$this->analytics('klist' , array(0=>$this->siteTitle,
													1=>array_pop($catarray),
													2=>$tokens[17],														
													3=>$caturl,
													4=>$cmdtype,
												));	
			*/									

            return ($tokens);  		  
	    }

	    return null; 

	}		
	
	
    protected function list_katalog_table($linemax=2,$cmd=null,$template=null,$photosize=null,$nopager=null) {
		$cmd = $cmd ? $cmd : $this->klistcmd;	   
		$pz = $photosize ? $photosize : 1;
		$cat = GetReq('cat');	   
		$mylinemax = ($linemax>0) ? $linemax : $this->linemax; 	
		
		$mytemplate = $this->select_template($template,$cat);
		
		if (!empty($this->result)) {
	   
	        $aliasID = _m("cmsrt.useUrlAlias");
			$pp = $this->read_policy();
	
			foreach ($this->result as $n=>$rec) {
		
				$mem = memory_get_peak_usage(true);//memory_get_usage();
				
				$tokens = $this->tokenizeRecord($rec, $pp, true, $aliasID, $pz);				
				$items[] = $this->combine_tokens($mytemplate, $tokens, true);	
				unset($tokens);													 
		   
			}//foreach	
	   
			//make table			
			$ret .= $this->make_table($items, $mylinemax, 'fpkatalogtable', $cat);  	  
	      				
			//if ($this->pager) 
			$ret .= $this->show_paging($cmd,$mytemplate,$nopager);					
	    }	   
   
		return ($ret);	
    } 
	
	protected function show_item($template=null,$no_additional_info=null,$lang=null,$lnktype=1,$pcat=null,$boff=null,$tax=null) {
	    $cat = $pcat ? $pcat : GetReq('cat'); 	
        $page = GetReq('page') ? GetReq('page') : 0;		
	    $id = GetReq('id');
	    $ogimage = array();
	   
	    $mytemplate = $this->select_template('fpitem',$cat);	 
	   
	    if (count($this->result->fields)>1) {	
	   
		 $pp = $this->read_policy();	   
		 
		 //url alias or canonical	
		 $aliasID = _m("cmsrt.useUrlAlias");		
	   
		 foreach ($this->result as $n=>$rec) {
			 
			$tokens = $this->tokenizeRecordItem($rec, $pp, true, $aliasID, 2, false);			
			//print_r($tokens);
			
		 	if ($itmpl = $rec['template']) {
				
				$this_item_template = _m('cmsrt.select_template use ' . $this->itmplpath . $itmpl);
				$out = $this->combine_tokens($this_item_template, $tokens, true);
			}	
			else			 
				$out = $this->combine_tokens($mytemplate, $tokens, true);
			 
			$ogimage[] = $this->get_photo_url($rec[$this->fcode],2);
			 
			$this->ogTags = $this->openGraphTags(array(0=>$this->siteTitle,
													1=>$tokens[0],
													2=>$tokens[1] ?? $tokens[0],		
													3=>$tokens[14],
													4=>$tokens[18], 
													));				 
			/* js ref analytics */ 
			$this->analytics(/*$this->kshowcmd*/ 'kshow', $tokens);
			
			unset($tokens);	 
		 }//foreach	   
	    }//if recs
	    else {
			if ($this->itemlockparam) 
				$out = ($goto = $this->itemlockgoto) ? _m($goto) : localize('_lockrec',$this->lan);
			else { 
				if ($template = _m('cmsrt.select_template use emptyrec')) {
				
					$tokens = array(0=>localize('_norec',$this->lan));
					$out = $this->combine_tokens($template, $tokens, true);
				}
				else
					$out = localize('_norec',$this->lan);
			}	
	    }	   
  	   
	    return ($out);	
	}		
	
	protected function show_item_api() {
	    $cat = $pcat ? $pcat : GetReq('cat'); 	
        $page = GetReq('page') ? GetReq('page') : 0;		
	    $id = GetReq('id');
	    $ogimage = array();
		$out = null;
 
	    if (count($this->result->fields)>1) {	
	   
			$pp = $this->read_policy();	   
		 
			//url alias or canonical	
			$aliasID = _m("cmsrt.useUrlAlias");		
	   
			foreach ($this->result as $n=>$rec) {
			 
				$tokens[$n] = $this->tokenizeRecordItemApi($rec, $pp, true, $aliasID, 2, false);			
				//print_r($tokens); //test
			 
				//$ogimage[] = $this->get_photo_url($rec[$this->fcode],2);
			 
				$this->ogTags = $this->openGraphTags(array(0=>$this->siteTitle,
													1=>$tokens[0]['itmname'],
													2=>$tokens[0]['itmdescr'] ? $tokens[0]['itmdescr'] : $tokens[0]['itmname'],														
													3=>$tokens[0]['itmurl'],
													4=>$tokens[0]['photo2'], 
													));				 
				/* js ref analytics */ 
				//$this->analytics('api', $tokens);
				
			}//foreach	   
			
		 	return ($tokens); //one item in list always
	    }//if recs
  	   
	    return null;	
	}	
	

    //overrided
	public function show_aditional_files($id,$nojs=null,$altname=null,$tmpl=null) {
	    if (!$id) return;
	    $cat = GetReq('cat');
		$name = $this->replace_spchars($id,1);
		$title = $altname ? $altname : $name;
		$id = $this->encode_image_id($id); //_m('shkategories.encode_image_id use '.$id);
		 
	    $addfx = $this->addfx ? $this->addfx : 100;
	    $addfy = $this->addfy ? $this->addfy : null;//free y size //75;	
	    $this->allow_show_resource = true; //enable it after show main item image		
	
	    $template= $tmpl ? $tmpl : 'fpitemaddfiles';	    	
		//$mytemplate = $this->select_template($template);
		$mytemplate = _m("cmsrt.select_template use $template");
         
        $slide_index = 1; //start at 1, 1=main image 		 
		//multiple images
		for($i='A';$i<='Z';$i++) {
		 
			$slide_index+=1;		 
		   
			foreach ($this->advrestype as $restype) { 
			//work with uphoto path only......
		   	   
			$ad_photo_big = $this->imgpath .  $id . $i . $restype;
			$aditional_pic_file = $this->urlpath .'/'. $this->imgpath . $id . $i . $restype;

			if (file_exists($aditional_pic_file)) {//echo $aditional_pic_file,'<br/>';

				switch ($restype) {
                
					default:$addtional_photo_link = _m("cmsrt.seturl use t={$this->kshowcmd}&cat=$cat&id=" . $this->realID . "&thub=" . $i . "#photo+++1"); 
			                $plink = "<a href=\"$addtional_photo_link\">";				  
			                $lo = "<img src=\"" . $ad_photo_big . "\" border=\"0\" alt=\"". localize('_IMAGE',$this->lan) . "\">" . "</a>"; 
			                $adnphoto = $plink . $lo;
			 
			                $remarks = $title .'-' . $i;//'PHOTO';			 
							$tokens = array(0=>$id.$i,
											1=>$title,
											2=>$adnphoto,
											3=>$remarks,
											4=>$slide_index,
											5=>$ad_photo_big,
											6=>$slide_index-1,
											);
                            $items[] =  $this->combine_tokens($mytemplate,$tokens, true);

			 
				}//switch
			 			      			   
				break;   
		   }//file exists
		   }//foreach	 
		}//for		 
		 
	    $itemscount = (!empty($items)) ? count($items) : 0; 
		if (($itemscount>0) && ($this->additional_files_perline>1))	 
		   $out = $this->make_table($items, $this->additional_files_perline, 'fptreetable', $cat);	 
		else 
		   $out = (!empty($items)) ? implode('',$items) : null; //without table template 

		return ($out);		 
	}
	
	public function show_aditional_html_files($id) {	
        $db = GetGlobal('db');	
		$slan =  ($this->one_attachment) ? $slan : $this->lan; 
		 
	    $code = $this->fcode;	  
        $sSQL = "select data from pattachments ";
	    $sSQL .= " WHERE (type='.html' or type='.htm') and code='" . $id . "'";
	    if (isset($slan))
	       $sSQL .= " and lan=" . $slan;	
	  
	    $resultset = $db->Execute($sSQL,2);	
		$ret = $resultset->fields['data'];   
		 
		return ($ret);  		 
	}	
	
	
	public function show_p($items=10,$linemax=null,$template=null,$photosize=null,$p=null) {
        $db = GetGlobal('db');					
		$pz = $photosize ? $photosize : 1;		
	                                                                             
        $sSQL = $this->selectSQL;
		$sSQL .= " WHERE ";	
		
		if ($selected_item = $this->realID) 
		  $sSQL .= $this->fcode . " not like '" . $selected_item ."' and ";
		  		
		$sSQL .= $p." >0 and ".$p." IS NOT NULL and itmactive>0 and active>0";	
		$sSQL .= " ORDER BY {$this->orderid}";
		$sSQL .= $this->bypass_order_list ? null : 
		         ($this->orderid ? ",{$this->itmname} {$this->sortdef} " : "{$this->itmname} {$this->sortdef} ");
		$sSQL .= $items ? " LIMIT " . $items: null;			
		
	    $resultset = $db->Execute($sSQL,2);	
		$this->result = $resultset;	
		
		if ($linemax>1)
			$out = $this->list_katalog_table($linemax,null,$template,$pz,1);
		else  	
			$out = $this->list_katalog(0,null,$template,$pz,1);
		  
		return ($out);	
	}		
	
	public function show_lastentries($items=10,$linemax=null,$template=null,$photosize=null,$days=12,$nopager=null) {
        $db = GetGlobal('db');		
		$mydays = $days ? $days : 12;
	    $date2check = time() - ($mydays * 24 * 60 * 60);
	    $entrydate = date('Y-m-d',$date2check);
		$pz = $photosize ? $photosize : 1;			

        $sSQL = $this->selectSQL;
		$sSQL .= " WHERE ";	
		$sSQL .= "sysins>='" . convert_date(trim($entrydate),"-DMY",1) . "' and ";
		
		if ($selected_item = $this->realID) 
		  $sSQL .= $this->fcode . " not like '" . $selected_item ."' and ";
		  		
		$sSQL .= "itmactive>0 and active>0";	
		$sSQL .= " ORDER BY id desc LIMIT " . $items;			
	    //echo $sSQL;
		
	    $resultset = $db->Execute($sSQL,2);	
		$this->result = $resultset;		
		
		if ($linemax>1)
		  $out = $this->list_katalog_table($linemax,null,$template,$pz,$nopager);
		else  	
          $out = $this->list_katalog(0,null,$template,$pz,$nopager);
		  
		return ($out);	
	}		
	
	public function show_kategory_offers($items=10,$linemax=null,$template=null,$photosize=null,$category=null,$nopager=null) {
        $db = GetGlobal('db');			
		$c = $category ? $category : GetReq('cat');
		$cat = explode($this->sep(),$c);			
		$pz = $photosize ? $photosize : 1;		

        $sSQL = $this->selectSQL;
		$sSQL .= " WHERE ";	
		foreach ($cat as $i=>$c) {
		  $myc = $this->replace_spchars($c,1);
		  $sSQL .= " cat{$i}='$myc' and ";	
		}   
		
		if ($selected_item = $this->realID) 
		  $sSQL .= $this->getmapf('code') . " not like '" . $selected_item ."' and ";
		  		
		$sSQL .= $this->getmapf('offer')."='".$this->toggler[1]."' and itmactive>0 and active>0";	
		$sSQL .= " ORDER BY {$this->itmname} asc LIMIT " . $items;			
	    //echo $sSQL;
		
	    $resultset = $db->Execute($sSQL,2);	
		$this->result = $resultset;	
		
		if ($linemax>1)
		  $out = $this->list_katalog_table($linemax,null,$template,$pz,$nopager);
		else  	
          $out = $this->list_katalog(0,null,$template,$pz,$nopager);
		  
		return ($out);	
	}		
	
	public function show_pcat($items=10,$linemax=null,$template=null,$photosize=null,$p=null,$category=null) {
        $db = GetGlobal('db');		
		$mycat = $category ? $category : GetReq('cat');	   			
		$pz = $photosize ? $photosize : 1;			
	                                                                             
        $sSQL = $this->selectSQL;
		$sSQL .= " WHERE ";	
		
		$cat = explode($this->sep(),$mycat);		
		foreach ($cat as $i=>$c) {
		  $myc = $this->replace_spchars($c,1);		
		  $sSQL .= " cat{$i}='$myc' and ";	
		}  
		//only items inside category ..when category param not specified
	    if ((!$category) && ($this->onlyincategory)) {
		  $ii = $i+1;
		  $sSQL .= " (cat{$ii} IS NULL or cat{$ii}='') and ";		
		}  		
		  
		//MULTIPLE CHECKS  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
		if ($selected_cat0 = $fields['cat0']) 
		  $sSQL .= "cat0 not like '" . $selected_cat0 . "' and ";		  
		  	
		if ($selected_cat1 = $fields['cat1']) 
		  $sSQL .= "cat1 not like '" . $selected_cat1 . "' and ";		 
		  		  
		if ($selected_cat2 = $fields['cat2']) 
		  $sSQL .= "cat2 not like '" . $selected_cat2 . "' and ";
		  
		if ($selected_cat3 = $fields['cat3']) 
		  $sSQL .= "cat3 not like '" . $selected_cat3 . "' and ";		
		
		if ($selected_item = $this->realID) //GetReq('id')) 
		  $sSQL .= $this->fcode . " not like '" . $selected_item ."' and ";
		  		
		$sSQL .= $p." >0 and ".$p." IS NOT NULL and itmactive>0 and active>0";	
		$sSQL .= " ORDER BY {$this->orderid} ";
		$sSQL .= $this->bypass_order_list ? null : 
		         ($this->orderid ? ",{$this->itmname} {$this->sortdef} " : "{$this->itmname} {$this->sortdef} ");		
		$sSQL .= $items ? " LIMIT " . $items : null;			
	    //echo $sSQL,'<br>';
		
	    $resultset = $db->Execute($sSQL,2);	
		$this->result = $resultset;	
		
		if ($linemax>1)
		  $out = $this->list_katalog_table($linemax,null,$template,$pz,1);
		else  	
          $out = $this->list_katalog(0,null,$template,$pz,1);
		  
		return ($out);	
	}
	
	public function show_lastincat($items=10,$linemax=null,$template=null,$photosize=null,$category=null,$ascdesc=null) {
        $db = GetGlobal('db');		
		$mycat = $category ? $category : GetReq('cat');	   		
		$pz = $photosize ? $photosize : 1;		

        $sSQL = $this->selectSQL;
		$sSQL .= " WHERE ";	
		
		$cat = explode($this->sep(),$mycat);			
		foreach ($cat as $i=>$c) {
		  $myc = $this->replace_spchars($c,1);		
		  $sSQL .= " cat{$i}='$myc' and ";	
		}  
		//only items inside category ..when category param not specified
	    if ((!$category) && ($this->onlyincategory)) {
		  $ii = $i+1;
		  $sSQL .= " (cat{$ii} IS NULL or cat{$ii}='') and ";		
		}  		

		if ($selected_item = $this->realID) 
		  $sSQL .= $this->fcode . " not like '" . $selected_item ."' and ";
		  		
		$sSQL .= "itmactive>0 and active>0";	
		$mysort = ($ascdesc=='ASC') ? 'ASC' : 'DESC'; 
		$sSQL .= " ORDER BY datein " . $mysort;	
		$sSQL .= $items ? " LIMIT " . $items : null;			
		
	    $resultset = $db->Execute($sSQL,2);	
		$this->result = $resultset;	
		
		if ($linemax>1)
		  $out = $this->list_katalog_table($linemax,null,$template,$pz,1);
		else  	
          $out = $this->list_katalog(0,null,$template,$pz,1);
		  
		return ($out);	
	}		

	public function show_orderid($items=10,$linemax=null,$template=null,$photosize=null,$ascdesc=null,$category=null) {
        $db = GetGlobal('db');		
		$mycat = $category ? $category : GetReq('cat');	   		
		$pz = $photosize ? $photosize : 1;		

        $sSQL = $this->selectSQL;
		$sSQL .= " WHERE ";	
		
		$cat = explode($this->sep(),$mycat);			
		foreach ($cat as $i=>$c) {
		  $myc = $this->replace_spchars($c,1);		
		  $sSQL .= " cat{$i}='$myc' and ";	
		}  
		//only items inside category ..when category param not specified
	    if ((!$category) && ($this->onlyincategory)) {
		  $ii = $i+1;
		  $sSQL .= " (cat{$ii} IS NULL or cat{$ii}='') and ";		
		}  		
		
		//MULTIPLE CHECKS  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
		if ($selected_cat0 = $fields['cat0']) 
		  $sSQL .= "cat0 not like '" . $selected_cat0 . "' and ";		  
		  	
		if ($selected_cat1 = $fields['cat1']) 
		  $sSQL .= "cat1 not like '" . $selected_cat1 . "' and ";		 
		  		  
		if ($selected_cat2 = $fields['cat2']) 
		  $sSQL .= "cat2 not like '" . $selected_cat2 . "' and ";
		  
		if ($selected_cat3 = $fields['cat3']) 
		  $sSQL .= "cat3 not like '" . $selected_cat3 . "' and ";		
		
		if ($selected_item = $this->realID) 
		  $sSQL .= $this->fcode . " not like '" . $selected_item ."' and ";
		  		
		$sSQL .= "orderid >0 and orderid IS NOT NULL and itmactive>0 and active>0";	
		$mysort = $ascdesc ? ($ascdesc=='ASC'?'ASC':'DESC') : $this->sortdef; 
		$sSQL .= " ORDER BY orderid ";
		$sSQL .= $this->bypass_order_list ? null : ",{$this->itmname} $mysort ";	
		$sSQL .= $items ? " LIMIT " . $items : null;			
	    //echo $sSQL,'<br>';
		
	    $resultset = $db->Execute($sSQL,2);	
		$this->result = $resultset;	
		
		if ($linemax>1)
		  $out = $this->list_katalog_table($linemax,null,$template,$pz,1);
		else  	
          $out = $this->list_katalog(0,null,$template,$pz,1);
		  
		return ($out);	
	}	
	
	public function show_orderidis($items=10,$linemax=null,$template=null,$photosize=null,$orderid=null) {
        $db = GetGlobal('db');		
		$mycat = $category ? $category : GetReq('cat');	   			
		$pz = $photosize ? $photosize : 1;			

        $sSQL = $this->selectSQL;
		$sSQL .= " WHERE ";		
			
		$sSQL .= "orderid = $orderid and orderid IS NOT NULL and itmactive>0 and active>0";	
		$sSQL .= " ORDER BY orderid ";
		$sSQL .= $this->bypass_order_list ? null : ",{$this->itmname} {$this->sortdef} ";		
		$sSQL .= $items ? " LIMIT " . $items : null;			
	    //echo $sSQL,'<br>';
		
	    $resultset = $db->Execute($sSQL,2);	
		$this->result = $resultset;	
		
		if ($linemax>1)
		  $out = $this->list_katalog_table($linemax,null,$template,$pz,1);
		else  	
          $out = $this->list_katalog(0,null,$template,$pz,1);
		  
		return ($out);	
	}	
	
	public function show_resources($items=10,$linemax=null,$template=null,$photosize=null,$contition=null,$ofield=null,$desc=null) {
        $db = GetGlobal('db');					
		$pz = $photosize ? $photosize : 1;	
        $ordfield = $ofield ? $ofield : $this->itmname;
        $ascd = $desc ? "desc" : "asc"; 		

        $sSQL = $this->selectSQL;
		$sSQL .= " WHERE ";	
		
		if ($selected_item = $this->realID) 
		  $sSQL .= $this->fcode . " not like '" . $selected_item ."' and ";
		  		
		$sSQL .= $contition."='".$this->toggler[1]."' and itmactive>0 and active>0";	
		$sSQL .= " ORDER BY " . $ordfield . " ".  $ascd;
		$sSQL .= $items ? " LIMIT " . $items : null;			
	    //echo $sSQL,'<br>';
		
	    $resultset = $db->Execute($sSQL,2);	
		$this->result = $resultset;		
		
		if ($linemax>1)
		  $out = $this->list_katalog_table($linemax,null,$template,$pz,1);
		else  	
          $out = $this->list_katalog(0,null,$template,$pz,1);
		  
		return ($out);	
	}			
	 
	 
	public function show_group($items=10,$linemax=null,$template=null,$photosize=null,$group=null) {
        $db = GetGlobal('db');				
	    $date2check = time() - ($days * 24 * 60 * 60);
	    $entrydate = date('Y-m-d',$date2check);		
		$pz = $photosize ? $photosize : 1;	

        $sSQL = $this->selectSQL;
		$sSQL .= " WHERE ";	
		 
		$sSQL .= $this->fcode . " in (" . $group .")";  //coma sep codes
		  		
		$sSQL .= " and itmactive>0 and active>0";	
		$sSQL .= " ORDER BY {$this->orderid}";			
		$sSQL .= $this->bypass_order_list ? null : 
		         ($this->orderid ? ",{$this->itmname} {$this->sortdef} " : "{$this->itmname} {$this->sortdef} ");
		$sSQL .= $items ? " LIMIT " . $items : null;		 
	    //echo $sSQL;
		
	    $resultset = $db->Execute($sSQL,2);	
		$this->result = $resultset;		
		
		if ($linemax>1)
		  $out = $this->list_katalog_table($linemax,null,$template,$pz,1);
		else  	
          $out = $this->list_katalog(0,null,$template,$pz,1);
		  
		return ($out);	
	}	 
	
	/*side-select based on itmremark*/
	public function is_side_select($code=null) {	
		$db = GetGlobal('db');
		if ($incart = GetReq('a')) {
			$cc = explode(';', $incart);
			$itemcode = $cc[0];
        }
		else
			$itemcode = $code ? $code : $this->realID;
		
		if ($itemcode) {
			$sSQL0 = "select itmremark from products where {$this->fcode}='$itemcode'";
			$res = $db->Execute($sSQL0);	
			$ccitems = $res->fields[0];	
		
			return ($ccitems);
		}
	}		
	
	public function show_side_select($items=10,$linemax=null,$template=null,$photosize=null) {
        $db = GetGlobal('db');					
		$pz = $photosize ? $photosize : 1;
		
		if ($incart = GetReq('a')) {
			$cc = explode(';', $incart);
			$itemcode = $cc[0];
        }
		else
			$itemcode = $this->realID;

		if ($itemcode) {
			$sSQL0 = "select itmremark from products where {$this->fcode}='$itemcode'";
			$res = $db->Execute($sSQL0);	
			$ccitems = $res->fields[0];
			
			if ($ccitems) {
			
				$sSQL = $this->selectSQL;
				$sSQL .= " WHERE " . $this->fcode . 
						 " in ($ccitems)";  //coma sep codes
				$sSQL .= " and itmactive>0 and active>0";	
				$sSQL .= " ORDER BY {$this->orderid}";			
				$sSQL .= $this->bypass_order_list ? null : 
						 ($this->orderid ? ",{$this->itmname} {$this->sortdef} " : "{$this->itmname} {$this->sortdef} ");
				$sSQL .= $items ? " LIMIT " . $items : null;		 
				//echo $sSQL;
		
				$resultset = $db->Execute($sSQL,2);	
				$this->result = $resultset;		
		
				if ($linemax>1)
					$out = $this->list_katalog_table($linemax,null,$template,$pz,1);
				else  	
					$out = $this->list_katalog(0,null,$template,$pz,1);
		  
				return ($out);	
			}
		}

		if ($template = _m('cmsrt.select_template use emptyrec')) {
				
			$tokens = array(0=>'');//localize('_norec',$this->lan));
			$out = $this->combine_tokens($template, $tokens, true);
			return ($out);
		}		
	}	
	 
	//override
	public function show_special($items=10,$linemax=null,$template=null,$photosize=null,$contition=null,$days=12) {
        $db = GetGlobal('db');			
	    $date2check = time() - ($days * 24 * 60 * 60);
	    $entrydate = date('Y-m-d',$date2check);		
		$pz = $photosize ? $photosize : 1;	

        $sSQL = $this->selectSQL;				
		$sSQL .= " WHERE ";	
		
		if ($selected_item = $this->realID) 
		  $sSQL .= $this->fcode . " not like '" . $selected_item ."' and ";
		  		
		$sSQL .= $contition."='".$this->toggler[1]."' and itmactive>0 and active>0";	
		$sSQL .= " ORDER BY {$this->orderid}";			
		$sSQL .= $this->bypass_order_list ? null : 
		         ($this->orderid ? ",{$this->itmname} {$this->sortdef} " : "{$this->itmname} {$this->sortdef} ");
		$sSQL .= $items ? " LIMIT " . $items : null;		 
	    //echo $sSQL;
		
	    $resultset = $db->Execute($sSQL,2);	
		$this->result = $resultset;		
		
		if ($linemax>1)
		  $out = $this->list_katalog_table($linemax,null,$template,$pz,1);
		else  	
          $out = $this->list_katalog(0,null,$template,$pz,1);
		  
		return ($out);	
	}	
	
	public function show_special_online($items=10,$linemax=null,$template=null,$photosize=null,$field2check=null,$key=null) {
        $db = GetGlobal('db');
		$dbbuffer = GetGlobal('_sqlbuffer');		
		$pz = $photosize ? $photosize : 1;						
		$p = null;			
		$table2check = 'products';
		$fields = $this->result->fields;				
		
		if  ($p = GetReq($field2check)) {
		    $mode = 'uri';
	    } 
		elseif (($p = $fields[$field2check]) || (!empty($dbbuffer))) {//current query exist..default selection...querydepth = 0
		    $mode = 'query'; //already executed query			  
		}
		else {
		  if ($key) {//default mode for origin function...	
		    $mode = null; 	// default 
		    $p = str_replace('_SLASH_','/',str_replace('_COMMA_',',',str_replace('_AMP_','&',$key))); //get data from origin func		
		  }
		  else 
		    return;		
		}
				
        $sSQL = $this->selectSQL;
		$sSQL .= " WHERE (";	
		
		switch ($mode) {

		  case 'query':	$rbuf = array_reverse($dbbuffer);		  						
						$myselect = explode('products',$sSQL);	
						$a = trim($myselect[0]);	  
                        foreach ($rbuf as $bfid=>$bfdata) { 
			              $bfsql = explode('products',$bfdata['query']);//exclude where ..we want only select fields to be the same
						  $b = trim($bfsql[0]);
						  //echo '<br>',$bfid,'<br>',$b,':<br>',$a;						  
				          //if ($myselect[0]==$bfsql[0]) {//check identical queries
						  if (strcmp($a,$b)==0) {//check identical queries
                            //echo '<pre>';print_r($rbuf);echo '</pre>';						  
				            //echo '<br>TRUE<br>',$bfid,$bfdata['query'],'<br>',$myselect[0],'>>>>';
					        //override p val 
							//print_r($bfdata);
				            $p = $bfdata['data'][$field2check]; 
							$sp = str_replace('/','_SLASH_',str_replace(',','_COMMA_',str_replace('&','_AMP_',$p)));//url rewrite error '/'
                            $key = urlencode($sp);	//holds data pass as func origin arg								
							break;
				          }	
			            }						
						//$p = $rbuf[0]->data->$field2check;
		                $sSQL .= $field2check . "="  .(is_numeric($p)?$p:"'".$p."'"); 
		                break;
						
		  case 'uri'  :	$sSQL .= $field2check . "="  .(is_numeric($p)?$p:"'".$p."'");	  
		                break;	
		  
		  default     : $sSQL .= $field2check . "="  .(is_numeric($p)?$p:"'".$p."'");//arg special 
		                break;						
		} 
		
		//if ($advsql = $this->sql_search_relative_titles($fields[$this->itmdescr],'cat2'))
		  //$sSQL .= ' or ' . $this->fcode . ' in (' . $advsql . ')';		  		
		
		$sSQL .= ") and itmactive>0 and active>0";
		 	
		if ($selected_item = $this->realID) 
		  $sSQL .= " and " . $this->fcode . " not like '" . $selected_item . "'";
		  
		//MULTIPLE CHECKS  
		//if ($selected_cat = $fields['cat2']) 
		 // $sSQL .= " and " . "cat2 not like '" . $selected_cat . "'";	
	 
		$sSQL .= " ORDER BY {$this->orderid}";
		$sSQL .= $this->bypass_order_list ? null : 
		         ($this->orderid ? ",{$this->itmname} {$this->sortdef} " : "{$this->itmname} {$this->sortdef} ");		
		$sSQL .= $items ? " LIMIT " . $items : null;		
        //echo $mode;		
		
	    $resultset = $db->Execute($sSQL,2);	
		$this->result = $resultset;		
		
		if ($linemax>1)
		  $out = $this->list_katalog_table($linemax,null,$template,$pz,1);
		else  	
          $out = $this->list_katalog(0,null,$template,$pz,1);
		  		  
		return ($out);	
	}			
	
	//alias
	public function show_relatives($items=10,$linemax=null,$template=null,$photosize=null,$field2check=null,$key=null) {
	
      $ret = show_special_online($items,$linemax,$template,$photosize,$field2check,$key);	
	  return ($ret);
	}
	
	public function show_relative_sales($items=10,$linemax=null,$template=null,$photosize=null,$id=null) {
		$db = GetGlobal('db');	
		$myid = $id ? $id : $this->realID;		
		$pz = $photosize ? $photosize : 1;	  	    
	
		if ( (defined('SHTRANSACTIONS_DPC')) && (seclevel('SHTRANSACTIONS_DPC',decode(GetSessionParam('UserSecID')))) ) {

			$itemslist = _m('shtransactions.getRelativeSales use '.$items.'+'.$myid);
			//print_r($itemslist); //echo 'z';
		 
			if (!empty($itemslist)) {
		 
				$sSQL = $this->selectSQL;
				$sSQL .= " WHERE (";	
		
				foreach ($itemslist as $i=>$code)
					$preSQL[] = $this->fcode . " = '" . $code ."'";
			 
				$sSQL .= implode(' or ',$preSQL);
		  		
				$sSQL .= ") and itmactive>0 and active>0";	
				$sSQL .= " ORDER BY {$this->orderid} ";			
				$sSQL .= $this->bypass_order_list ? null : 
								($this->orderid ? ",{$this->itmname} {$this->sortdef} " : "{$this->itmname} {$this->sortdef} ");		
				$sSQL .= $items ? " LIMIT " . $items : null;
				//echo $sSQL;
		
				$resultset = $db->Execute($sSQL,2);	
				$this->result = $resultset;		
		
				if ($linemax>1)
					$out = $this->list_katalog_table($linemax,null,$template,$pz,1);
				else  	
					$out = $this->list_katalog(0,null,$template,$pz,1);
			}	 		 		 
		}
		return ($out);  
	}
	
	public function show_kategory_items($items=10,$linemax=null,$template=null,$photosize=null, $category=null,$xor=null) {
        $db = GetGlobal('db');			
		$mycat = $category ? $category : GetReq('cat');		   
		$cat = explode($this->sep(),$mycat);		
		$pz = $photosize ? $photosize : 1;		
				
		//auto browse current cat
		$fields = $this->result->fields; //prev query exclude cat
		
	    $sSQL = $this->selectSQL;
		$sSQL .= " WHERE ";	
		
		foreach ($cat as $i=>$c) {
			$myc = $this->replace_spchars($c,1);		
			$sSQL .= " cat{$i}='$myc' and ";	
		}  
		//only items inside category ..when category param not specified
	    if ((!$category) && ($this->onlyincategory)) {
			$ii = $i+1;
			$sSQL .= " (cat{$ii} IS NULL or cat{$ii}='') and ";		
		}  		
		
		if (($selected_item = $this->realID) && (!$xor)) 
			$sSQL .= $this->fcode . " not like '" . $selected_item ."' and ";
		  
		//MULTIPLE CHECKS  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
		if ($selected_cat0 = $fields['cat0']) 
			$sSQL .= "cat0 not like '" . $selected_cat0 . "' and ";		  
		  	
		if ($selected_cat1 = $fields['cat1']) 
			$sSQL .= "cat1 not like '" . $selected_cat1 . "' and ";		 
		  		  
		if ($selected_cat2 = $fields['cat2']) 
			$sSQL .= "cat2 not like '" . $selected_cat2 . "' and ";
		  
		if ($selected_cat3 = $fields['cat3']) 
			$sSQL .= "cat3 not like '" . $selected_cat3 . "' and ";
		  		  		  
		  
		$sSQL .= "itmactive>0 and active>0";	
		$sSQL .= " ORDER BY {$this->orderid}";	
		$sSQL .= $this->bypass_order_list ? null : 
		         ($this->orderid ? ",{$this->itmname} {$this->sortdef} " : "{$this->itmname} {$this->sortdef} ");		
		$sSQL .= $items ? " LIMIT " . $items : null;			
	    //echo $sSQL;
		
	    $resultset = $db->Execute($sSQL,2);	
		$this->result = $resultset;	
		
		if ($linemax>1) 
			$out = $this->list_katalog_table($linemax,null,$template,$pz,1);
		else  	
			$out = $this->list_katalog(0,null,$template,$pz,1); 
		  
		return ($out);	
	}		
	
	public function show_offers($items=10,$linemax=null,$template=null,$photosize=null,$cat=null) {
        $db = GetGlobal('db');				
		$pz = $photosize ? $photosize : 1;			

        $sSQL = $this->selectSQL;
		$sSQL .= " WHERE ";	

		if ($cat) {
			$c = explode($this->sep(), $this->replace_spchars($cat,1)); //print_r($cat);
			foreach ($c as $cc=>$category)
				$sSQL .= "cat".$cc."='" . $category . "' and ";
	    }
		
		if ($selected_item = $this->realID) 
		  $sSQL .= $this->fcode . " not like '" . $selected_item ."' and ";
		  		
		$sSQL .= $this->getmapf('offer')."='".$this->toggler[1]."' and itmactive>0 and active>0";	
		$sSQL .= " ORDER BY ". "{$this->orderid}";			
		$sSQL .= $this->bypass_order_list ? null : 
		         ($this->orderid ? ",{$this->itmname} {$this->sortdef} " : "{$this->itmname} {$this->sortdef} ");		
		$sSQL .= $items ? " LIMIT " . $items : null;			
	    //echo $sSQL;
		
	    $resultset = $db->Execute($sSQL,2);	
		$this->result = $resultset;		
		
		if ($linemax>1)
			$out = $this->list_katalog_table($linemax,null,$template,$pz,1);
		else  	
			$out = $this->list_katalog(0,null,$template,$pz,1);
		  
		return ($out);	
	}	
	
	public function show_menu_items($items=10,$linemax=null,$template=null,$photosize=null,$menu=null) {
        $db = GetGlobal('db');	
		$pz = $photosize ? $photosize : 1;	
		$out = null;	
		
		if (defined('CMSMENU_DPC')) {
			
			$list = _m('cmsmenu.readMenuElements use ' . $menu);
			if (empty($list)) return null;
			$menulist = implode("','",$list);
			
			$sSQL = $this->selectSQL;
			$sSQL .= " WHERE ";	
			$sSQL .= $this->fcode . " in ('". $menulist ."') and itmactive>0 and active>0";
			$sSQL .= " ORDER BY FIELD({$this->fcode}, '". $menulist ."')";
			$sSQL .= $items ? " LIMIT " . $items : null;	
			//echo $sSQL;
			$resultset = $db->Execute($sSQL);	
			$this->result = $resultset;		
		
			if ($linemax>1)
				$out = $this->list_katalog_table($linemax,null,$template,$pz,$nopager);
			else  	
				$out = $this->list_katalog(0,null,$template,$pz,$nopager);		
		}
		
		return ($out);
	}		
	
	public function show_last_viewed_items_session($items=10,$linemax=null,$template=null,$photosize=null,$nopager=null) {
        $db = GetGlobal('db');
        $UserName = GetGlobal('UserName');						
		$c = $category ? $category : GetReq('cat');	
		
		$cat = explode($this->sep(),$c);		
	    $date2check = time() - ($days * 24 * 60 * 60);
	    $entrydate = date('Y-m-d',$date2check);		
		$pz = $photosize ? $photosize : 1;
		$resources = 1;

        $lastviewed = unserialize(GetSessionParam('lastvieweditems')); 
		if (!empty($lastviewed)) {	
			$ilist = implode("','",array_reverse($lastviewed));
		
			$sSQL = $this->selectSQL;
			$sSQL .= " WHERE " . $this->fcode." in ('". $ilist ."')";
			$sSQL .= " and itmactive>0 and active>0";				

			$resultset = $db->Execute($sSQL,2);	
			$this->result = $resultset;	

			if ($linemax>1)
				$out = $this->list_katalog_table($linemax,null,$template,$pz,$nopager);
			else  	
				$out = $this->list_katalog(0,null,$template,$pz,$nopager);
		}
		
		return ($out);				
	}	
	
	//alias
	public function show_last_viewed_items($items=10,$linemax=null,$template=null,$photosize=null,$nopager=null) {
		
		return $this->show_last_viewed_items_session($items,$linemax,$template,$photosize,$nopager);
	}	
	
	public function show_last_edited_items($items=10,$linemax=null,$template=null,$photosize=null,$nopager=null) {	
	    $limit = $items ? $items : 5;
        $db = GetGlobal('db');	
		$pz = $photosize ? $photosize : 1;		
		$lastprice = $this->getmapf('lastprice')?','.$this->getmapf('lastprice'):null;	
		 
		if ($this->one_attachment)
			$slan = null;
		else
			$slan = $this->lan;
		 
	    $code = $this->fcode;	  
		 
        $sSQL = "select code from pattachments ";
	    $sSQL .= " WHERE (type='.html' or type='.htm')";
	    if (isset($slan))
			$sSQL .= " and lan=" . $slan;
		$sSQL .= " ORDER BY id desc ";	
        $sSQL .= $items ? " LIMIT " . $items : null;		 
	    //echo $sSQL;
	  
	    $resultset = $db->Execute($sSQL,2);	
	    $result = $resultset;
	    if ($exist = $db->Affected_Rows()) {
		   $ret = $result->fields['data'];
		}	
		 
        $sSQL2 = $this->selectSQL;
		$sSQL2 .= " WHERE ";
        foreach ($result as $n=>$rec) {
		    $or[] = $this->fcode ."='". $rec['code'] ."'";
        }
        $sSQL2 .= '(' . implode(' or ',$or) . ')'; 
		$sSQL2 .= " and (itmactive>0 and active>0)";
		$sSQL2 .= " ORDER BY " . $this->fcode . " desc LIMIT " . $items;			 
        //echo $sSQL2;
		 
	    $resultset = $db->Execute($sSQL2,2);	
		$this->result = $resultset;		 
		 
		if ($linemax>1)
			$out = $this->list_katalog_table($linemax,null,$template,$pz,$nopager);
		else  	
			$out = $this->list_katalog(0,null,$template,$pz,$nopager);
		  
		return ($out);			 
	}	

	//for sitemap call
	public function show_sitemap_items($items=10,$linemax=null,$template=null,$photosize=null,$category=null) {
        $db = GetGlobal('db');		
		$mycat = $category ? $category : GetReq('cat');	   
		$cat = explode($this->sep(),$mycat);		
		$pz = $photosize ? $photosize : 1;		
				
		//auto browse current cat
		$fields = $this->result->fields; //prev query exclude cat		
		
	    $sSQL = $this->selectSQL;
		$sSQL .= " WHERE ";		  		  
		$sSQL .= "itmactive>0 and active>0";	
		$sSQL .= " ORDER BY datein DESC LIMIT 2000";		
	    //echo $sSQL;
		
	    $resultset = $db->Execute($sSQL,2);	
		$this->result = $resultset;	
		
		if ($linemax>1) 
			$out = $this->list_katalog_table($linemax,null,$template,$pz,1);
		else  	
			$out = $this->list_katalog(0,null,$template,$pz,1); 
		  
		return ($out);	
	}		
	
	public function show_sitemap($template=null) {
		$db = GetGlobal('db');
		$start = GetReq('start');
		$headcat = GetReq('headcat')?GetReq('headcat'):"";	   
		$meter = $start ? $start-1 : 0; 
		$sep = $this->sep();	
	   
		return null; //<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<< DISABLED

		$mytemplate = $template ? _m("cmsrt.select_template use $template") : null;	   
	   
		$sSQL = "select id,itmname,itmfname,cat0,cat1,cat2,cat3,cat4,itmdescr,itmfdescr,itmremark,".$this->fcode." from products ";
		$sSQL .= " WHERE ";
		$sSQL .= "itmactive>0 and active>0";	
		$sSQL .= " ORDER BY cat0,cat1,cat2,cat3,cat4,{$this->itmname} asc ";
		$sSQL .= $start ? " LIMIT $start,10000" : " LIMIT 10000";			
		//echo $sSQL;
		
		$resultset = $db->Execute($sSQL,2);	
		$result = $resultset;
		   
		if (!empty($result)) {		   
	    
			if ($headcat)//next page start with headcat
				$out = '<h2>' . $this->replace_spchars($headcat,1) . '</h2><hr/>';
	
			foreach ($result as $n=>$rec) {
		
				if (!empty($rec)) {
		   
					$meter+=1;
					$_cat = $rec['cat0'].$sep.$rec['cat1'].$sep.$rec['cat2'].$sep.$rec['cat3'];
					$cat = $this->getkategories($_cat, 1, $this->lan, $this->klistcmd);		 
					$linkcat = $this->getkategoriesS(array(0=>$rec['cat0'],1=>$rec['cat1'],2=>$rec['cat2'],3=>$rec['cat3'],4=>$rec['cat4']));	      			      		   
			 		   
					if (strtolower($headcat)!=strtolower($cat)) {//paging start
						$headcat = $cat;
						//echo $headcat;
						if (strstr($headcat,'</a>'.$sep.'<a')) //link
							$ret .= '<h2>' . str_replace('</a>'.$sep.'<a','</a>'.$this->rightarrow.'<a', $this->replace_spchars($headcat,1)) . '</h2><hr>';
						else			   
							$ret .= '<h2>' . str_replace($sep,$this->rightarrow,$this->replace_spchars($headcat,1)) . '</h2><hr>';
					}
					$title = $rec[$this->fcode] . "&nbsp;" . $rec[$this->itmname];
			 
					$itemlinkname = _m("cmsrt.url use t={$this->kshowcmd}&cat=$linkcat&id=".$rec[$this->fcode]."+".$title); 		   
			 
					if ($mytemplate) {
						$tokens = array(); //reset 
						$tokens[] = $meter; 
						$tokens[] = $itemlinkname; 
						$tokens[] = $rec[$this->fcode];
						$tokens[] = $rec[$this->itmname];
						$ret .= $this->combine_tokens($mytemplate, $tokens);			 
					}
					else
						$ret .= $meter . "&nbsp;" . $itemlinkname . "<br/>";			   
				}
			}
		 
			if (($mytemplate) && (stristr($mytemplate,'<SPLIT/>')) && ($this->linemax)) {
				$items = explode('<SPLIT/>',$ret); //<li> split..
				$out .= $this->make_table($items, $this->linemax, 'fpkatalogtable', $cat); 
			}
			else
				$out .= $ret;
		}   
	   
		return ($ret);		   		   	
	}
	
	public function read_item_attr($code=null,$attr=null,$islink=null) {
        $db = GetGlobal('db');					
		$item = $code ? $code : $this->realID;	
		
        $sSQL = $this->selectSQL;
		$sSQL .= " WHERE ";
		$sSQL .= $this->fcode . "= '" . $item ."'";
	    $resultset = $db->Execute($sSQL,2);	
		$result = $resultset;

	    foreach ($result as $n=>$rec) {
			if ($islink) {
				$cat = $this->getkategoriesS(array(0=>$rec['cat0'],1=>$rec['cat1'],2=>$rec['cat2'],3=>$rec['cat3'],4=>$rec['cat4']));	      			      		   
				$itemlink = _m("cmsrt.url use t={$this->kshowcmd}&cat=$cat&id=". $rec[$this->fcode] ."+". $rec[$attr]); 
				return ($itemlink);
			}
			else
				return ($rec[$attr]);	
		}  									
	}
	
	public function read_item_weight($items=10,$linemax=null,$template=null,$photosize=null,$itemsarray=null) {
        $db = GetGlobal('db');						
		$pz = $photosize ? $photosize : 1;	
		if (!$itemsarray) return;		

        $sSQL = $this->selectSQL;
		$sSQL .= " WHERE ";	
		
        if (strstr($itemsarray,';')) {
		
			$items = explode(';',$itemsarray);
		
			foreach ($items as $code)
				$tempSQL[] = $this->fcode . "= '" . $code ."'";
			
			$sSQL .= implode(' OR ',$tempSQL);	
		} 
		else //one item
			$sSQL .= $this->fcode . "= '" . $itemsarray ."'";

	    $resultset = $db->Execute($sSQL,2);	
		$this->result = $resultset;	
		
		if ($linemax>1)
			$out = $this->list_katalog_table($linemax,null,$template,$pz,1);
		elseif ($linemax==1)  	
			$out = $this->list_katalog(0,null,$template,$pz,1);
		else {//return val
			foreach ($this->result as $n=>$rec) 
				$out[$rec[$this->fcode]] = floatval($rec['weight']);
		}  
		return ($out);	
	}		
	
	
	//XML FEEDS
	
    public function katalog_feed() { 
		$db = GetGlobal('db');  
		$format = GetReq('format') ? GetReq('format') : 'rss2';	
		//echo 'format:' . $format;
		$imgxmlPath = _m('cmsrt.paramload use CMS+xmlpics'); //else use img token	
		$aliasID = _m("cmsrt.useUrlAlias"); 	

		$xml = new pxml();
		$xml->encoding = $this->encoding;	//must be utf8 not utf-8
		  
		$this->xml_formater($xml,$format,1);	  

		if (!empty($this->result)) {
			$i=0;	
		  	$pp = $this->read_policy(); 
			
			foreach ($this->result as $n=>$rec) {
					
				$tokens = $this->tokenizeRecord($rec, $pp, true, $aliasID, 2, $imgxmlPath);					
				$this->xml_formater($xml,$format,null,$tokens);
				//echo $rec[$this->fcode] . ',';
			    $i+=1;	
			}
		} //else echo '--';

		return $xml->getxml(1); 
    }	
	
    public function sitemap_feed($read_all=false) {
		$db = GetGlobal('db');  
		$format = 'sitemap';
		$imgxmlPath = _m('cmsrt.paramload use CMS+xmlpics'); //else use img token	
		$aliasID = _m("cmsrt.useUrlAlias"); 					

		$sSQL = $this->selectSQL; 
		$sSQL .= " WHERE itmactive>0 and active>0 ";	
		$sSQL .= " ORDER BY datein,id DESC LIMIT 6000";			
		
		$resultset = $db->Execute($sSQL,2);			

		$xml = new pxml();
		$xml->encoding = $this->encoding;	
		  
		$this->xml_formater($xml,$format,1);	  
	  
		//items  
		if (!empty($resultset)) {		  	
			$i=0;
			$pp = $this->read_policy(); 
			
			foreach ($resultset as $n=>$rec) {

				$tokens = $this->tokenizeRecord($rec, $pp, true, $aliasID, 2, $imgxmlPath);				
				$this->xml_formater($xml,$format,null,$tokens);
				$i+=1;	
				//if ($i==1111) break; //stop to test			
			}
		} 

		return $xml->getxml(1);
    }		

	protected function xml_formater(& $xml,$format=null,$init=null,$params=null,$encoding=null) {
	
	    $date = date(DATE_RFC822);//'m-d-Y');
		$cat_title = _m('shkategories.getcurrentkategory');
	    $lan_descr = getlocal() ? 'gr' : 'en';
	   
	    if ($init) {
		  
		    $enc = $this->encoding ? $this->encoding : $xml->charset;

            switch ($format) {
				
				case 'sitemap' :$xml->addtag('urlset',null,null,"xmlns=http://www.sitemaps.org/schemas/sitemap/0.9");							
                                break; 			   
				case 'skroutz' :$xml->addtag('skroutzstore',null,null,"url={$this->httpurl}|name=$xml->urltitle|encoding=$enc");							
	                            $xml->addtag('products','skroutzstore',null,null);
								break;
				case 'rss1'    :echo 'rss1';
	   					        break; 								
				case 'rss2'    :$xml->addtag('rss',null,null,"version=2.0");							
	                            $xml->addtag('channel','rss',$xml->urltitle,null);
	                            $xml->addtag('title','channel',$xml->urltitle.', '.$cat_title,null);								
	                            $xml->addtag('link','channel',$this->httpurl,null);									
	                            $xml->addtag('description','channel',$xml->urltitle.', '.$cat_title,null);									
	                            $xml->addtag('language','channel',$lan_descr,null);									
	                            $xml->addtag('pubDate','channel',$date,null);									
	                            $xml->addtag('lastBuildDate','channel',$date,null);	
	                            $xml->addtag('docs','channel',null,null);																	
	                            $xml->addtag('generator','channel','e-Enterprise',null);									
	                            $xml->addtag('managingEditor','channel',$xml->urltitle,null);									
	                            $xml->addtag('webMaster','channel',null,null);									
	                            $xml->addtag('ttl','channel','15',null);									
	   					        break; 
				case 'atom'    :$xml->addtag('feed',null,null,"xmlns=http://www.w3.org/2005/Atom");							
	                            $xml->addtag('title','feed',$xml->urltitle,null);
	                            $xml->addtag('subtitle','feed',null,null);								
	                            $xml->addtag('link','feed','/',"href=" . $this->httpurl . "/atom/|rel=self");									
	                            $xml->addtag('link','feed','/',"href=" . $this->httpurl);									
	                            $xml->addtag('id','feed',null,null);									
	                            $xml->addtag('updated','feed',null,null);									
	                            $xml->addtag('author','feed',$xml->urltitle,null);	
	                            $xml->addtag('name','author',$xml->urltitle,null);																	
	                            $xml->addtag('email','author',null,null);									
	   					        break; 								
				default        :$xml->addtag('default-xml',null,null,"url={$this->httpurl}|name=$xml->urltitle|encoding=$enc");							
	                            $xml->addtag('products','default-xml',null,null);
												
		    }		  
		    return 1;
		}
		else {
            //product loop xml tags 		  
            switch ($format) {
		
				case 'sitemap' :$xml->addtag('url','urlset',null,null);
								//$xml->addtag('name','url',$xml->cdata($params[1]),null); 
								$xml->addtag('loc','url',$params[0],null); 
								if ($params[1]) //in case of 0000-00-00..is null
									$xml->addtag('lastmod','url',$params[1],null);  			   
								$xml->addtag('changefreq','url','daily',null); 
								$xml->addtag('priority','url','0.5',null);
								break;
			 
	           case 'skroutz' : $xml->addtag('product','products',null,"id=".$params[10]);
			   
								$xml->addtag('name','product',$xml->cdata($params[16]),null);  //cdata val
								$xml->addtag('link','product',$params[11],null);  //http://... val
								$xml->addtag('price_with_vat','product',$params[47],null);  //price 11.11
								$xml->addtag('category','product',$xml->cdata($params[17]),"id=".$params[10]); //cdata val = descr, id=code
								$xml->addtag('image','product',$params[14]); //,"width=$xf|height=$yf");  //http://... image
								$xml->addtag('thumbnail','product',$params[14]); //,"width=$xt|height=$yt");  //http://... thumbnail
								$xml->addtag('manufacturer','product',$xml->cdata($params[39]),null);  //cdata val
								$xml->addtag('shipping','product',null,"type=accurate|currency=euro");  //ship cost 11.11
								$xml->addtag('sku','product',$params[41]);//'/',null);  
								$xml->addtag('ssku','product',$params[42]);//'/',null);  
								$xml->addtag('description','product',$xml->cdata($params[1]),null);  //cdata val		  
								break;
			   case 'rss1'    : //echo 'rss1';
								break; 								
			   case 'rss2'    : //echo 'rss2';
								$xml->addtag('item','channel',null,null);				   
			   
								$xml->addtag('title','item',$xml->cdata($params[16]),null);				   
								$xml->addtag('link','item',$params[11],null);
								$xml->addtag('description','item',$xml->cdata($params[1]),null);				   			   				   			   
								$xml->addtag('author','item',$xml->urltitle,null);
								$xml->addtag('category','item',$xml->cdata($params[17]),null);
								$xml->addtag('comments','item',$xml->cdata(strip_tags($params[4])),null);
								$xml->addtag('pubDate','item',date(DATE_RFC822, strtotime($params[48]))); //$date,null);				   			   
								$xml->addtag('guid','item',$params[10],null);			   
								break; 
			   case 'atom'    : //echo 'atom';
								$xml->addtag('entry','feed',null,null);				   
			   
								$xml->addtag('title','entry',$params[16],null);				   
								$xml->addtag('link','entry',$params[11],null);
								$xml->addtag('id','entry',$params[10],null);				   			   				   			   
								$xml->addtag('updated','entry',$date,null);				   			   
								$xml->addtag('summary','entry',$params[1],null);				   
								break; 
			   default : //seo links
								$xml->addtag('product','products',null,"id=");
			   
								$xml->addtag('name','product',$xml->cdata('name'),null);  //cdata val
								$xml->addtag('link','product',null,null);  //http://... val
								$xml->addtag('price_with_vat','product',null,null);  //price 11.11
								$xml->addtag('category','product',$xml->cdata($params[17]),"id=\"\""); //cdata val = descr, id=code
								$xml->addtag('image','product');//,null,"width=|height=");  //http://... image
								$xml->addtag('thumbnail','product');//,null,"width=|height=");  //http://... thumbnail
								$xml->addtag('manufacturer','product',$xml->cdata('manufacturer'),null);  //cdata val
								$xml->addtag('shipping','product',null,"type=|currency=");  //ship cost 11.11
								$xml->addtag('description','product',$xml->cdata('description'),null);  //cdata val		  			   
			}
			//dump xml  
			//echo '<pre>';
			//$xml->dumpxml();
			//print_r($xml->index);
			//echo '</pre>';
		    return 1;
		}
		 
		return 0;
	}		
	
	
	/* rcxml feed */
	protected function xml_feed() {  
		$format = GetReq('format') ? GetReq('format') : 'sitemap';			
		$ret = null;
		$items = array();		

		$xmltemplate = _m("cmsrt.select_template use $format");
		$xmltemplate_products = _m("cmsrt.select_template use $format" . '-items');
		$imgxmlPath = _m('cmsrt.paramload use CMS+xmlpics'); //else use img token	
		
		//$aliasID = _m("cmsrt.useUrlAlias");
		$aliasID = false; //DISABLED (BE AWARE FOR NON .HTML LINKS)
		$pp = $this->read_policy(); 
	    	
		foreach ($this->result as $n=>$rec) {	
			
			$tokens = $this->tokenizeRecord($rec, $pp, true, $aliasID, 2, $imgxmlPath);
			//if ($n==0) print_r($tokens);
			$items[] = $this->combine_tokens($xmltemplate_products, $tokens, true);					
			unset($tokens);
		}
		
		$tt = array();
		$tt[] = date('Y-m-d h:m'); 
		$tt[] = implode(PHP_EOL, $items);
		$ret = $this->combine_tokens($xmltemplate, $tt, true);
		unset($tt);
		return ($ret);		
	}

	/*tokenize list of items */		
	protected function tokenizeRecord($rec, $priceID=null, $cart=null, $aliasID=false, $imgsize=1, $otherimgpath=null) {
		if (!$rec) return null;
		$tokens = array(); 
		$pp = $priceID ? $priceID : 'price1';
		
		//url alias or canonical	
		$id2 = $aliasID ? ($rec[$aliasID] ? $this->stralias($rec[$aliasID]) : $rec[$this->fcode]) : $rec[$this->fcode]; 		
		$aliasExt = _v("cmsrt.aliasExt");
			
		$cat = $this->getkategoriesS(array(0=>$rec['cat0'],1=>$rec['cat1'],2=>$rec['cat2'],3=>$rec['cat3'],4=>$rec['cat4']));
		$price = ($rec[$pp]>0) ? $this->spt($rec[$pp]) : $this->zeroprice_msg;
		$availability = $this->show_availability($rec['ypoloipo1']);	
		$details = null;
        $detailink = $this->httpurl . '/' . _m("cmsrt.url use t={$this->kshowcmd}&cat=$cat&id=".$rec[$this->fcode]) . '#details';
		$itemlink = $this->httpurl . '/' . _m("cmsrt.url use t={$this->kshowcmd}&cat=$cat&id=".$rec[$this->fcode]); 
		$itemlinkname = _m("cmsrt.url use t={$this->kshowcmd}&cat=$cat&id=" . $rec[$this->fcode] . "+". $rec[$this->itmname]);
			
		//tokens
		$tokens[] = $itemlinkname; //use href token 11 / name token 16
		$tokens[] = $rec[$this->itmdescr];
		$tokens[] = $this->list_photo($rec[$this->fcode],null,null,1,$cat,$imgsize,null,$rec[$this->itmname]);
		$units = $rec['uniname2'] ? localize($rec['uniname1'], $this->lan) .' / '. localize($rec['uniname2'], $this->lan):
										localize($rec['uniname1'], $this->lan);  
		$tokens[] = $units;		  
			  
		$tokens[] = $rec['itmremark'];
		$tokens[] = number_format(floatval($price),$this->decimals,',','.');
			
		if (($cart==true) && (defined("SHCART_DPC"))) {
			$page = isset($_GET['page']) ? $_GET['page'] : 0;

			$cartstr = $rec[$this->fcode].';'.
						$this->replace_cartchars($rec[$this->itmname]).';;;'.
						$cat.';'.$page.';;'.$rec[$this->fcode].';'.$price.';1;';				
							
			$tokens[] = _m("shcart.showsymbol use $cartstr",1);			
		}	
		else
            $tokens[] = null;			
			
		$tokens[] = $availability;
		$tokens[] = $details;
		$tokens[] = $detailink;
		$tokens[] = $rec[$this->fcode]; //10
			
		$tokens[] = ($aliasID) ? $this->httpurl ."/$cat/$id2" . $aliasExt : 
							     $itemlink;	
			 
		$qty = (($cart==true) && (defined("SHCART_DPC"))) ?	_m("shcart.getCartItemQty use ".$rec[$this->fcode]) : 1;			
		$tokens[] = (($cart==true) && (defined("SHCART_DPC"))) ? $qty : '0';
		$tokens[] = (($cart==true) && (defined("SHCART_DPC"))) ? $this->httpurl . "/addcart/{$rec[$this->fcode]}/$cat/1/" : null;

        $tokens[] = ($otherimgpath) ?
		            $this->httpurl . '/' . $otherimgpath . $rec[$this->fcode] . $this->restype :
		            $this->httpurl . $this->get_photo_url($rec[$this->fcode], $imgsize);	
						
        $tokens[] = isset($rec[$this->getmapf('lastprice')]) ? $rec[$this->getmapf('lastprice')] : 0;	
        $tokens[] = $rec[$this->itmname]; 
        $tokens[] = _m("cmsrt.replace_spchars use $cat+1");  

        $tokens[] = $this->item_has_discount($rec[$this->fcode]);
			
		$cart_title = $this->replace_cartchars($rec[$this->itmname]);
        //$tokens[] = $this->httpurl . "/addcart/{$rec[$this->fcode]};{$rec[$this->itmname]};;;$cat;0;;{$rec[$this->fcode]};$price;1/$cat/1/";				  
		$tokens[] = $this->httpurl . "/addcart/{$rec[$this->fcode]}/$cat/1/";				  
		      
		/*date time */
		$tokens[] = $rec['year'];  //20
		$tokens[] = $rec['month'];
		$tokens[] = $rec['day'];
		$tokens[] = $rec['time'];
		$tokens[] = $rec['monthname']; 
			  
		$tokens[] = $rec['template'];
		$tokens[] = $rec['owner'];			  
		$tokens[] = $rec['itmactive'];
			
		$tokens[] = $this->item_has_points($rec[$this->fcode]);
			
		$tokens[] = $rec['p1']; 
		$tokens[] = $rec['p2']; //30
		$tokens[] = $rec['p3'];
		$tokens[] = $rec['p4'];
		$tokens[] = $rec['p5'];
			
		$tokens[] = $rec['weight'];
		$tokens[] = $rec['volume'];
		$tokens[] = $rec['dimensions'];
		$tokens[] = $rec['size'];
		$tokens[] = $rec['color'];				
		$tokens[] = $rec['manufacturer'];

		$tokens[] = $rec['code1']; //40
		$tokens[] = $rec['code2'];				
		$tokens[] = $rec['code3'];			
		$tokens[] = $rec['code4'];	
		$tokens[] = $rec['resources']; 
		$tokens[] = $rec['ypoloipo1'] ;
		$tokens[] = $rec['ypoloipo1'] ? '1' : '0';				
			
		$pwt = (($cart==true) && (defined("SHCART_DPC"))) ?
				$this->pricewithtax($price, _v('shcart.tax')) : $price;
		$tokens[] = number_format($pwt, $this->decimals,',','.'); //(floatval($price)*24/100)+floatval($price)
		
		$tokens[] = $rec['datein'] ; //48
				
		return ($tokens);
	}	
	
	//api version
	protected function tokenizeRecordApi($rec, $priceID=null, $cart=null, $aliasID=false, $imgsize=1, $otherimgpath=null) {
		if (!$rec) return null;
		$tokens = array(); 
		$pp = $priceID ? $priceID : 'price1';
		
		//url alias or canonical	
		$id2 = $aliasID ? ($rec[$aliasID] ? $this->stralias($rec[$aliasID]) : $rec[$this->fcode]) : $rec[$this->fcode]; 		
		$aliasExt = _v("cmsrt.aliasExt");
			
		$cat = $this->getkategoriesS(array(0=>$rec['cat0'],1=>$rec['cat1'],2=>$rec['cat2'],3=>$rec['cat3'],4=>$rec['cat4']));
		$price = ($rec[$pp]>0) ? $this->spt($rec[$pp]) : $this->zeroprice_msg;
		$availability = $this->show_availability($rec['ypoloipo1']);	
		$details = null;
		$itemlink = $this->httpurl . '/' . _m("cmsrt.url use t={$this->kshowcmd}&cat=$cat&id=".$rec[$this->fcode]); 
		$detailink = $itemlink . '#' . $rec[$this->fcode] .'-details';	
		$itemlinkname = _m("cmsrt.url use t={$this->kshowcmd}&cat=$cat&id=" . $rec[$this->fcode] . "+". $rec[$this->itmname]);
			
		//tokens
		$tokens['itmname'] = $rec[$this->itmname]; 
		$tokens['itmdescr'] = $rec[$this->itmdescr];
		$tokens['photo'] = $this->httpurl . $this->get_photo_url($rec[$this->fcode],1);
		$units = $rec['uniname2'] ? localize($rec['uniname1'], $this->lan) .' / '. localize($rec['uniname2'], $this->lan):
										localize($rec['uniname1'], $this->lan);  
		$tokens['units'] = $units;
		$tokens['ypoloipo1'] = $rec['ypoloipo1'] ;
		$tokens['itemhasypoloipo'] = $rec['ypoloipo1'] ? '1' : '0';			
			  
		$tokens['itmremark'] = $rec['itmremark'];
		$tokens['price'] = number_format(floatval($price),$this->decimals,',','.');
		$pwt = (($cart==true) && (defined("SHCART_DPC"))) ?
				$this->pricewithtax($price, _v('shcart.tax')) : $price;
		$tokens['pricewithtax'] = number_format($pwt, $this->decimals,',','.'); //(floatval($price)*24/100)+floatval($price)
				
			
		if (($cart==true) && (defined("SHCART_DPC"))) {
			$page = $_GET['page'] ? $_GET['page'] : 0;

			$cartstr = $rec[$this->fcode].';'.
						$this->replace_cartchars($rec[$this->itmname]).';;;'.
						$cat.';'.$page.';;'.$rec[$this->fcode].';'.$price.';1;';				
							
			$tokens['carticon'] = _m("shcart.showsymbol use $cartstr",1);			
		}	
		else
            $tokens['carticon'] = null;			
			
		$tokens['availability'] = $availability;
		$tokens['detailslink'] = $detailink;		
		$tokens['details'] = $details;
		$tokens['itmcode'] = $rec[$this->fcode]; 
			
		$tokens['itmurl'] = ($aliasID) ? $this->httpurl ."/$cat/$id2" . $aliasExt : $itemlink;	
		$tokens['url'] = $id2 . $aliasExt;
		$tokens['urlx'] = $id2;
			 
		$qty = (($cart==true) && (defined("SHCART_DPC"))) ?	_m("shcart.getCartItemQty use ".$rec[$this->fcode]) : 1;			
		$tokens['incart'] = (($cart==true) && (defined("SHCART_DPC"))) ? $qty : '0';
		$tokens['cartlink'] = $this->httpurl . "/addcart/{$rec[$this->fcode]}/$cat/1/";
						
        $tokens['itmname'] = $rec[$this->itmname]; 
		
        $tokens['currenttree'] = _m("cmsrt.replace_spchars use $cat+1");  
		$tokens['currentcategory'] = (defined("SHKATEGORIES_DPC")) ? _m("shkategories.getcurrentkategory") : null; 

        $tokens['itemhasdiscount'] = $this->item_has_discount($rec[$this->fcode]);
		$tokens['itemhaspoints'] = $this->item_has_points($rec[$this->fcode]);			
        $tokens['lastprice'] = $rec[$this->getmapf('lastprice')];			
        //$tokens['carturl'] = $this->httpurl . "/addcart/{$rec[$this->fcode]};{$rec[$this->itmname]};;;$cat;0;;{$rec[$this->fcode]};$price;1/$cat/1/";		
		$tokens['carturl'] = (($cart==true) && (defined("SHCART_DPC"))) ? $this->httpurl . "/addcart/{$rec[$this->fcode]}/$cat/1/" : null;
		$tokens['cartcount'] = (($cart==true) && (defined("SHCART_DPC"))) ?	_m("shcart.getcartCount") + 1 : 0;
		$tokens['cartitemposition'] = (($cart==true) && (defined("SHCART_DPC"))) ? _m("shcart.getCartItemPosition use " . $rec[$this->fcode]) : 0;			
		
        $tokens['photo1'] = $this->httpurl . $this->get_photo_url($rec[$this->fcode],1);
        $tokens['photo2'] = $this->httpurl . $this->get_photo_url($rec[$this->fcode],2);	
		$tokens['photo3'] = $this->httpurl . $this->get_photo_url($rec[$this->fcode],3);			
		$tokens['photoalt'] = $this->httpurl . '/images/uphotos/' . $rec[$this->fcode]. 'A' . $this->restype;		

		$tokens['weight'] = $rec['weight'];
		$tokens['volume'] = $rec['volume'];
		$tokens['dimensions'] = $rec['dimensions'];
		$tokens['size'] = $rec['size'];
		$tokens['color'] = $rec['color'];				
		$tokens['manufacturer'] = $rec['manufacturer'];	

		$tokens['template'] = $rec['template'];
		$tokens['owner'] = $rec['owner'];			  
		$tokens['itmactive'] = $rec['itmactive'];
		$tokens['active'] = $rec['active'];
			
		$tokens['p1'] = $rec['p1']; 
		$tokens['p2'] = $rec['p2']; 
		$tokens['p3'] = $rec['p3'];
		$tokens['p4'] = $rec['p4'];
		$tokens['p5'] = $rec['p5'];
			
		$tokens['code1'] = $rec['code1']; 
		$tokens['code2'] = $rec['code2'];				
		$tokens['code3'] = $rec['code3'];			
		$tokens['code4'] = $rec['code4'];	
		$tokens['code5'] = $rec['code5'];		
		$tokens['resources'] = $rec['resources']; 	
		$tokens['tags'] = _m("shtags.get_tags use " . $rec[$this->fcode]);	
		$tokens['itmhtml'] = $this->show_aditional_html_files($rec[$this->fcode]);										
		      
		/*date time */
		$tokens['year'] = $rec['year'];  //20
		$tokens['month'] = $rec['month'];
		$tokens['day'] = $rec['day'];
		$tokens['time'] = $rec['time'];
		$tokens['monthname'] = $rec['monthname']; 
			  			
		$tokens['datein'] = $rec['datein'] ; //48
				
		return ($tokens);
	}	

	/*tokenize 1 item read */
	protected function tokenizeRecordItem($rec, $priceID=null, $cart=null, $aliasID=false, $imgsize=1, $otherimgpath=null) {
		if (!$rec) return null;
		$tokens = array(); 
		$pp = $priceID ? $priceID : 'price1';

		//url alias or canonical	
		$id2 = $aliasID ? ($rec[$aliasID] ? $this->stralias($rec[$aliasID]) : $rec[$this->fcode]) : $rec[$this->fcode]; 		
		$aliasExt = _v("cmsrt.aliasExt");
			
		$cat = $this->getkategoriesS(array(0=>$rec['cat0'],1=>$rec['cat1'],2=>$rec['cat2'],3=>$rec['cat3'],4=>$rec['cat4']));
		$price = ($rec[$pp]>0) ? $this->spt($rec[$pp]) : $this->zeroprice_msg;
		$availability = $this->show_availability($rec['ypoloipo1']);	
		$details = null;
		$detailink = ($this->mobile) ? 
						"javascript:window.scrollTo(0,parseInt($('#{$rec[$this->fcode]}-details').offset().top, 10))" :
						//"javascript:gotoTop('{$rec[$this->fcode]}-details')"; //href mozilla err		
						$this->httpurl . '/' . _m("cmsrt.url use t={$this->kshowcmd}&cat=$cat&id=".$rec[$this->fcode]) . "#{$rec[$this->fcode]}-details";
		
		$itemlink = $this->httpurl . '/' . _m("cmsrt.url use t={$this->kshowcmd}&cat=$cat&id=".$rec[$this->fcode]); 
		$itemlinkname = _m("cmsrt.url use t={$this->kshowcmd}&cat=$cat&id=" . $rec[$this->fcode] . "+". $rec[$this->itmname]);
			
		//tokens		
		$tokens[] = $rec[$this->itmname];
		$tokens[] = $rec[$this->itmdescr];
		$tokens[] = $this->list_photo($rec[$this->fcode],null,null,1,$cat,$imgsize,null,$rec[$this->itmname]);
		$units = $rec['uniname2'] ? localize($rec['uniname1'], $this->lan) .' / '. localize($rec['uniname2'], $this->lan):
									localize($rec['uniname1'], $this->lan);  
		$tokens[] = $units;		 
		$tokens[] = $rec['itmremark'];
		$tokens[] = number_format(floatval($price),$this->decimals,',','.');
		
		if (($cart==true) && (defined("SHCART_DPC"))) {
			$page = $_GET['page'] ? $_GET['page'] : 0;
			$cart_title = $this->replace_cartchars($rec[$this->itmname]);
			$icon_cart = _m("shcart.showsymbol use {$rec[$this->fcode]};$cart_title;;;$cat;$page;;{$rec[$this->fcode]};$price;1;",1);
			$array_cart = $this->read_qty_policy($rec[$this->fcode],$price,"{$rec[$this->fcode]};$cart_title;;;$cat;$page;;{$rec[$this->fcode]};$price;1");				
			$incart = _m("shcart.getCartItemQty use ".$rec[$this->fcode]);

			/*$cartstr = $rec[$this->fcode].';'.
						$this->replace_cartchars($rec[$this->itmname]).';;;'.
						$cat.';'.$page.';;'.$rec[$this->fcode].';'.$price.';1;';				
							
			$tokens[] = _m("shcart.showsymbol use $cartstr",1);		*/
			$tokens[] = $icon_cart;
		}	
		else
            $tokens[] = null;
		
		$tokens[] = $availability;
		$tokens[] = $detailink;	
		$tokens[] = $details;
		$tokens[] = $rec[$this->fcode]; //10
		 
		$tokens[] = $incart; 
		$tokens[] = $array_cart;
		$tokens[] = GetReq('qty') ? GetReq('qty') : $incart; // add qty
				
		$tokens[] = ($aliasID) ? $this->httpurl ."/$cat/$id2" . $aliasExt : $itemlink;						
		$tokens[] = _m("shkategories.getcurrentkategory"); //$cat; //$afile;
			 
        $tokens[] = $rec[$this->getmapf('lastprice')];	
        $tokens[] = $this->httpurl . $this->get_photo_url($rec[$this->fcode],1);
        $tokens[] = $this->httpurl . $this->get_photo_url($rec[$this->fcode],2);	
		/* big pic */		
		$tokens[] = defined('JSDIALOG_DPC') ? 
					"javascript:jsShowPhoto('{$rec[$this->itmname]}');" :
					$this->httpurl . $this->get_photo_url($rec[$this->fcode],3);			 
			 
		$tokens[] = $rec['weight'];  //20
		$tokens[] = $rec['volume'];
		$tokens[] = $rec['dimensions'];
		$tokens[] = $rec['size'];
		$tokens[] = $rec['color'];	
			 
		$tokens[] = $this->get_xml_links(); 
        $tokens[] = $this->item_has_discount($rec[$this->fcode]);
        //$tokens[] = $this->httpurl . "/addcart/{$rec[$this->fcode]};$cart_title;;;$cat;0;;{$rec[$this->fcode]};$price;1/$cat/1/";				  
		$tokens[] = $this->httpurl . "/addcart/{$rec[$this->fcode]}/$cat/1/";				  
		   
		$tokens[] = $rec['code1'];
		$tokens[] = $rec['code4'];
		$tokens[] = $rec['resources']; //id=30
		$tokens[] = $rec['ypoloipo1'];
		$tokens[] = $rec['manufacturer'];	
			 
		/*date time */
		$tokens[] = $rec['year'];
		$tokens[] = $rec['month'];
		$tokens[] = $rec['day'];
		$tokens[] = $rec['time'];
		$tokens[] = $rec['monthname'];		

		$tokens[] = $rec['template'];
		$tokens[] = $rec['owner'];	
        $tokens[] = $rec['itmactive'];	//40

		$tokens[] = $this->item_has_points($rec[$this->fcode]);

		$tokens[] = $rec['p1']; 
		$tokens[] = $rec['p2']; 
		$tokens[] = $rec['p3'];
		$tokens[] = $rec['p4'];
		$tokens[] = $rec['p5'];	

		$tokens[] = _m("shtags.get_tags use " . $rec[$this->fcode]);	
		
		//price based on qty (with tax)
		$q = GetReq('qty') ? GetReq('qty') : ($incart ? $incart : 1);	
		$priceqty = (($cart==true) && (defined("SHCART_DPC"))) ?
					$this->read_qty_policy($rec[$this->fcode], $price, null, $q) : $price;	
		//echo $priceqty . '>' . $q;
		$pwt = (($cart==true) && (defined("SHCART_DPC"))) ?
				$this->pricewithtax($priceqty, _v('shcart.tax')) : $priceqty;
		$tokens[] = number_format($pwt, $this->decimals,',','.'); 
		
		$tokens[] = $rec['datein'] ; //49
		$tokens[] = (($cart==true) && (defined("SHCART_DPC"))) ? _m("shcart.getcartCount") + 1 : 0;
		$tokens[] = (($cart==true) && (defined("SHCART_DPC"))) ? _m("shcart.getCartItemPosition use " . $rec[$this->fcode]) : 0;					
								
		//item image or alt image -52		
        $tokens[] = ($otherimgpath) ?
		            $this->httpurl . '/' . $otherimgpath . $rec[$this->fcode] . $this->restype :
		            $this->httpurl . $this->get_photo_url($rec[$this->fcode], $imgsize);	
		
		//item html text -53	
		$tokens[] = $this->show_aditional_html_files($rec[$this->fcode]);						

		return ($tokens);		
	}
	
	//api version
	protected function tokenizeRecordItemApi($rec, $priceID=null, $cart=null, $aliasID=false, $imgsize=1, $otherimgpath=null) {
		if (!$rec) return null;
		$tokens = array(); 
		$pp = $priceID ? $priceID : 'price1';

		//url alias or canonical	
		$id2 = $aliasID ? ($rec[$aliasID] ? $this->stralias($rec[$aliasID]) : $rec[$this->fcode]) : $rec[$this->fcode]; 		
		$aliasExt = _v("cmsrt.aliasExt");
			
		$cat = $this->getkategoriesS(array(0=>$rec['cat0'],1=>$rec['cat1'],2=>$rec['cat2'],3=>$rec['cat3'],4=>$rec['cat4']));
		$price = ($rec[$pp]>0) ? $this->spt($rec[$pp]) : $this->zeroprice_msg;
		$availability = $this->show_availability($rec['ypoloipo1']);	
		$details = null;
		$detailink = ($this->mobile) ? 
						"javascript:window.scrollTo(0,parseInt($('#{$rec[$this->fcode]}-details').offset().top, 10))" :
						//"javascript:gotoTop('{$rec[$this->fcode]}-details')"; //href mozilla err		
						$this->httpurl . '/' . _m("cmsrt.url use t={$this->kshowcmd}&cat=$cat&id=".$rec[$this->fcode]) . "#{$rec[$this->fcode]}-details";
		
		$itemlink = $this->httpurl . '/' . _m("cmsrt.url use t={$this->kshowcmd}&cat=$cat&id=".$rec[$this->fcode]); 
		$itemlinkname = _m("cmsrt.url use t={$this->kshowcmd}&cat=$cat&id=" . $rec[$this->fcode] . "+". $rec[$this->itmname]);
			
		//tokens		
		$tokens['itmname'] = $rec[$this->itmname];
		$tokens['itmdescr'] = $rec[$this->itmdescr];
		$tokens['photo'] =  $this->httpurl . $this->get_photo_url($rec[$this->fcode],1);
		$units = $rec['uniname2'] ? localize($rec['uniname1'], $this->lan) .' / '. localize($rec['uniname2'], $this->lan):
										localize($rec['uniname1'], $this->lan);  
		$tokens['units'] = $units;	
		$tokens['ypoloipo1'] = $rec['ypoloipo1'] ;
		$tokens['itemhasypoloipo'] = $rec['ypoloipo1'] ? '1' : '0';	
		
		$tokens['itmremark'] = $rec['itmremark'];
		$tokens['price'] = number_format(floatval($price),$this->decimals,',','.');
		//price based on qty (with tax)
		$q = GetReq('qty') ? GetReq('qty') : ($incart ? $incart : 1);	
		$priceqty = (($cart==true) && (defined("SHCART_DPC"))) ?
					$this->read_qty_policy($rec[$this->fcode], $price, null, $q) : $price;	
		//echo $priceqty . '>' . $q;
		$pwt = (($cart==true) && (defined("SHCART_DPC"))) ?
				$this->pricewithtax($priceqty, _v('shcart.tax')) : $priceqty;
		$tokens['pricewithtax'] = number_format($pwt, $this->decimals,',','.'); 		
		
		if (($cart==true) && (defined("SHCART_DPC"))) {
			$page = $_GET['page'] ? $_GET['page'] : 0;
			$cart_title = $this->replace_cartchars($rec[$this->itmname]);
			$icon_cart = _m("shcart.showsymbol use {$rec[$this->fcode]};$cart_title;;;$cat;$page;;{$rec[$this->fcode]};$price;1;",1);
			$array_cart = $this->read_qty_policy($rec[$this->fcode],$price,"{$rec[$this->fcode]};$cart_title;;;$cat;$page;;{$rec[$this->fcode]};$price;1");				
			$incart = _m("shcart.getCartItemQty use ".$rec[$this->fcode]);

			/*$cartstr = $rec[$this->fcode].';'.
						$this->replace_cartchars($rec[$this->itmname]).';;;'.
						$cat.';'.$page.';;'.$rec[$this->fcode].';'.$price.';1;';				
							
			$tokens[] = _m("shcart.showsymbol use $cartstr",1);		*/
			$tokens['carticon'] = $icon_cart;
		}	
		else
            $tokens['carticon'] = null;
		
		$tokens['availability'] = $availability;
		$tokens['detailslink'] = $detailink;	
		$tokens['details'] = $details;
		$tokens['itmcode'] = $rec[$this->fcode]; //10
		
		$tokens['itmurl'] = ($aliasID) ? $this->httpurl ."/$cat/$id2" . $aliasExt : $itemlink;			
		$tokens['url'] = $id2 . $aliasExt;
		$tokens['urlx'] = $id2;
		 
		//$tokens['incart'] = $incart; 
		//$tokens['arraycart'] = $array_cart;
		$tokens['incart'] = (($cart==true) && (defined("SHCART_DPC"))) ? $incart : '0';
		$tokens['cartlink'] = $this->httpurl . "/addcart/{$rec[$this->fcode]}/$cat/1/";
						
		//$tokens[] = GetReq('qty') ? GetReq('qty') : $incart; // add qty			
        $tokens['currenttree'] = _m("cmsrt.replace_spchars use $cat+1");  
		$tokens['currentcategory'] = (defined("SHKATEGORIES_DPC")) ? _m("shkategories.getcurrentkategory") : null; 
		
        $tokens['itemhasdiscount'] = $this->item_has_discount($rec[$this->fcode]);	
		$tokens['itemhaspoints'] = $this->item_has_points($rec[$this->fcode]);		
        $tokens['lastprice'] = $rec[$this->getmapf('lastprice')];			
		$tokens['carturl'] = $this->httpurl . "/addcart/{$rec[$this->fcode]}/$cat/1/";						
		$tokens['cartcount'] = (($cart==true) && (defined("SHCART_DPC"))) ?	_m("shcart.getcartCount") + 1 : 0;
		$tokens['cartitemposition'] = (($cart==true) && (defined("SHCART_DPC"))) ?	_m("shcart.getCartItemPosition use " . $rec[$this->fcode]) : 0;			
			 
        $tokens['photo1'] = $this->httpurl . $this->get_photo_url($rec[$this->fcode],1);
        $tokens['photo2'] = $this->httpurl . $this->get_photo_url($rec[$this->fcode],2);	
		$tokens['photo3'] = $this->httpurl . $this->get_photo_url($rec[$this->fcode],3);		
        $tokens['photoalt'] = $this->httpurl . '/images/uphotos/' . $rec[$this->fcode]. 'A' . $this->restype;			
			 
		$tokens['weight'] = $rec['weight'];  
		$tokens['volume'] = $rec['volume'];
		$tokens['dimensions'] = $rec['dimensions'];
		$tokens['size'] = $rec['size'];
		$tokens['color'] = $rec['color'];	
		$tokens['manufacturer'] = $rec['manufacturer'];	

		$tokens['template'] = $rec['template'];
		$tokens['owner'] = $rec['owner'];			  
        $tokens['itmactive'] = $rec['itmactive'];	
		$tokens['active'] = $rec['active'];
			
		$tokens['p1'] = $rec['p1']; 
		$tokens['p2'] = $rec['p2']; 
		$tokens['p3'] = $rec['p3'];
		$tokens['p4'] = $rec['p4'];
		$tokens['p5'] = $rec['p5'];
			
		$tokens['code1'] = $rec['code1']; 
		$tokens['code2'] = $rec['code2'];				
		$tokens['code3'] = $rec['code3'];			
		$tokens['code4'] = $rec['code4'];	
		$tokens['code5'] = $rec['code5'];
		$tokens['resources'] = $rec['resources']; 
		$tokens['tags'] = _m("shtags.get_tags use " . $rec[$this->fcode]);	
		$tokens['itmhtml'] = $this->show_aditional_html_files($rec[$this->fcode]);								
			 
		/*date time */
		$tokens['year'] = $rec['year'];
		$tokens['month'] = $rec['month'];
		$tokens['day'] = $rec['day'];
		$tokens['time'] = $rec['time'];
		$tokens['monthname'] = $rec['monthname'];		

		$tokens['datein'] = $rec['datein'] ; 				
								
		return ($tokens);		
	}	
	
	/* read and create tokens of 1 read item */
	public function fetchProductTokens($prodID=null, $api=false) {
		if (!$prodID) return array();
        $db = GetGlobal('db');
		
		$item = $prodID ? $prodID : $this->realID; //GetReq('id');
		$cat = GetReq('cat');
		$aliasID = _m("cmsrt.useUrlAlias");		
		
	    $sSQL = $this->selectSQL;	
		$sSQL .= " WHERE " . $this->fcode . "=" . $db->qstr($item);
		$sSQL .= ($aliasID) ? " OR {$aliasID}=" . $db->qstr($this->stralias($item)) : null;
		$sSQL .= " and itmactive>0 and active>0";
		
		if (($lock = $this->itemlockparam) && (!GetGlobal('UserID')))
		    $sSQL .=  ' and ' . $lock . ' is null';		  	  
	   
	    $sSQL .= " LIMIT 1";
	    $resultset = $db->Execute($sSQL,2);

	    if (count($resultset->fields)>1) {	
		
			$pp = $this->read_policy(); 
	    	
			foreach ($resultset as $n=>$rec) {	
			    $tokens = array();
				$tokens = ($api==true) ? $this->tokenizeRecordItemApi($rec, $pp, true, $aliasID, 2, false):
										 $this->tokenizeRecordItem($rec, $pp, true, $aliasID, 2, false);
			}	   
	    }//if recs		
		
		return (array) $tokens;
	}		
	
	
	//FILTERS
	
	//filter read (field selector !)
	protected function readfilter($_field=null, $inp=null) {
		$input = $inp ? $inp : GetReq('input');
		$reset_input = array();
		$priceSQL = null;
		$fltname = null;
		$fltvalue = null;
		
		$_allS = (defined("SHKATEGORIES_DPC")) ? _v('shkategories._catAllSearch') : $this->_catAllFilter;		
		
		if (strstr($input, ',')) {
			//multiple values
			$fltvalue = null;
			$fl = explode(',', $input);
			foreach ($fl as $feaf) {
				if (strstr($feaf, ':')) {
					$_hv = explode(':', $feaf);
					$fltname = $_hv[0];
					if ($fltname==$_field) 
						$fltvalue = $this->replace_spchars($_hv[1],1);
					else					
						$reset_input[] = $feaf;  
				}
				elseif (strstr($feaf, '.')) {//if (is_numeric($feaf)) { //get the last element numeric of array (DO NOT SAVE AS ARRAY)
					$_f = $this->read_policy();
					$_prices = explode('.', $feaf);
					$priceSQL = " (" . 
								$_f . ">=" . $this->spt($_prices[0]) . " AND " .
								$_f . "<=" . $this->spt($_prices[1]) . ") ";
								
					$reset_input[] = $feaf;			
				}
				else//if ($feaf) 
					$reset_input[] = $feaf;
			}
		}
		elseif ($input) {//single value
			if (strstr($input, ':')) { //single pair value
				$_hv = explode(':', $input);
				$fltname = $_hv[0];
				if ($fltname==$_field) 
					$fltvalue = $this->replace_spchars($_hv[1],1);
				else
					$reset_input[] = $input;
			}
			elseif (strstr($input, '.')) {//if (is_numeric($input)) { //single numeric value (slider values)
				$_f = $this->read_policy();
				$_prices = explode('.', $input);
				$priceSQL = " (" . 
							$_f . ">=" . $this->spt($_prices[0]) . " AND " .
							$_f . "<=" . $this->spt($_prices[1]) . ") ";
						 
				$reset_input[] = $input;			 
			}			
			elseif ($input!=$_allS) //non * single searchable value (save-reset except * from categories)
				$reset_input[] = $input;
        }		

		return array(0=>$fltname, 1=>$fltvalue, 2=>$reset_input, 3=>$priceSQL, 4=>$input);	
	}	
	
	//manufacturer standart item field
	public function filter($field=null, $template=null, $incategory=null, $cmd=null, $header=null) {	
		if (!$field) return;
		
	    $db = GetGlobal('db');		
		$baseurl = $this->httpurl . '/'; 	
		$command = $cmd ? $cmd : 'search';
		$stype = GetParam('searchtype');
		$scase = GetParam('searchcase');
		$priceSQL = null;	
		$selected = null;	
		$_sel = null;		
		$cat = (GetReq('cat')==$this->_catAllFilter) ? null : GetReq('cat'); //<<< all keyword means no cat
		
		$input = GetReq('input'); //search param or pair: val or comma sep vals
		$reset_input = array();
		
        list($fltname, $fltvalue, $reset_input, $priceSQL, $input) = $this->readfilter($field);		
		//print_r($reset_input);
		
	    $sSQL = "SELECT DISTINCT ".$field.",count(id) from products WHERE "; 	
        if ($incategory) {	
		
			$s = array();
		    $cats = $cat ? explode($this->sep(), $cat) : null;
			if (!empty($cats)) {
				foreach ($cats as $c=>$mycat)
					$s[] = 'cat'.$c ." ='" . $this->replace_spchars($mycat,1) . "'";		  	  
			}  
		}	
		if ($priceSQL)		
			$s[] = $priceSQL;	
		
		$where = (!empty($s)) ? implode(" AND ", $s) : null;			

		$sSQL .= $where ? $where . ' AND ' : null;
		$sSQL .= " itmactive>0 and active>0";
		$sSQL .= " group by " . $field;
		//echo '<br>(' . $input . ')' . $sSQL;	  
	  
		$result = $db->Execute($sSQL,2); 
	  
		if (!empty($result)) {
			
			$contents = (($this->filterajax) && (!$this->mobile)) ? 
					_m('cmsrt.select_template use searchfilter-ajax') : 
					_m('cmsrt.select_template use searchfilter');
			$contents_selected = _m('cmsrt.select_template use searchfilter-selected');						

			$tokens = array(); 
			$r = array();				
			$_cat = $cat ? $cat : $this->_catAllFilter; //when no cat cat=all ('all' special key means no cat)!! (url // act as /)
			
			foreach ($result as $n=>$t) {
				
				if (trim($t[0])!='') {
					$selected = null; //reset
					
			        $f = $this->replace_spchars($field .':'. $t[0]); //<--- add field descr: before value
					if ($t[0] == $this->replace_spchars($fltvalue,1)) { 
						$selected = $f;
						$_sel = $f;
					}	
					//if ($field.':'.$t[0] == $this->replace_spchars($fltname.':'.$fltvalue,1)) $selected = $f;
										
					$ff = !empty($reset_input) ? implode(',', $reset_input) .",". $f : $f; //<---- reset input and set comma sep values (search input, manufacturer, price etc)
					$url = $this->httpurl . "/$command/$_cat/"; //_cat!!!
					$theurl = (($this->filterajax) && (!$this->mobile)) ? 
								"filter('$url','{$this->pageName}','filter0')" : 
								( $selected ? "remFilter('$selected','{$this->pageName}')" : $baseurl . _m("cmsrt.url use t=$command&cat=$_cat&input=$ff")); //$cat=_cat $f=$ff !!
										
					$tokens[] = $t[0];
					$tokens[] = $t[1];
					$tokens[] = $theurl;
					$tokens[] = ($t[0] == $this->replace_spchars($fltvalue,1)) ? 'checked="checked"' : null; //$input = field:value, get the value (fltvalue)
					$tokens[] = $field; 
					
					$_c = $selected ? $contents_selected : $contents;
					$r[] = $this->combine_tokens($_c, $tokens);	
					unset($tokens);			
                }				
			}	   
			
			//header or mobile and not ajax
			//if ((!$this->filterajax) && ($header)) {	
			if (($this->filterajax) && (!$this->mobile)) {
				//nothing
			}	
			elseif (($header) || ($this->mobile)) {

				$theurl = ($_sel) ? "remFilter('$_sel','{$this->pageName}')" :
									$baseurl . _m("cmsrt.url use t={$this->klistcmd}&cat=$cat"); 
				
				$tokens[] = localize('_ALL',$this->lan);
				$tokens[] = $input ? '*' : $this->max_selection;
				$tokens[] = $theurl;
				$tokens[] = (!$input) ? 'checked="checked"' : null;
				$tokens[] = $field; 
				
				$_c = $_sel ? $contents_selected : $contents;
				$r[] = $this->combine_tokens($_c,$tokens);
				unset($tokens);
			}				
		}		
       
		$ret = (empty($r)) ? null : implode('',$r);	
		return ($ret);  
	}	
	
	//view on current item selection and tree groups
	public function filterExt($treename=null, $cmd=null, $header=null) {	
	    $db = GetGlobal('db');	
        if (!$treename) return null;	
		$treecmd = $cmd ? $cmd : 'kfilter';// 'ktree'; //redirect to kfilter			
		//if (!$cat = GetParam('cat')) return null;
		
		$cat = (GetReq('cat')==$this->_catAllFilter) ? null : GetReq('cat'); //<<< all keyword means no cat		
		$priceSQL = null;	
		$selected = null;
		$_sel = null;
		$r = array();		
		$input = GetReq('input');

        list($fltname, $fltvalue, $reset_input, $priceSQL, $input) = $this->readfilter($treename);		
		//print_r($reset_input);

		$content = _m('cmsrt.select_template use extfilter');			
		$linecontent = (($this->filterajax) && (!$this->mobile)) ? 
						_m('cmsrt.select_template use extfilterline-ajax') :
					    _m('cmsrt.select_template use extfilterline');
		$linecontent_selected = _m('cmsrt.select_template use extfilterline-selected');					

		$sSQL = "select tname,tname{$this->lan},active,tid from ctree where active=1 and tname='$treename'";
		$res = $db->Execute($sSQL);
			
		if (!$active = $res->fields[2]) 
			return null;
		
		$parent = $res->fields[3];
		
		$toks[] = $res->fields[1] ? $res->fields[1] : $res->fields[0];								
		
		$s = array();
	    $cats = $cat ? explode($this->sep(), $cat) : null;
		if (!empty($cats)) {
			foreach ($cats as $c=>$mycat)
				$s[] = 'cat'.$c ." ='" . $this->replace_spchars($mycat,1) . "'";		  	  
		}  
		$subwhere = (!empty($s)) ? implode(" AND ", $s) : null;			
		$where = ($subwhere) ? 	$subwhere . " AND itmactive>0 and active>0" : 
								" itmactive>0 and active>0";	
		
		$sSQL = "select ctree.tid,ctree.tname,ctree.tname{$this->lan} from ctreemap,ctree where ";
		$sSQL.= "code IN (select id from products where $where) ";
		$sSQL.= "and ctreemap.tid=ctree.tid and ctree.pid='$parent' group by ctree.tid order by ctree.orderid,ctree.id";
		//echo $sSQL;
		$res = $db->Execute($sSQL); 

		if (!empty($res)) {
			
			$_cat = $cat ? $cat : $this->_catAllFilter; //<<< all keyword means no cat
			
			//single name for one filter applied url
			//or common name for all filters applied url			
			$treename = 'filter1';		
			$tokens = array(); 
			
			foreach ($res as $n=>$rec) {
				$selected = null; //reset
				
				$title = $rec[2] ? $rec[2] : $rec[1];
				$treeid = $this->replace_spchars($treename .':'. $title); //$rec[0]; //0
				if ($title == $this->replace_spchars($fltvalue,1)) {
					$selected = $treeid;
					$_sel = $treeid;
				}						
				
				$ff = !empty($reset_input) ? implode(',', $reset_input) .",". $treeid : $treeid; //<---- reset input and set comma sep values (search input, manufacturer, price etc)
				$url = $this->httpurl . "/$treecmd/$_cat/$treename:";
				$theurl = (($this->filterajax) && (!$this->mobile)) ? 
							"filter('$url','{$this->pageName}','$treename')" : 
							( $selected ? "remFilter('$selected','{$this->pageName}')" : $this->httpurl . '/' . _m("cmsrt.url use t=$treecmd&cat=$_cat&treeid=$ff")); //=treeid
							
				$tokens[0] = $title; //$rec[2] ? $rec[2] : $rec[1]; //title
				$tokens[1] = $rec[0]; //value
				$tokens[2] = $theurl; //ajax url
				$tokens[3] = ($title == $this->replace_spchars($fltvalue,1)) ? 'checked="checked"' : null; //rec[0]=
				$tokens[4] = $treename; 
				
				$_c = $selected ? $linecontent_selected : $linecontent;				
				$r[] = $this->combine_tokens($_c,$tokens);	
				unset($tokens);		
			}	
			
			//header or mobile and not ajax
			//if ((!$this->filterajax) && ($header)) {	
			if (($this->filterajax) && (!$this->mobile)) {
				//nothing
			}	
			elseif (($header) || ($this->mobile)) {
				
				$theurl = ($_sel) ? "remFilter('$_sel','{$this->pageName}')" :
									$baseurl . _m("cmsrt.url use t={$this->klistcmd}&cat=$cat"); 
									  
				$tokens[] = localize('_ALL',$this->lan);
				$tokens[] = $input ? '*' : $this->max_selection;
				$tokens[] = theurl; 
				$tokens[] = (!$input) ? 'checked="checked"' : null;
				$tokens[] = $treename; 
				
				$_c = $_sel ? $linecontent_selected : $linecontent;
				$r[] = $this->combine_tokens($_c,$tokens);				
				unset($tokens);
			}			

			if (!empty($r)) {
				$toks[] = implode('',$r);	
				$ret = $this->combine_tokens($content,$toks);
				unset($toks);	  			
			}	
		}
		
		return ($ret); 
    }
	
	//all tree groups, view in any category
	public function filterExtAll($usedescr=false, $cmd=null, $header=null) {
	    $db = GetGlobal('db');		
		$treecmd = $cmd ? $cmd : 'kfilter'; // 'ktree'; //redirect to kfilter
		
		$cat = (GetReq('cat')==$this->_catAllFilter) ? null : GetReq('cat'); //<<< all keyword means no cat		
		$priceSQL = null;	
		$selected = null;
		$_sel = null;
		$r = array();	
		$ret = null;	
		
		$input = GetReq('input');		
		$reset_input = array();						
		
		$sSQL = "select tid,tname,tname{$this->lan} from ctree where";
		$sSQL.= " active=1 and pid='0' and items=1";
		if ($usedescr) { 
			//cat based tree filters show
			$fsQL = "select tid from ctreedescr where attr=" . $db->qstr($cat);
			$resf = $db->Execute($fsQL);
			foreach ($resf as $m=>$rem) 
				$fshow[] = $rem[0];
            //echo $fsQL; print_r($fshow);
			if (!empty($fshow)) 
				$sSQL .= " and tid in ('" . implode("','", array_unique($fshow)) . "')";		
			else
				return null; //no filter view, exit		
		}		
		$sSQL.= " order by orderid";
		//echo $sSQL;
		$res = $db->Execute($sSQL); 
		if (!empty($res)) {
			
			$content = _m('cmsrt.select_template use extfilter');			
			$linecontent = (($this->filterajax) && (!$this->mobile)) ? 
						_m('cmsrt.select_template use extfilterline-ajax') :
					    _m('cmsrt.select_template use extfilterline');	
			$linecontent_selected = _m('cmsrt.select_template use extfilterline-selected');				
			
			$_cat = $cat ? $cat : $this->_catAllFilter; //<<< all keyword means no cat
			
			//single name for one filter applied url
			//or common name for all filters applied url			
			//$treename = 'filter1'; //or ..DISABLE to get the name of tree				
			
			foreach ($res as $n=>$rec) {
				$groupname = $rec[1]; //$treename ? $treename : $rec[1]; //..filter name //<<<<<
				list($fltname, $fltvalue, $reset_input, $priceSQL, $input) = $this->readfilter($groupname);
				//print_r($reset_input);
				
				$toks[] = $rec[2] ? $rec[2] : $rec[1];
				
				$sSQL = "select tid,tname,tname{$this->lan} from ctree where ";
				$sSQL.= "active=1 and pid='{$rec[0]}' and items=1 ";				
				$sSQL.= "order by orderid";
				//echo $sSQL;
				$res = $db->Execute($sSQL);
				if (!empty($res)) {
					
					$r = array(); //reset
					foreach ($res as $n=>$rec) {
						$selected = null; //reset
						
						$title = $rec[2] ? $rec[2] : $rec[1];
						$code = $rec[0]; //$title;
						$treeid = $this->replace_spchars($groupname .':'. $code);//$title); //$rec[0]; //!!!! set title to use the string not the id 
						//if ($title == $this->replace_spchars($fltvalue,1)) {
						if ($code == $this->replace_spchars($fltvalue,1)) {	
							$selected = $treeid;
							$_sel = $treeid;
						}							
												
						$ff = !empty($reset_input) ? implode(',', $reset_input) .",". $treeid : $treeid; //<---- reset input and set comma sep values (search input, manufacturer, price etc)
						$url = $this->httpurl . "/$treecmd/$_cat/$groupname:";
						$theurl = (($this->filterajax) && (!$this->mobile)) ? 
									"filter('$url','{$this->pageName}','$groupname')" : 
									( $selected ? "remFilter('$selected','{$this->pageName}')" : $this->httpurl . '/' . _m("cmsrt.url use t=$treecmd&cat=$_cat&treeid=$ff")); //= treeid
										
						$tokens[0] = $title; //$rec[2] ? $rec[2] : $rec[1];
						$tokens[1] = $rec[0]; //id
						$tokens[2] = $theurl;	
						//$tokens[3] = ($title == $this->replace_spchars($fltvalue,1)) ? 'checked="checked"' : null; //rec[0]=
						$tokens[3] = ($code == $this->replace_spchars($fltvalue,1)) ? 'checked="checked"' : null; //rec[0]=
						$tokens[4] = $groupname;
						
						$_c = $selected ? $linecontent_selected : $linecontent;							
						$r[] = $this->combine_tokens($_c,$tokens);	
						unset($tokens);						
					}
					
					//header or mobile and not ajax
					//if ((!$this->filterajax) && ($header)) {	
					if (($this->filterajax) && (!$this->mobile)) {
						//nothing
					}	
					elseif (($header) || ($this->mobile)) {
						
						$theurl = ($_sel) ? "remFilter('$_sel','{$this->pageName}')" :
												$baseurl . _m("cmsrt.url use t={$this->klistcmd}&cat=$cat"); 					
						
						$tokens[] = localize('_ALL',$this->lan);
						$tokens[] = $input ? '*' : $this->max_selection;
						$tokens[] = $theurl;
						$tokens[] = (!$input) ? 'checked="checked"' : null;
						
						$_c = $_sel ? $linecontent_selected : $linecontent;
						$r[] = $this->combine_tokens($_c,$tokens);							
						unset($tokens);
					}
					
					$toks[] = (empty($r)) ? null : implode('',$r);	
					$ret .= $this->combine_tokens($content,$toks);	
					unset($toks);
				}		
			}			
		}
		
		return ($ret);	
	}
	
	//delete filters
	public function filterDel() {	
		$_searchphrase = localize('_SEARCH', $this->lan);
		$_pricephrase = localize('_pricerange', $this->lan);	
		$baseurl = $this->httpurl . '/'; 	
		$command = 'kfilter';
		$cat = (GetReq('cat')==$this->_catAllFilter) ? null : GetReq('cat'); 
		$_allS = (defined("SHKATEGORIES_DPC")) ? _v('shkategories._catAllSearch') : $this->_catAllFilter;	
		
		$input = GetReq('input'); 
		if (!$input) return null;
		$reset_input = explode(',', $input);
		$reset_counter = count($reset_input);
	  
		$r = array();	  
		if (!empty($reset_input)) {
			$contents = _m('cmsrt.select_template use searchfilter');
			$contents_selected = _m('cmsrt.select_template use searchfilter-selected');
			$tokens = array(); 	
			
			$_cat = $cat ? $cat : $this->_catAllFilter;
			foreach ($reset_input as $n=>$t) {
				if (trim($t[0])!='') {
					
					if (strstr($t, ':')) { //single pair value
						$_hv = explode(':', $t);
						$hvtitle = localize('_'. strtoupper($_hv[0]), $this->lan);
						$fltname = ($hvtitle[0]!='_') ? $hvtitle : $_hv[0];
						$fltvalue = $this->replace_spchars($_hv[1],1);
						$title = localize('_'. strtoupper($fltname), $this->lan);
					}
					elseif (strstr($t, '.')) {//if (is_numeric($t)) { //single numeric value (slider values)
						$fltname = $_pricephrase;
						$fltvalue = str_replace('.', '..', strval($t));		 
					}			
					elseif ($t!=$_allS) {//non * single searchable value (save-reset except * from categories)
						$fltname = $_searchphrase;
						$fltvalue = $t;				
					}
					else {
						$fltname = null;
						$fltvalue = null;
					}		
					
					if ($fltname) {
						$url = $this->httpurl . "/$command/$_cat/"; //_cat!!!
						$div = $this->pageName;
						$theurl = "remFilter('$t','$div')";
							
						$tokens[] = $fltname;
						$tokens[] = '<del>'.$fltvalue .'</del>';
						$tokens[] = $theurl;
						$tokens[] = null;
						$tokens[] = 'delFilter';
						$r[] = $this->combine_tokens($contents_selected,$tokens);	
						unset($tokens);	
					}					
                }				
			}

					
			//remove all link
			if ($reset_counter > 1) {
				$tokens[] = localize('_ALL',$this->lan);
				$tokens[] = $this->max_selection ? '<del>selected ' . $this->max_selection . '</del>' : '<del>selected</del>';
				$tokens[] = $baseurl . _m("cmsrt.url use t={$this->klistcmd}&cat=$cat"); 
				$tokens[] = (!$input) ? 'checked="checked"' : null;
				$tokens[] = 'delFilter';
				
				$r[] = $this->combine_tokens($contents,$tokens);
				unset($tokens);				
			}
		}		
       
		$ret = (empty($r)) ? null : implode('',$r);	
		return ($ret);  
	}

	
	

	//CART PRICE QTY POLICY	
	
	//used by shcart to reupdate prices in login
	public function update_prices($cartitems) {
		$db = GetGlobal('db');
		$p_ret = null;
	   
		$items = unserialize($cartitems);
		$pfield = $this->read_policy();
	   
		if (is_array($items)) {
			foreach ($items as $prod_id => $product) {
				if (($product) && ($product!='x')) {	   
		  
					$param = explode(";",$product);		  
	   
					$sSQL = "select ".$pfield." from products ";
					$sSQL .= " WHERE ".$this->fcode."='".$param[0]."'";	   	   
					$result = $db->Execute($sSQL,2);	
			
					$p_ret[$param[0]] = $this->spt($result->fields[0]);
				}
			}
			return ($p_ret);  
		}

        return null;
	}	

	//select price type..overriten error when no cart
	public function spt($price,$tax=null) {

		if ($tax) 
			$p = $this->pricewithtax($price, $tax);	  
		elseif ($this->is_reseller) 
			$p = $price;
		elseif ((defined('SHCART_DPC')) && (_v('shcart.showtaxretail'))) 
			$p = $this->pricewithtax($price, _v('shcart.tax'));
		else
			$p = $price;		

		return ($p);
	}
	
	public function read_policy($leeid=null) {
		 
		$v = $this->is_reseller ? $this->pprice[0] : $this->pprice[1]; 
		return ($v);
	}			
	
	public function read_qty_policy($itemcode=null,$price=null,$cart_details=null,$policyqty=null) {
		$db = GetGlobal('db');		
		$cat = GetReq('cat');
		$cart_page = GetReq('page') ? GetReq('page') : 0;	  	
		$cartd = explode(';',$cart_details);		

		$sSQL = "select data from ppolicyres where ispoints=0 and code=" . $db->qstr($itemcode);
		$res = $db->Execute($sSQL);
	
		if ($res->fields[0]) {	  
	
			$data_array = @parse_ini_string(base64_decode($res->fields[0]), 1, INI_SCANNER_RAW);
			//print_r($data_array);
			if ($policyqty) {
				if (is_array($data_array['QTY'])) {
					foreach ($data_array['QTY'] as $ix=>$ax) {
						if ($policyqty>=$ax) {
							$pc = intval($data_array['PRICE'][$ix]);
							$retprice = $price ? $price+($price*$pc/100) : $pc;
						}
					}
					return ($retprice ? $retprice : $price);
				}
			}
			else {  //2nd item cart pick
				$style = $data_array['style'];
				$titlesON = $data_array['titles'];
				$elements = $titlesON?1:0;	
				
				$template = $data_array['template'] ? $data_array['template'] : 'fpitempolicy';
				$mylooptemplate = _m("cmsrt.select_template use $template");
				$data = array(); 
				foreach ($data_array['PRICE'] as $ix=>$ax) {
					$data[] = $data_array['QTY'][$ix];
					$cartd[8] = $price ? $price+($price*$ax/100) : $ax;
					$cartd[9] = intval($data_array['QTY'][$ix]);//prev line //'12';
					$data[] =	number_format($cartd[8],$this->decimals,',','.');		  
					$cartout = implode(';',$cartd);
					$data[] = _m("shcart.showsymbol use $cartout;+0+".$cartd[9],1);
					$data[] = $itemcode;
					//$data[] = "addcart/$cartout/$cat/0/";
					$data[] = "addcart/$itemcode/$cat/0/";
					$body = $this->combine_tokens($mylooptemplate,$data,true);	
					unset($data);			  
				}		
				//echo $body;
				return ($body); 				
			} 
		}	
		
		return $policyqty ? $price : null;
	}	
	
	public function read_point_policy($id=null) {
		if (!$id) return 0;		
		$db = GetGlobal('db');

		$sSQL = "select data from ppolicyres where ispoints=1 and code=" . $db->qstr($id);
		$res = $db->Execute($sSQL);

		if ($data = base64_decode($res->fields[0])) {
			return _m('cmsrt.phpcode use ' . $data);
		}
			
		return 0;		
	}			
	
	public function item_has_points($id=null) {
		if ((!$this->loyalty) || (!$id)) return null;	

		return $this->read_point_policy($id);	
	}	
	
	public function item_has_discount($id=null) {
		if (!$id) return false;
		$db = GetGlobal('db');

		$sSQL = "select data from ppolicyres where ispoints=0 and code=" . $db->qstr($id);
		$res = $db->Execute($sSQL);

		if ($data = base64_decode($res->fields[0])) {	
			return true;
		}
			
		return false;	
	}	
	
	

	// ETC
	
	public function item_var($field=null,$code=null, $photosize=null, $array=null) {	
        $db = GetGlobal('db');					
		$lastprice = $this->getmapf('lastprice') ? ',' . $this->getmapf('lastprice') : null;		
		
		$itemcode = $code ? $code : $this->realID;
	    $retfield = $field ? $field : $this->itmname;	                       
						   
        $sSQL = $this->selectSQL;
		$sSQL .= " WHERE " . $this->fcode . "='" . $itemcode ."'";	
		
	    $resultset = $db->Execute($sSQL,2);	
		
		if (($retfield=='sysins') || ($retfield=='sysupd'))
			$ret = date("d-m-Y", strtotime($resultset->fields[$retfield]));
		else
			$ret = $resultset->fields[$retfield];
		
        $out = ($array) ? $resultset->fields : $ret;
		return ($out);	
	}		

	public function get_xml_links($mylan=null,$feed_id=null,$dpcfeed=null) {
		$lan = $mylan ? $mylan : getlocal();
		$lnk = array();
		$id = $this->realID; //GetReq('id');
		$cat = GetReq('cat'); //echo $cat;
		$page = GetReq('page') ? GetReq('page') : '0';
		$feed_cmd = $feed_id ? $feed_id : 'feed';	  

		$mytemplate = _m('cmsrt.select_template use xml-links');
	  
		//RSS	
		if (stristr($this->feed_on,'rss')) {
			if ($dpcfeed) //special phpdac page without params			  
				$lnk['RSS'] = _m("cmsrt.url use t=$feed_cmd&dpc=$dpcfeed&format=rss2"); 
			elseif ($id)
				$lnk['RSS'] = _m("cmsrt.url use t=$feed_cmd&cat=$cat&page=$page&id=$id&format=rss2"); 
			elseif ($cat)
				$lnk['RSS'] = _m("cmsrt.url use t=$feed_cmd&cat=$cat&page=$page&format=rss2"); 
			else  
				$lnk['RSS'] = _m("cmsrt.url use t=$feed_cmd&format=rss2"); 
		}
		//ATOM
		if (stristr($this->feed_on,'atom')) {	  
			if ($dpcfeed) //special phpdac page without params		  
				$lnk['ATOM'] = _m("cmsrt.url use t=$feed_cmd&dpc=$dpcfeed&format=atom"); 
			elseif ($id)
				$lnk['ATOM'] = _m("cmsrt.url use t=$feed_cmd&cat=$cat&page=$page&id=$id&format=atom"); 
			elseif ($cat)
				$lnk['ATOM'] = _m("cmsrt.url use t=$feed_cmd&cat=$cat&page=$page&format=atom"); 
			else  
				$lnk['ATOM'] = _m("cmsrt.url use t=$feed_cmd&format=atom"); 	  
		}		

		if (!empty($lnk)) {
			foreach ($lnk as $t=>$w) {    
				if ($w) {
					$icon_file = $this->urlpath.'/'.$this->infolder.'/images/'.strtolower($t).'.png';
					if (is_readable($icon_file)) 
						$mylink = "<img src=\"". $this->infolder.'/images/'.strtolower($t).'.png' ."\" border=\"0\" alt=\"$t\">";
					else 
						$mylink = $t;
			  
					$tokens[] = "<a href=\"$w\">".$mylink."</a>";
				}	
			}
		
			$out = $this->combine_tokens($mytemplate, $tokens);
		}

		return ($out);  
	}	
	
	//set ordersing online using <phpdac>
	public function set_order($orderby=null,$asc=null) {

		$this->myorder = $orderby ? $orderby : null;
		$this->myasc = $asc;  
	}
		
	public function show_availability($qty=null) {
		if (!$this->availability) 
			return 0;

		$r_scale = array_reverse($this->availability,1);
		
		foreach ($r_scale as $i=>$s) 
			if (floatval($qty)>=floatval($s)) return ($i+1);

		return 0;
	}
		
	protected function replace_spchars($string, $reverse=false) {
		/*
		$rp = null;//_v('shkategories.replacepolicy'); DISABLE POLICY
	
		switch ($rp) {	
	
			case '_' : $ret = $reverse ?  str_replace('_',' ',$string) : str_replace(' ','_',$string); break;
			case '-' : $ret = $reverse ?  str_replace('-',' ',$string) : str_replace(' ','-',$string);break;
			default :	*/
			if ($reverse) {
				$g1 = array("'",',','"','+','/',' ',' & ');
				$g2 = array('_','~',"*","plus",":",'-',' n ');		  
				$ret = str_replace($g2,$g1,$string);
			}	 
			else {
				$g1 = array("'",',','"','+','/',' ','-&-');
				$g2 = array('_','~',"*","plus",":",'-','-n-');		  
				$ret = str_replace($g1,$g2,$string);
			}	
	    /*} */
		return ($ret);
	}
	
	//use at javascript replace
	protected function replace_jschars($reverse=false) {
		$char = array();
		if ($reverse) {
			$g1 = array("'",',','"','+','/',' ',' & ');
			$g2 = array('_','~',"*","plus",":",'-',' n ');
			foreach ($g2 as $i=>$k) 
				$char[$k] = $g1[$i];			
		}	 
		else {
			$g1 = array("'",',','"','+','/',' ','-&-');
			$g2 = array('_','~',"*","plus",":",'-','-n-');		  	
			foreach ($g1 as $i=>$k) 
				$char[$k] = $g2[$i];		
		}		
		
		foreach ($char as $from=>$to) {
			//escape "
			$f = (strstr($from, "'")) ? "'\''" : "'$from'"; 
			$t = (strstr($to, "'")) ? "'\''" : "'$to'";
			$r[] = $f . ':' . $t;
		}	
			
		$ret = (empty($r)) ? null : implode(', ', $r);
		return ($ret);
	}	
	
	public function replace_cartchars($string, $reverse=false) {
		if (!$string) return null;

		$g1 = array("'",',','"','+','/',' ','-&-');
		$g2 = array('_','~',"*","plus",":",'-','-n-');		
	  
		return $reverse ? str_replace($g2,$g1,$string) : str_replace($g1,$g2,$string);
	}	
	
	public function stralias($string) {
		
		return _m('cmsrt.stralias use '. $string);
	}	
	
	protected function getkategoriesS($categories) {	
		$c = $this->sep();
		/*			
		//$rp = _v('shkategories.replacepolicy');	//!!!!!!!		
		$rp =null;
		//switch ($this->replacepolicy) { //DISABLE POLICY
		switch ($rp) {
			
			case '_' : $g1 = ' '; $g2 ='_'; break;
			case '-' : $g1 = ' '; $g2 ='-'; break;			
			default :*/
					$g1 = array("'",',','"','+','/',' ','-&-');
					$g2 = array('_','~',"*","plus",":",'-','-n-');		
		/*}*/
		
		if (empty($categories)) return null;
		foreach ($categories as $i=>$cat)
			if ($cat) $xc[] = str_replace($g1,$g2,$cat);
			
		$ret = (empty($xc)) ? null : implode($c, $xc);
		return ($ret);
	}
	/* https://developers.facebook.com/docs/reference/opengraph/object-type/product/
  <meta property="product:original_price:amount"   content="Sample Original Price: " /> 
  <meta property="product:original_price:currency" content="Sample Original Price: " /> 
  <meta property="product:pretax_price:amount"     content="Sample Pre-tax Price: " /> 
  <meta property="product:pretax_price:currency"   content="Sample Pre-tax Price: " /> 
  <meta property="product:price:amount"            content="Sample Price: " /> 
  <meta property="product:price:currency"          content="Sample Price: " /> 
  <meta property="product:shipping_cost:amount"    content="Sample Shipping Cost: " /> 
  <meta property="product:shipping_cost:currency"  content="Sample Shipping Cost: " /> 
  <meta property="product:weight:value"            content="Sample Weight: Value" /> 
  <meta property="product:weight:units"            content="Sample Weight: Units" /> 
  <meta property="product:shipping_weight:value"   content="Sample Shipping Weight: Value" /> 
  <meta property="product:shipping_weight:units"   content="Sample Shipping Weight: Units" /> 
  <meta property="product:sale_price:amount"       content="Sample Sale Price: " /> 
  <meta property="product:sale_price:currency"     content="Sample Sale Price: " /> 
  <meta property="product:sale_price_dates:start"  content="Sample Sale Price Dates: Start" /> 
  <meta property="product:sale_price_dates:end"    content="Sample Sale Price Dates: End" />
*/  
	protected function openGraphTags($tokens=null) {
		if (!$tokens) return null;
		$localization = ($this->lan==1) ? 'el_gr' : 'en_us';
		
		//multiple images
		if (is_array($tokens[4])) { 
		    //print_r($tokens[4]);
			foreach ($tokens[4] as $i=>$img)
				$ogimage .= '
		<meta property="og:image" content="'. $img .'" />';
		}
		else
			$ogimage = '<meta property="og:image" content="'.$tokens[4].'" />
';
		
		$ret = <<<EOF
				
		<meta property="og:site_name" content="$tokens[0]" />		
		<meta property="og:title" content="$tokens[1]" />
		<meta property="og:description" content="$tokens[2]" />
		<meta property="og:type" content="product" />
		<meta property="og:url" content="$tokens[3]" />
	    <meta property="og:locale" content="$localization"/>		
		$ogimage
		
EOF;
		
        //extract first image or just one
        $img = is_array($tokens[4]) ? array_shift($tokens[4]) : $tokens[4];

        $ret .= $this->facebookApp ? 
				$this->fbTags(array(0=>$tokens[0],1=>$tokens[1],2=>$tokens[2],3=>$tokens[3],4=>$img)) : 
				null;
		$ret .= $this->twitterApp ? 
				$this->twitterTags(array(0=>$tokens[0],1=>$tokens[1],2=>$tokens[2],3=>$tokens[3],4=>$img)) : 
				null;
		
		$ret .= $this->ldTags(array(0=>$tokens[0],1=>$tokens[1],2=>$tokens[2],3=>$tokens[3],4=>$img)) ;
		
        return $ret;
	}
	
	public function getOGTags() {
		
		return ($this->ogTags);
	}
	
	//The card type, which will be one of summary, summary_large_image, photo, gallery, product, app, or player			
	protected function twitterTags($tokens=null) {
		if (!$tokens) return null;
		
		$twitter = explode('/', $this->siteTwitter); 
		$taddr = '@' . array_pop($twitter); //get last token
		
		$ret = <<<EOF
		
		<meta name="twitter:widgets:csp" content="on">
		<meta name="twitter:card" content="product">
		<meta name="twitter:site" content="$taddr">
		<meta name="twitter:domain" content="$tokens[0]">
		<meta name="twitter:title" content="$tokens[1]">
		<meta name="twitter:description" content="$tokens[2]">
		<meta name="twitter:image" content="$tokens[4]" />	
		
EOF;
        return $ret;
	}
	
	protected function fbTags($tokens=null) {
		if (!$tokens) return null;
		
		$fb = explode('/', $this->siteFb); 
		$fbaddr = array_pop($fb); //get last token
		
		if (defined('SHLOGIN_DPC'))
			$fbid = _v('shlogin.facebook_id');
		else
			$fbid = _v('cmslogin.facebook_id');
		
		$ret = <<<EOF
		
	    <meta property="fb:app_id" content="$fbid" />
		<meta property="fb:admins" content="$fbattr" />	
EOF;
        return $ret;
	}	
	
	protected function ldTags($tokens=null) {
		if (!$tokens) return null;
		
		//$kw = _m('shtags.get_page_info use keywords');
		//$keywords = str_replace(',""','' , '"' . str_replace(',', '","', $kw) . '"');
		$keywords = '"'. str_replace($this->sep(), '","', $tokens[2]) . '"';
		
		$ret = <<<EOF
		
		<script type="application/ld+json">
		{
		"@context": "http://schema.org",
		"@type": "Product",
		"name": "$tokens[1]",
		"description: "$tokens[2]",
		"image:" "$tokens[4]", 
		"url": "$tokens[3]",
		"keywords": [$keywords]
		}
		</script>	
EOF;
        return $ret;
	}
	
	//http://stackoverflow.com/questions/20060608/select-onchange-event-on-mobile
	public function make_combo($url2go,$values,$title=null,$selection=null,$style=null) {
	    $mystyle = $style ? $style : $this->asccombostyle;
		$name = $title ? $title : 'name' . md5($url2go);
		$size = null;
	
		$r = "<select name=\"".$name."\" class=\"" . $mystyle . "\"" . ( $size != 0 ? "size=\"".$size."\"" : "");
		$r.= (($this->filterajax) && (!$this->mobile)) ? 
				" onChange=\"ajaxCall(this.options[this.selectedIndex].value,'{$this->pageName}',1)\">" :
				" onChange=\"location=this.options[this.selectedIndex].value\">";
			  
		if (!empty($values) && ($title)) 	  
			$r .= "<option value=''>---$name---</option>";	
		  
		foreach ($values as $i=>$v) {
		    $myvalue = str_replace('#',$i,$url2go); 
			$r .= "<option value=\"$myvalue\"".($i == $selection ? " selected" : "").">$v</option>";		
		}  
		
		$r .= "</select>";
				
		return ($r);  
	}

	public function fnum($n, $dec_digits, $dp=null, $tp=null) {
	  $dec = $dp ? $dp : $this->decimals;
      $ret = number_format(floatval($n),$dec_digits,$dec,$tp);
      return ($ret);	  
	}	
	
	public function pricewithtax($price,$tax=null) {
	
		if ($tax) {
			$mytax = ((floatval($price) * $tax)/100);	
			$value = (floatval($price) + $mytax);		  
		}
		else {
			if (defined('SHCART_DPC')) {
				$tax = _v('shcart.tax'); 
				$mytax = ((floatval($price) * $tax)/100);	
				$value = (floatval($price) + $mytax);		  
			}
			else		
				$value = floatval($price);
		}	
	
		return ($value);
	}	
	
	public function getmapf($name) {
		$ch = null;
		if (empty($this->map_t)) return 0;	
	  
		foreach ($this->map_t as $id=>$elm) {	    
			if ($elm==$name) {
				$ch = $id;
				break;
			}  
		}			

		$ret = isset($this->map_f[$ch]) ? $this->map_f[$ch] : null;
		return ($ret);
	}	
	
	public function encode_image_id($id=null) {
	    if (!$id) return null;
		$out = _m("cmsrt.encode_image_id use $id+".$this->encodeimageid); //$this->encodeimageid ? md5($id) : $id;
        return $out;
	}		

	protected function sep() {
		$s = _v('cmsrt.cseparator'); //$this->cseparator;
		return $s;
	}
	
	/*two view methods for items */
	protected function make_table_list($items_table=null, $items_list=null, $template_table=null, $template_list=null, $pcat=null) {
	    $cat = $pcat ? $pcat : GetReq('cat'); 		
		$mytemplate_table = $this->select_template($template_table, $cat);
		$mytemplate_list = $this->select_template($template_list, $cat);
		$mytemplate_tablelist = $this->select_template('fpkatalog-grid-list', $cat);
		$tokens = array();
		
        if ($mytemplate_tablelist) { 
		
			//grid 
			$table_token[] = (!empty($items_table)) ? implode('',$items_table) : null; 
			$tokens[] = $this->combine_tokens($mytemplate_table, $table_token);
            //list
			$list_token[] = (!empty($items_list)) ? implode('',$items_list) : null; 
			$tokens[] = $this->combine_tokens($mytemplate_list, $list_token);
			
			$toprint = $this->combine_tokens($mytemplate_tablelist, $tokens);
			
			unset ($tokens);
			unset ($table_token);
			unset ($list_token);
		}	
        return ($toprint); 		
    }	
	
	protected function make_table($items=null, $mylinemax=null, $template=null, $pcat=null) {
	    $cat = $pcat ? $pcat : GetReq('cat'); 	
		$mytemplate = $template ? $this->select_template($template, $cat) : null;

	    if ($items[0]) {
	        //make table
	        $itemscount = count($items);
	        $timestoloop = floor($itemscount/$mylinemax)+1;
	        $meter = 0;
			$linetoken = null;
			$tokens = array();
			
	        for ($i=0;$i<$timestoloop;$i++) {

				for ($j=0;$j<$mylinemax;$j++) {
					$linetoken .= $items[$meter];
					$meter+=1;	 
				}
				$tokens[] = $linetoken; 
                $toprint .= $this->combine_tokens($mytemplate, $tokens);					
				$linetoken = null; 
				$tokens = array();
  
	        }
		}	
        return ($toprint); 		
    }			
	
	/*cat based select */
	protected function select_template($tmpl=null,$cat=null) {
		if (!$tmpl) return null;		
		return _m("shkategories.select_template use $tmpl+$cat");
	}
	
	/* analytics submit script */
	protected function submitScript($referer=null, $tokens=null) {
		$ret = "/* $referer submit analytics script */". PHP_EOL;
		$tmplbody = $referer ? $referer . '-js-analytics' : 'katalog-js-analytics';

		//$ret = _m("cmsrt._ct use $tmplbody+" . serialize($tokens) . '+1');			
		//return ($ret);			
		if ($template = _m("cmsrt.select_template use $tmplbody")) 
			return $this->combine_tokens($template, $tokens, true);		
	}
	
    /*call from this submit_order */
	protected function analytics($event=null, $tokens=null) {
		if (!defined('JAVASCRIPT_DPC')) return ;		
		
		if (!$tokens) return null;
		$localization = ($this->lan==1) ? 'el_gr' : 'en_us';		
		$referer = $_SESSION['http_referer']; //as saved by vstats
		
		$rstr = _m('cms.paramload use ESHOP+refererAnalytics');
		$refs = $rstr ? str_replace(',','|',strtolower($rstr)) : "skroutz|bestprice|google";
		//echo 'refs:' . $refs;
		
		//create analytics script if referer
		if (preg_match("/($refs)/i", $referer, $matches)) {
			$_referrer = $event ? $matches[0].'-'.$event : $matches[0];
			$code = $this->submitScript($_referrer, $tokens);	
		}
		$code .= $this->submitScript($event, $tokens);
		
		if ($code) {
			$js = new jscript;	
			$js->load_js($code,"",1);			   
			unset ($js);
		}	
	}	
	
	//tokens method	
	protected function combine_tokens(&$template_contents, $tokens, $execafter=null) {
		//$toks = serialize($tokens);
		//return _m("cmsrt.combine_tokens use $template_contents+$toks+$execafter");
	    if (!is_array($tokens)) return;
		$ret = null;
		
		if ((!$execafter) && (defined('FRONTHTMLPAGE_DPC'))) {
			$fp = new fronthtmlpage(null);
			$ret = $fp->process_commands($template_contents);
			unset ($fp);		  		
		}		  		
		else
			$ret = $template_contents;
		  
	    foreach ($tokens as $i=>$tok) {
		    $ret = str_replace("$".$i."$",$tok,$ret);
	    }

		for ($x=$i;$x<60;$x++)
			$ret = str_replace("$".$x."$",'',$ret);
		
		if (($execafter) && (defined('FRONTHTMLPAGE_DPC'))) {
			$fp = new fronthtmlpage(null);
			$retout = $fp->process_commands($ret);
			unset ($fp);
          
			return ($retout);
		}		
		
		return ($ret);
	}

	//filter func
	public function apiGetFilter($cmd=null, $field=null, $template=null, $incategory=null) {	
		if (!$field) return;
		
	    $db = GetGlobal('db');		
		$baseurl = $this->httpurl . '/'; 	
		$command = $cmd ? $cmd : 'search';
		$stype = GetParam('searchtype');
		$scase = GetParam('searchcase');
		$priceSQL = null;	
		$selected = null;	
		$_sel = null;		
		$cat = (GetReq('cat')==$this->_catAllFilter) ? null : GetReq('cat'); //<<< all keyword means no cat
		
		$input = GetReq('input'); //search param or pair: val or comma sep vals
		$reset_input = array();
		
        list($fltname, $fltvalue, $reset_input, $priceSQL, $input) = $this->readfilter($field);		
		//print_r($reset_input);
		
	    $sSQL = "SELECT DISTINCT ".$field.",count(id) from products WHERE "; 	
        //if ($incategory) {	
		
			$s = array();
		    $cats = $cat ? explode($this->sep(), $cat) : null;
			if (!empty($cats)) {
				foreach ($cats as $c=>$mycat)
					$s[] = 'cat'.$c ." ='" . $this->replace_spchars($mycat,1) . "'";		  	  
			}  
		//}	
		if ($priceSQL)		
			$s[] = $priceSQL;	
		
		$where = (!empty($s)) ? implode(" AND ", $s) : null;			

		$sSQL .= $where ? $where . ' AND ' : null;
		$sSQL .= " itmactive>0 and active>0";
		$sSQL .= " group by " . $field;
		//echo '<br>(' . $input . ')' . $sSQL;	  
	  
		$result = $db->Execute($sSQL,2); 
	  
		if (!empty($result)) {
			/*
			$contents = (($this->filterajax) && (!$this->mobile)) ? 
					_m('cmsrt.select_template use searchfilter-ajax') : 
					_m('cmsrt.select_template use searchfilter');
			$contents_selected = _m('cmsrt.select_template use searchfilter-selected');						
			*/
			$tokens = array(); 
			$r = array();				
			$_cat = $cat ? $cat : $this->_catAllFilter; //when no cat cat=all ('all' special key means no cat)!! (url // act as /)
			
			foreach ($result as $n=>$t) {
				
				if (trim($t[0])!='') {
					$selected = null; //reset
					
			        $f = $this->replace_spchars($field .':'. $t[0]); //<--- add field descr: before value
					if ($t[0] == $this->replace_spchars($fltvalue,1)) { 
						$selected = $f;
						$_sel = $f;
					}	
					//if ($field.':'.$t[0] == $this->replace_spchars($fltname.':'.$fltvalue,1)) $selected = $f;
										
					$ff = !empty($reset_input) ? implode(',', $reset_input) .",". $f : $f; //<---- reset input and set comma sep values (search input, manufacturer, price etc)
					$url = $this->httpurl . "/$command/$_cat/"; //_cat!!!
					//$theurl = $selected ? "remFilter('$selected','{$this->pageName}')" : $baseurl . _m("cmsrt.url use t=$command&cat=$_cat&input=$ff");
					$theurl = '/' . _m("cmsrt.url use t=$command&cat=$_cat&input=$ff");
										
					$tokens['id'] = $this->replace_spchars($t[0]); //$t[0];
					$tokens['title'] = $t[0];
					$tokens['url'] = $theurl;
					$tokens['selected'] = ($t[0] == $this->replace_spchars($fltvalue,1)) ? 'checked="checked"' : null; //$input = field:value, get the value (fltvalue)
					$tokens['field'] = $field; 
					
					//$_c = $selected ? $contents_selected : $contents;
					//$r[] = $this->combine_tokens($_c, $tokens);	
					$r[] = $tokens;	
					unset($tokens);			
                }				
			}
			//print_r($r);
			return $r;	
		}		
       
		return null;  
	}		

};			  
}
?>